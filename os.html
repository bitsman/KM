<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-06-05 周五 00:05 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>操作系统</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="比克曼" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="css/org-manual.css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">操作系统</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgcd4e287">1. brief</a>
<ul>
<li><a href="#orgff877ed">1.1. 进程</a></li>
<li><a href="#org7ae2208">1.2. 线程</a></li>
<li><a href="#orgade0289">1.3. 信号量</a></li>
</ul>
</li>
<li><a href="#org0e026f0">2. linux</a>
<ul>
<li><a href="#org14dd5c8">2.1. shell</a>
<ul>
<li><a href="#org309934a">2.1.1. grep</a></li>
<li><a href="#orgf63b530">2.1.2. find</a></li>
</ul>
</li>
<li><a href="#org5ce2878">2.2. ubuntu</a>
<ul>
<li><a href="#org35708eb">2.2.1. 基本配置</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org6bd1770">3. android</a>
<ul>
<li><a href="#org26b58dc">3.1. base</a>
<ul>
<li><a href="#org2b3201d">3.1.1. Bundle</a></li>
<li><a href="#orgd8cf99f">3.1.2. Intent</a></li>
<li><a href="#orgf062bb7">3.1.3. 系统时间</a></li>
</ul>
</li>
<li><a href="#org58ff17b">3.2. activity</a>
<ul>
<li><a href="#orgf759437">3.2.1. Fragment</a></li>
<li><a href="#orgaf97c77">3.2.2. button</a></li>
<li><a href="#orgd5748ea">3.2.3. 下拉菜单</a></li>
<li><a href="#org090d4c6">3.2.4. 复选框</a></li>
<li><a href="#org08e3867">3.2.5. 单选框</a></li>
<li><a href="#org08984fb">3.2.6. 对话框</a></li>
</ul>
</li>
<li><a href="#org7a42fa2">3.3. service</a>
<ul>
<li><a href="#org5bfbe93">3.3.1. Bound Service</a></li>
</ul>
</li>
<li><a href="#orge7259b9">3.4. broadcast</a></li>
<li><a href="#org346bdc0">3.5. 消息机制</a>
<ul>
<li><a href="#org0b38aa1">3.5.1. Handler</a></li>
<li><a href="#orgc5c2ebd">3.5.2. Looper</a></li>
<li><a href="#org6bb1c54">3.5.3. Message</a></li>
<li><a href="#org6da8b8a">3.5.4. SharedPreferences</a></li>
</ul>
</li>
<li><a href="#org27df74c">3.6. 通知栏操作</a></li>
<li><a href="#org9cefc89">3.7. 程序首选项</a></li>
<li><a href="#org6db5aed">3.8. menu</a></li>
<li><a href="#orgcff3553">3.9. gps</a>
<ul>
<li><a href="#org627a37d">3.9.1. 组件</a></li>
<li><a href="#org3b85e85">3.9.2. 操作</a>
<ul>
<li><a href="#org0e25d4d">3.9.2.1. LocationManager</a></li>
<li><a href="#orga5ab2e0">3.9.2.2. LocationListener</a></li>
<li><a href="#orgccbf7e0">3.9.2.3. Location</a></li>
<li><a href="#org8c646f1">3.9.2.4. GpsStatus.Listener</a></li>
<li><a href="#org7e8b97a">3.9.2.5. GpsStatus</a></li>
<li><a href="#org28741c7">3.9.2.6. GpsSatellite</a></li>
</ul>
</li>
<li><a href="#org3d49d8d">3.9.3. 位置模拟</a></li>
</ul>
</li>
<li><a href="#org45443d0">3.10. bt</a>
<ul>
<li><a href="#org6c5c1ef">3.10.1. 概念</a></li>
<li><a href="#org90e9629">3.10.2. 蓝牙权限</a></li>
<li><a href="#orga256f2e">3.10.3. 设置蓝牙</a></li>
<li><a href="#org264904f">3.10.4. 寻找设备</a></li>
<li><a href="#orgcb937c9">3.10.5. 轮询已配对的设备</a></li>
<li><a href="#orgecc16dd">3.10.6. 搜索设备</a></li>
<li><a href="#org4979c71">3.10.7. 使能可发现性</a></li>
<li><a href="#org9579bd0">3.10.8. 连接设备</a></li>
<li><a href="#org873d6fe">3.10.9. 服务端的连接</a></li>
<li><a href="#org3b45935">3.10.10. 客户端的连接</a></li>
<li><a href="#orgc6881b2">3.10.11. 管理连接</a></li>
<li><a href="#org7b60e1c">3.10.12. 使用Profiles</a></li>
<li><a href="#orgccbebe1">3.10.13. 制造商自定义AT指令</a></li>
<li><a href="#orgafba20e">3.10.14. 健康设备Profile</a></li>
</ul>
</li>
<li><a href="#org7aaea11">3.11. ble</a></li>
<li><a href="#org51b68b1">3.12. sensor</a>
<ul>
<li><a href="#org494af0e">3.12.1. 传感器类型</a></li>
<li><a href="#org2595b58">3.12.2. 使用方法</a></li>
</ul>
</li>
<li><a href="#orgce9db85">3.13. hal</a>
<ul>
<li><a href="#org2d55d64">3.13.1. 架构</a></li>
<li><a href="#org84909fe">3.13.2. driver</a>
<ul>
<li><a href="#org7d728e5">3.13.2.1. 驱动路径</a></li>
<li><a href="#org2752f6a">3.13.2.2. 驱动接口</a></li>
<li><a href="#orgea627ab">3.13.2.3. 驱动实现</a></li>
<li><a href="#org21329f1">3.13.2.4. 驱动注册</a></li>
<li><a href="#org9aa346c">3.13.2.5. 驱动构建</a></li>
<li><a href="#org1b6e662">3.13.2.6. 驱动测试</a></li>
</ul>
</li>
<li><a href="#org8d265d4">3.13.3. hal</a>
<ul>
<li><a href="#orge96b7c6">3.13.3.1. hal路径</a></li>
<li><a href="#orgedd7cc8">3.13.3.2. hal接口</a></li>
<li><a href="#orga5c3e95">3.13.3.3. hal实现</a></li>
<li><a href="#orgdde0acd">3.13.3.4. hal构建</a></li>
</ul>
</li>
<li><a href="#orgb3917e9">3.13.4. jni</a></li>
<li><a href="#org957db4b">3.13.5. framework</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org7d6b302">4. rtos</a>
<ul>
<li><a href="#orgf0807c4">4.1. FreeRTOS</a>
<ul>
<li><a href="#orga611acd">4.1.1. 术语</a></li>
<li><a href="#orgf783fec">4.1.2. 源码解读</a>
<ul>
<li><a href="#orge62864f">4.1.2.1. 文件</a></li>
<li><a href="#org7a8448c">4.1.2.2. 功能函数</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="list-of-tables">
<h2>List of Tables</h2>
<div id="text-list-of-tables">
<ul>
<li><a href="#org5266b66"><span class="table-number">Table 1:</span> android menu bar xml属性说明</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgcd4e287" class="outline-2">
<h2 id="orgcd4e287"><span class="section-number-2">1</span> brief</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgff877ed" class="outline-3">
<h3 id="orgff877ed"><span class="section-number-3">1.1</span> 进程</h3>
<div class="outline-text-3" id="text-1-1">
<p>
一个进程代表一个任务，多进程也就是多任务，一个进程包含运行所需的资源，包含
运行代码，内存空间，栈空间，外设资源等。在Windows中一个应用程序就是一个进程。
</p>
</div>
</div>
<div id="outline-container-org7ae2208" class="outline-3">
<h3 id="org7ae2208"><span class="section-number-3">1.2</span> 线程</h3>
<div class="outline-text-3" id="text-1-2">
<p>
在一定程度上进程的原理和线程一样。每个进程都有一个PCB块记录进程的各种资源信
息，线程一般也有。线程是进程的功能子集，一个进程可以包含多个线程，多个线程
协作完成进程的任务，一般线程所需资源有代码和栈空间，其中栈空间用于记录线程
切换时自己的上下文，所以比起进程概念比较"轻"，CPU在上下文切换时更快捷方便.<br />
一般的嵌入式操作系统实现的是单进程下多线程，用一个上下文调度器进行线程切换。
如果要实现多进程，估计需要多个调度器，多个调度器再协作，或者在一个调度器中
控制多个进程的资源和代码以及线程功能（个人猜想）。
</p>
</div>
</div>
<div id="outline-container-orgade0289" class="outline-3">
<h3 id="orgade0289"><span class="section-number-3">1.3</span> 信号量</h3>
<div class="outline-text-3" id="text-1-3">
<p>
信号量用于记录临界资源的个数，当多个线程试图访问这些资源时，每访问一个资源
信号量减1，也就是传说中的P操作，每访问完一个资源，将释放信号量加1，也就是传
说中的V操作，当信号量减为1时，这个资源变成临界区资源，如果信号量减为0后，新
申请资源的线程将被挂起。<br />
信号量实现的一种简单方式，就是设置1个整数变量和指向资源的指针的结构体，在线
程访问这个变量时，关闭所有的中断和异常，然后对变量进行加1或者减1，实现信号
量的访问。  
</p>
</div>
</div>
</div>
<div id="outline-container-org0e026f0" class="outline-2">
<h2 id="org0e026f0"><span class="section-number-2">2</span> linux</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org14dd5c8" class="outline-3">
<h3 id="org14dd5c8"><span class="section-number-3">2.1</span> shell</h3>
<div class="outline-text-3" id="text-2-1">
</div>
<div id="outline-container-org309934a" class="outline-4">
<h4 id="org309934a"><span class="section-number-4">2.1.1</span> grep</h4>
<div class="outline-text-4" id="text-2-1-1">
<ul class="org-ul">
<li>用法：grep [-acinv]  [&#x2013;color=auto] '搜索关键词' filename
<ol class="org-ol">
<li>-a，将 binary 文件以 text 文件的方式搜寻数据;</li>
<li>-c，计算找到 '搜寻字符串' 的次数;</li>
<li>-i，忽略大小写的不同，所以大小写视为相同;</li>
<li>-n，顺便输出行号;</li>
<li>-v，反向选择，亦即显示出没有 '搜寻字符串' 内容的那一行;</li>
<li>&#x2013;color=auto，可以将找到的关键词部分加上颜色的显示喔！</li>
</ol></li>
<li>用例：
<ol class="org-ol">
<li><p>
在当前目录下找到所有文件中包含关键字Scd的行
</p>
<div class="org-src-container">
<pre class="src src-shell">cat * | grep -n Scd
</pre>
</div></li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-orgf63b530" class="outline-4">
<h4 id="orgf63b530"><span class="section-number-4">2.1.2</span> find</h4>
<div class="outline-text-4" id="text-2-1-2">
<ul class="org-ul">
<li>用法：过于复杂；</li>
<li>用例：
<ol class="org-ol">
<li><p>
在当前目录下找到所有（包括子目录）文件名后缀是".c", ".h"的文件名路径并
输出到文件cscope.files
</p>
<div class="org-src-container">
<pre class="src src-shell">find . -name <span style="color: #ffa07a;">"*.[ch]"</span> &gt;cscope.files
</pre>
</div></li>
</ol></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org5ce2878" class="outline-3">
<h3 id="org5ce2878"><span class="section-number-3">2.2</span> ubuntu</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-org35708eb" class="outline-4">
<h4 id="org35708eb"><span class="section-number-4">2.2.1</span> 基本配置</h4>
<div class="outline-text-4" id="text-2-2-1">
<ul class="org-ul">
<li>键位修改：修改理论见<a href="https://github.com/Chunlin-Li/Chunlin-Li.github.io/blob/master/blogs/linux/ubuntu-xkb-keyboard-remap.md">网址</a>， 看完后可知<a href="file:///c:/usr/share/X11/xkb/symbols/">目录</a>下有ctrl配置文件，里面就有直接调换alt和ctrl的配置；</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org6bd1770" class="outline-2">
<h2 id="org6bd1770"><span class="section-number-2">3</span> android</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org26b58dc" class="outline-3">
<h3 id="org26b58dc"><span class="section-number-3">3.1</span> base</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li><p>
上下文context
</p>
<ul class="org-ul">
<li>getApplicationContext():生命周期是整个应用，应用摧毁，它才摧毁。</li>
<li>this:代表当前,在Activity当中就是代表当前的Activity，换句话说就是 
Activity.this在Activity当中可以缩写为this.</li>
<li>getApplication():andorid 开发中共享全局数据;</li>
</ul>
<p>
我们在平时的开发中，有时候可能会需要一些全局数据，来让应用中得所有
Activity和View都能访问到，大家在遇到这种情况时，可能首先会想到自己定义一
个类，然后创建很多静态成员，不过andorid已经为我们提供了这种情况的解决方案：
在Android中，有一个名为Application的类，我们可以在Activity中使用
getApplication()，方法来获得，它是代表我们的应用程序的类，使用它可以获得
当前应用的主题，资源文件中的内容等，这个类更灵活的一个特性就是可以被我们
继承，来添加我们自己的全局属性。  
</p></li>
<li><p>
判断当前Activity
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">ActivityManager</span> <span style="color: #ffd700;">am</span> = (<span style="color: #ffff00; font-size: 105%;">ActivityManager</span>) getSystemService(ACTIVITY_SERVICE);
<span style="color: #ffff00; font-size: 105%;">ComponentName</span> <span style="color: #ffd700;">cn</span> = am.getRunningTasks(1).get(0).topActivity;
Log.d(TAG, <span style="color: #ffa07a;">"pkg:"</span>+cn.getPackageName());<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#26174;&#31034;&#24403;&#21069;activity&#25152;&#22312;&#36335;&#24452;</span>
Log.d(TAG, <span style="color: #ffa07a;">"cls:"</span>+cn.getClassName());<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#36335;&#24452;+&#31867;&#21517;</span>
Log.d(TAG, MyActivity.<span style="color: #ffb6c1; font-size: 105%;">class</span>.getName()); <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#36335;&#24452;+&#31867;&#21517;</span>
Log.d(TAG, MyActivity.<span style="color: #ffb6c1; font-size: 105%;">class</span>.getSimpleName()); <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#31867;&#21517;</span>
</pre>
</div></li>
</ul>
</div>
<div id="outline-container-org2b3201d" class="outline-4">
<h4 id="org2b3201d"><span class="section-number-4">3.1.1</span> Bundle</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
android中的Bundle一般用于携带数据，类似于Map，用于存放key-value键值对，其提
供了各种putXx()和getXx()方法，putXx()用于往Bundle对象中放入数据，getXx()用
于从Bundle对象中获取数据。比如Bundle常用与组件之间进行数据传输，我们可以将
Bundle设置好数据后，利用Intent的putExtras()方法将Bundle捆绑到Intent中，然后
再传递给别的组件； 
</p>
</div>
</div>
<div id="outline-container-orgd8cf99f" class="outline-4">
<h4 id="orgd8cf99f"><span class="section-number-4">3.1.2</span> Intent</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
Intent可以用于启动别的组件比如Activity和Service等，并在Intent中绑定一定的数
据，传递给目标组件。 
</p>
</div>
</div>
<div id="outline-container-orgf062bb7" class="outline-4">
<h4 id="orgf062bb7"><span class="section-number-4">3.1.3</span> 系统时间</h4>
<div class="outline-text-4" id="text-3-1-3">
<ul class="org-ul">
<li><p>
获取年月日
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">import</span>    <span style="color: #7fffd4;">java</span>.<span style="color: #7fffd4;">text</span>.<span style="color: #ffff00; font-size: 105%;">SimpleDateFormat</span>;     
<span style="color: #ffff00; font-size: 105%;">SimpleDateFormat</span> <span style="color: #ffd700;">formatter</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">SimpleDateFormat</span>(<span style="color: #ffa07a;">"yyyy&#24180;MM&#26376;dd&#26085;HH:mm:ss"</span>);     
<span style="color: #ffff00; font-size: 105%;">Date</span> <span style="color: #ffd700;">curDate</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">Date</span>(System.currentTimeMillis());<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#33719;&#21462;&#24403;&#21069;&#26102;&#38388;     </span>
<span style="color: #ffff00; font-size: 105%;">String</span> <span style="color: #ffd700;">str</span> = formatter.format(curDate);     
</pre>
</div></li>
<li><p>
获取当前的年月时分
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">SimpleDateFormat</span> <span style="color: #ffd700;">sDateFormat</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">SimpleDateFormat</span>(<span style="color: #ffa07a;">"yyyy-MM-dd hh:mm:ss"</span>);     
<span style="color: #ffff00; font-size: 105%;">String</span> <span style="color: #ffd700;">date</span> = sDateFormat.format(<span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #7fffd4;">java</span>.<span style="color: #7fffd4;">util</span>.<span style="color: #ffff00; font-size: 105%;">Date</span>());  
</pre>
</div></li>
<li><p>
获取当前的年月
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">SimpleDateFormat</span> <span style="color: #ffd700;">sdf</span>=<span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">SimpleDateFormat</span>(<span style="color: #ffa07a;">"yyyy-MM"</span>);  
<span style="color: #ffff00; font-size: 105%;">String</span> <span style="color: #ffd700;">date</span>=sdf.format(<span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #7fffd4;">java</span>.<span style="color: #7fffd4;">util</span>.<span style="color: #ffff00; font-size: 105%;">Date</span>());  
</pre>
</div></li>
<li><p>
获取指定时区的时间
</p>
<div class="org-src-container">
<pre class="src src-java">df = DateFormat.getDateTimeInstance(<span style="color: #7fffd4;">DateFormat</span>.FULL,<span style="color: #7fffd4;">DateFormat</span>.FULL,<span style="color: #7fffd4;">Locale</span>.CHINA);
System.out.println(df.format(<span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">Date</span>()));
</pre>
</div></li>
<li><p>
确定系统时间制式
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">ContentResolver</span> <span style="color: #ffd700;">cv</span> = <span style="color: #ffb6c1; font-size: 105%;">this</span>.getContentResolver();
<span style="color: #ffff00; font-size: 105%;">String</span> <span style="color: #ffd700;">strTimeFormat</span> = <span style="color: #7fffd4;">android</span>.<span style="color: #7fffd4;">provider</span>.<span style="color: #7fffd4;">Settings</span>.System.getString(cv,
                               <span style="color: #7fffd4;">android</span>.<span style="color: #7fffd4;">provider</span>.<span style="color: #7fffd4;">Settings</span>.<span style="color: #7fffd4;">System</span>.TIME_12_24);
<span style="color: #ffb6c1; font-size: 105%;">if</span>(strTimeFormat.equals(<span style="color: #ffa07a;">"24"</span>)){
   Log.i(<span style="color: #ffa07a;">"activity"</span>,<span style="color: #ffa07a;">"24"</span>);
}
</pre>
</div></li>
<li><p>
取得系统时间日期
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">Calendar</span> <span style="color: #ffd700;">c</span> = Calendar.getInstance();
year = c.get(<span style="color: #7fffd4;">Calendar</span>.YEAR) <span style="color: #90ee90; font-style: italic;">/*</span><span style="color: #90ee90; font-style: italic;">&#21462;&#24471;&#31995;&#32479;&#26085;&#26399;*/</span>
month = c.grt(<span style="color: #7fffd4;">Calendar</span>.MONTH)
day = c.get(<span style="color: #7fffd4;">Calendar</span>.DAY_OF_MONTH)
hour = c.get(<span style="color: #7fffd4;">Calendar</span>.HOUR_OF_DAY);<span style="color: #90ee90; font-style: italic;">/*</span><span style="color: #90ee90; font-style: italic;">&#21462;&#24471;&#31995;&#32479;&#26102;&#38388;*/</span>
minute = c.get(<span style="color: #7fffd4;">Calendar</span>.MINUTE)
</pre>
</div></li>
<li><p>
利用TIMER获取
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">Time</span> <span style="color: #ffd700;">t</span>=<span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">Time</span>(); <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">or Time t=new Time("GMT+8"); &#21152;&#19978;Time Zone&#36164;&#26009;&#12290;</span>
t.setToNow(); <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">&#21462;&#24471;&#31995;&#32479;&#26102;&#38388;&#12290;</span>
<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">year</span> = t.year;
<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">month</span> = t.month;
<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">date</span> = t.monthDay;
<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">hour</span> = t.hour; <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">0-23</span>
<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">minute</span> = t.minute;
<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">second</span> = t.second;
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org58ff17b" class="outline-3">
<h3 id="org58ff17b"><span class="section-number-3">3.2</span> activity</h3>
<div class="outline-text-3" id="text-3-2">
</div>
<div id="outline-container-orgf759437" class="outline-4">
<h4 id="orgf759437"><span class="section-number-4">3.2.1</span> Fragment</h4>
<div class="outline-text-4" id="text-3-2-1">
<p>
Android运行在各种各样的设备中，有小屏幕的手机，超大屏的平板甚至电视。针对屏
幕尺寸的差距，很多情况下，都是先针对手机开发一套App，然后拷贝一份，修改布局
以适应平板神马超级大屏的。难道无法做到一个App可以同时适应手机和平板么，当然
了，必须有啊。Fragment的出现就是为了解决这样的问题。你可以把Fragment当成
Activity的一个界面的一个组成部分，甚至Activity的界面可以完全有不同的
Fragment组成，更帅气的是Fragment拥有自己的生命周期和接收、处理用户的事件，
这样就不必在Activity写一堆控件的事件处理的代码了。更为重要的是，你可以动态
的添加、替换和移除某个Fragment; Fragment必须是依存与Activity而存在的，因此
Activity的生命周期会直接影响到Fragment的生命周期, Fragment的生命周期见图
\ref{img-fragment-cycle};  
</p>

<div class="figure">
<p><img src="./img/img-fragment-cycle.png" alt="img-fragment-cycle.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgaf97c77" class="outline-4">
<h4 id="orgaf97c77"><span class="section-number-4">3.2.2</span> button</h4>
<div class="outline-text-4" id="text-3-2-2">
<ul class="org-ul">
<li>button透明：xml中使用android:background="@android:color/transparent"</li>
</ul>
</div>
</div>
<div id="outline-container-orgd5748ea" class="outline-4">
<h4 id="orgd5748ea"><span class="section-number-4">3.2.3</span> 下拉菜单</h4>
<div class="outline-text-4" id="text-3-2-3">
<p>
实现某个菜单框里面有多个选项，点击后可以展示各个字符菜单项，点击后可以产生
点击事件，可以将某个int值和字符菜单项对应；实现方法： 
</p>
<ol class="org-ol">
<li><p>
定义两个array资源：
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#23383;&#31526;&#33756;&#21333;&#39033;</span>
&lt;string-array name=<span style="color: #ffa07a;">"gps_type_options"</span>&gt;
    &lt;<span style="color: #ffff00; font-size: 105%;">item</span>&gt;GPS&lt;/item&gt;
    &lt;<span style="color: #ffff00; font-size: 105%;">item</span>&gt;GPS and GLONASS&lt;/item&gt;
    &lt;<span style="color: #ffff00; font-size: 105%;">item</span>&gt;GPS and BEIDOU&lt;/item&gt;
&lt;/string-array&gt;
</pre>
</div>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">int&#23545;&#24212;&#20540;</span>
&lt;integer-array name=<span style="color: #ffa07a;">"gps_type_values"</span>&gt;
    &lt;<span style="color: #ffff00; font-size: 105%;">item</span>&gt;0&lt;/item&gt;
    &lt;<span style="color: #ffff00; font-size: 105%;">item</span>&gt;1&lt;/item&gt;
    &lt;<span style="color: #ffff00; font-size: 105%;">item</span>&gt;2&lt;/item&gt;
&lt;/integer-array&gt;
</pre>
</div></li>
<li><p>
xml中定义器件
</p>
<div class="org-src-container">
<pre class="src src-java">&lt;Spinner
    android:id=<span style="color: #ffa07a;">"@+id/spinnerType"</span>
    android:layout_width=<span style="color: #ffa07a;">"0dip"</span>
    android:layout_height=<span style="color: #ffa07a;">"wrap_content"</span>
    android:layout_marginRight=<span style="color: #ffa07a;">"8dip"</span>
    android:layout_weight=<span style="color: #ffa07a;">"1"</span> /&gt;
</pre>
</div></li>
<li><p>
在源文件中获取这2个资源：
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">String</span>[] <span style="color: #ffd700;">gpsTypeOptions</span> = getResources().getStringArray(R.array.gps_type_options);
    <span style="color: #ffff00; font-size: 105%;">int</span>[] <span style="color: #ffd700;">gpsTypeValues</span> = getResources().getIntArray(R.array.gps_type_values);
</pre>
</div></li>
<li><p>
绑定两者成adapter:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffff00; font-size: 105%;">IntArrayAdapter</span> <span style="color: #ffd700;">mGPSTypeAdapter</span>;
    mGPSTypeAdapter = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">IntArrayAdapter</span>(<span style="color: #ffb6c1; font-size: 105%;">this</span>, gpsTypeOptions, gpsTypeValues);
</pre>
</div></li>
<li><p>
将adapter装配到view上：
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffff00; font-size: 105%;">Spinner</span> <span style="color: #ffd700;">mSpinnerType</span>;
mSpinnerType = (<span style="color: #ffff00; font-size: 105%;">Spinner</span>) findViewById(R.id.spinnerType);
mSpinnerType.setAdapter(mGPSTypeAdapter);
    mSpinnerType.setOnItemSelectedListener(onItemSelectedListener);
</pre>
</div></li>
<li><p>
实现点击事件：
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffff00; font-size: 105%;">OnItemSelectedListener</span> <span style="color: #ffd700;">onItemSelectedListener</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">OnItemSelectedListener</span>() {
        <span style="color: #7fffd4;">@Override</span>
        <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> onItemSelected(<span style="color: #ffff00; font-size: 105%;">AdapterView</span>&lt;?&gt; <span style="color: #ffd700;">adapter</span>,<span style="color: #ffff00; font-size: 105%;">View</span> <span style="color: #ffd700;">view</span>,<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">position</span>,<span style="color: #ffff00; font-size: 105%;">long</span> <span style="color: #ffd700;">id</span>) {
            <span style="color: #ffb6c1; font-size: 105%;">if</span> (adapter == mSpinnerType) {
                mGPSTypePostion = position;
            }
        }
        <span style="color: #7fffd4;">@Override</span>
        <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">onNothingSelected</span>(<span style="color: #ffff00; font-size: 105%;">AdapterView</span>&lt;?&gt; <span style="color: #ffd700;">arg0</span>) {}
};
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-org090d4c6" class="outline-4">
<h4 id="org090d4c6"><span class="section-number-4">3.2.4</span> 复选框</h4>
<div class="outline-text-4" id="text-3-2-4">
<p>
正方形的复选框选项
</p>
<ol class="org-ol">
<li><p>
xml中定义器件
</p>
<div class="org-src-container">
<pre class="src src-java">&lt;CheckBox 
  android:id=<span style="color: #ffa07a;">"@+id/cb"</span>
  android:layout_width=<span style="color: #ffa07a;">"wrap_content"</span> 
  android:layout_height=<span style="color: #ffa07a;">"wrap_content"</span>
  android:checked=<span style="color: #ffa07a;">"false"</span>
  android:text=<span style="color: #ffa07a;">"&#24050;&#23130;"</span> /&gt;
</pre>
</div></li>
<li><p>
源码中获取器件
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffff00; font-size: 105%;">CheckBox</span> <span style="color: #ffd700;">mCheckKeep</span>;
mCheckKeep = (<span style="color: #ffff00; font-size: 105%;">CheckBox</span>) findViewById(R.id.checkKeep);

</pre>
</div></li>
<li><p>
监听事件
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#32465;&#23450;&#30417;&#21548;&#22120;</span>
cb.setOnCheckedChangeListener(<span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">OnCheckedChangeListener</span>() {
    <span style="color: #7fffd4;">@Override</span>
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">onCheckedChanged</span>(<span style="color: #ffff00; font-size: 105%;">CompoundButton</span> <span style="color: #ffd700;">arg0</span>, <span style="color: #ffff00; font-size: 105%;">boolean</span> <span style="color: #ffd700;">arg1</span>) {
    Toast.makeText(MyActivity.<span style="color: #ffb6c1; font-size: 105%;">this</span>, 
     arg1?<span style="color: #ffa07a;">"&#36873;&#20013;&#20102;"</span>:<span style="color: #ffa07a;">"&#21462;&#28040;&#20102;&#36873;&#20013;"</span>    , <span style="color: #7fffd4;">Toast</span>.LENGTH_LONG).show();
   }
 });
</pre>
</div></li>
<li><p>
也可以查询获得结果
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">if</span>(!cb.isChecked()){
}
</pre>
</div></li>
</ol>
</div>
</div>
<div id="outline-container-org08e3867" class="outline-4">
<h4 id="org08e3867"><span class="section-number-4">3.2.5</span> 单选框</h4>
<div class="outline-text-4" id="text-3-2-5">
<p>
单选框可以将多个选项汇聚到一个组中，这个组中的每个单选项是互斥的，选一个其 
他的就不能选。
</p>
<ul class="org-ul">
<li><p>
xml文件
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">RadioGroup</span>
    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">id</span>=<span style="color: #ffa07a;">"@+id/shoes_sel"</span>
    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"wrap_content"</span>
    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"wrap_content"</span>
    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_x</span>=<span style="color: #ffa07a;">"3px"</span>
    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_y</span>=<span style="color: #ffa07a;">"54px"</span> &gt;
    &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">RadioButton</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">id</span>=<span style="color: #ffa07a;">"@+id/RadioButton1"</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"wrap_content"</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"wrap_content"</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">text</span>=<span style="color: #ffa07a;">"&#24037;&#21378;&#27979;&#35797;"</span>/&gt;
    &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">RadioButton</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">id</span>=<span style="color: #ffa07a;">"@+id/RadioButton2"</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"wrap_content"</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"wrap_content"</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">text</span>=<span style="color: #ffa07a;">"&#29983;&#20135;&#27979;&#35797;"</span>/&gt;
&lt;/<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">RadioGroup</span>&gt;
</pre>
</div></li>
<li><p>
源码中获取：
</p>
<div class="org-src-container">
<pre class="src src-java">mRadioGroup = (<span style="color: #ffff00; font-size: 105%;">RadioGroup</span>) findViewById(R.id.shoes_sel);  
mRadio1 = (<span style="color: #ffff00; font-size: 105%;">RadioButton</span>) findViewById(<span style="color: #7fffd4;">R</span>.<span style="color: #7fffd4;">id</span>.RadioButton1);  
mRadio2 = (<span style="color: #ffff00; font-size: 105%;">RadioButton</span>) findViewById(<span style="color: #7fffd4;">R</span>.<span style="color: #7fffd4;">id</span>.RadioButton2); 
</pre>
</div></li>
<li><p>
监听器：
</p>
<div class="org-src-container">
<pre class="src src-java">mRadioGroup.setOnCheckedChangeListener(<span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #7fffd4;">RadioGroup</span>.<span style="color: #ffff00; font-size: 105%;">OnCheckedChangeListener</span>() {  
  <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">onCheckedChanged</span>(<span style="color: #ffff00; font-size: 105%;">RadioGroup</span> <span style="color: #ffd700;">group</span>, <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">checkedId</span>){
      <span style="color: #ffb6c1; font-size: 105%;">if</span> (checkedId == mRadio2.getId()){
      <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">todo</span>
      }  
      <span style="color: #ffb6c1; font-size: 105%;">else</span>{  
      <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">todo</span>
      }  
  }  
});  
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org08984fb" class="outline-4">
<h4 id="org08984fb"><span class="section-number-4">3.2.6</span> 对话框</h4>
<div class="outline-text-4" id="text-3-2-6">
<p>
比如可以在某个按键后触发一个对话框出来要求用户输入数据，然后点确定等操作。
Java代码如下
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">final</span> <span style="color: #ffff00; font-size: 105%;">AlertDialog</span> <span style="color: #ffd700;">dialog</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #7fffd4;">AlertDialog</span>.<span style="color: #ffff00; font-size: 105%;">Builder</span>(<span style="color: #ffb6c1; font-size: 105%;">this</span>).create();<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#23545;&#35805;&#26694;&#23545;&#35937;</span>
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21521;&#31995;&#32479;&#35831;&#27714;&#19968;&#20010;inflater</span>
<span style="color: #ffff00; font-size: 105%;">LayoutInflater</span> <span style="color: #ffd700;">inflater</span> = (<span style="color: #ffff00; font-size: 105%;">LayoutInflater</span>) <span style="color: #ffb6c1; font-size: 105%;">this</span>.getSystemService(MainActivity.<span style="color: #ffb6c1; font-size: 105%;">this</span>.LAYOUT_INFLATER_SERVICE);
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#35813;&#23545;&#35805;&#26694;&#30340;&#24067;&#23616;layout</span>
<span style="color: #ffff00; font-size: 105%;">LinearLayout</span> <span style="color: #ffd700;">layout</span> = (<span style="color: #ffff00; font-size: 105%;">LinearLayout</span>)inflater.inflate(R.layout.dialog, <span style="color: #7fffd4;">null</span>);
dialog.setView(layout);
dialog.getWindow().setWindowAnimations(<span style="color: #7fffd4;">R</span>.<span style="color: #7fffd4;">style</span>.DialogAnimationStyle);
dialog.show();

<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#33719;&#21462;&#23545;&#35805;&#26694;&#20013;&#30340;&#25511;&#20214;&#20803;&#32032;&#65292;&#21644;&#26222;&#36890;&#30340;&#30028;&#38754;&#25805;&#20316;&#19968;&#26679;</span>
<span style="color: #ffb6c1; font-size: 105%;">final</span> <span style="color: #ffff00; font-size: 105%;">EditText</span> <span style="color: #ffd700;">et</span> = (<span style="color: #ffff00; font-size: 105%;">EditText</span>) dialog.getWindow().findViewById(R.id.et_value);
<span style="color: #ffff00; font-size: 105%;">Button</span> <span style="color: #ffd700;">close_bt</span> = (<span style="color: #ffff00; font-size: 105%;">Button</span>)dialog.getWindow().findViewById(R.id.close_bt);
close_bt.setOnClickListener(<span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">OnClickListener</span>() {
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">onClick</span>(<span style="color: #ffff00; font-size: 105%;">View</span> <span style="color: #ffd700;">v</span>) {
    dialog.dismiss();
    }
});
<span style="color: #ffff00; font-size: 105%;">Button</span> <span style="color: #ffd700;">sure_bt</span> = (<span style="color: #ffff00; font-size: 105%;">Button</span>) dialog.getWindow().findViewById(R.id.sure_bt);
sure_bt.setOnClickListener(<span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">OnClickListener</span>() {
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">onClick</span>(<span style="color: #ffff00; font-size: 105%;">View</span> <span style="color: #ffd700;">v</span>) {
    <span style="color: #ffff00; font-size: 105%;">String</span> <span style="color: #ffd700;">string</span> =et.getText().toString();
    <span style="color: #ffb6c1; font-size: 105%;">if</span>(string == <span style="color: #7fffd4;">null</span>)
        dialog.dismiss();
    Calibrate = currentPressure - Float.parseFloat(string);
    dialog.dismiss();
    }
});
</pre>
</div>
<p>
相关的界面布局xml文件
</p>
<div class="org-src-container">
<pre class="src src-xml"><span style="color: #ffa07a;">&lt;?</span><span style="color: #ffb6c1; font-size: 105%;">xml</span><span style="color: #ffa07a;"> </span><span style="color: #ffa07a;">version="1.0" encoding="utf-8"</span><span style="color: #ffa07a;">?&gt;</span>
&lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">LinearLayout</span> <span style="color: #87cefa; text-decoration: underline;">xmlns</span>:<span style="color: #ffd700;">android</span>=<span style="color: #ffa07a;">"http://schemas.android.com/apk/res/android"</span>
    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"300dip"</span>
    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"wrap_content"</span>
    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">background</span>=<span style="color: #ffa07a;">"#ffffff"</span>
    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">orientation</span>=<span style="color: #ffa07a;">"vertical"</span> &gt;
    &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">TextView</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">id</span>=<span style="color: #ffa07a;">"@+id/textView1"</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"wrap_content"</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"wrap_content"</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_marginTop</span>=<span style="color: #ffa07a;">"10dip"</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_marginLeft</span>=<span style="color: #ffa07a;">"10dip"</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">textSize</span>=<span style="color: #ffa07a;">"20dip"</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">text</span>=<span style="color: #ffa07a;">"&#26657;&#27491;"</span> /&gt;
    &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">View</span> 
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"match_parent"</span>
                  <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"1dip"</span>
                  <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_marginTop</span>=<span style="color: #ffa07a;">"10dip"</span>
                  <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">background</span>=<span style="color: #ffa07a;">"#009acd"</span> /&gt;
    &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">LinearLayout</span> 
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"match_parent"</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"wrap_content"</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_marginTop</span>=<span style="color: #ffa07a;">"20dip"</span> &gt;
        &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">TextView</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"100dip"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"wrap_content"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">textSize</span>=<span style="color: #ffa07a;">"15dip"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">gravity</span>=<span style="color: #ffa07a;">"center_horizontal"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">text</span>=<span style="color: #ffa07a;">"&#24403;&#21069;&#20540;"</span> /&gt;
        &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">TextView</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">id</span>=<span style="color: #ffa07a;">"@+id/textView3"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"wrap_content"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"wrap_content"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">text</span>=<span style="color: #ffa07a;">"TextView"</span> /&gt;
    &lt;/<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">LinearLayout</span>&gt;
        &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">LinearLayout</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"match_parent"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"wrap_content"</span> 
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_marginTop</span>=<span style="color: #ffa07a;">"20dip"</span>&gt;
            &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">TextView</span>
                <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">id</span>=<span style="color: #ffa07a;">"@+id/textView2"</span>
                <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"100dip"</span>
                <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"wrap_content"</span>
                <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">gravity</span>=<span style="color: #ffa07a;">"center_horizontal"</span>
                <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">textSize</span>=<span style="color: #ffa07a;">"15dip"</span>
                <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">text</span>=<span style="color: #ffa07a;">"&#26657;&#27491;&#20540;"</span> /&gt;
            &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">EditText</span>
                <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">id</span>=<span style="color: #ffa07a;">"@+id/et_value"</span>
                <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"200dip"</span>
                <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"wrap_content"</span>
                <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">background</span>=<span style="color: #ffa07a;">"#fff0f5"</span>
                <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">numeric</span>=<span style="color: #ffa07a;">"integer"</span>
                <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">text</span>=<span style="color: #ffa07a;">""</span> /&gt;
        &lt;/<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">LinearLayout</span>&gt;
                &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">View</span> 
                    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"wrap_content"</span>
                    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"1dip"</span>
                    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_marginTop</span>=<span style="color: #ffa07a;">"20dip"</span>
                    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">background</span>=<span style="color: #ffa07a;">"@color/darkgray"</span>&gt;
    &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">LinearLayout</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"match_parent"</span>
        <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"45dp"</span> &gt;
        &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">Button</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">id</span>=<span style="color: #ffa07a;">"@+id/close_bt"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"wrap_content"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"wrap_content"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">background</span>=<span style="color: #ffa07a;">"@drawable/bt_style"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_weight</span>=<span style="color: #ffa07a;">"1"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">text</span>=<span style="color: #ffa07a;">"&#21462;&#28040;"</span> /&gt;
                &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">View</span> 
                    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"1dip"</span>
                    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"wrap_content"</span>
                    <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">background</span>=<span style="color: #ffa07a;">"@color/darkgray"</span>/&gt;
        &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">Button</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">id</span>=<span style="color: #ffa07a;">"@+id/sure_bt"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_width</span>=<span style="color: #ffa07a;">"wrap_content"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_height</span>=<span style="color: #ffa07a;">"wrap_content"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">background</span>=<span style="color: #ffa07a;">"@drawable/bt_style"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">layout_weight</span>=<span style="color: #ffa07a;">"1"</span>
            <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">text</span>=<span style="color: #ffa07a;">"&#30830;&#23450;"</span> /&gt;
    &lt;/<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">LinearLayout</span>&gt;
&lt;/<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">LinearLayout</span>&gt;
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7a42fa2" class="outline-3">
<h3 id="org7a42fa2"><span class="section-number-3">3.3</span> service</h3>
<div class="outline-text-3" id="text-3-3">
<ul class="org-ul">
<li><p>
在service中启动activity：
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">Intent</span> <span style="color: #ffd700;">intent</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">Intent</span>(getBaseContext(), MtkPlatformTest.<span style="color: #ffb6c1; font-size: 105%;">class</span>);
intent.addFlags(<span style="color: #7fffd4;">Intent</span>.FLAG_ACTIVITY_NEW_TASK);<span style="color: #ffff00; font-size: 105%;">&#24517;&#39035;&#21152;&#36825;&#21477;</span>
<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">startActivity</span>(<span style="color: #ffff00; font-size: 105%;">intent</span>);
</pre>
</div></li>
</ul>
</div>
<div id="outline-container-org5bfbe93" class="outline-4">
<h4 id="org5bfbe93"><span class="section-number-4">3.3.1</span> Bound Service</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
要做绑定服务操作，client需要调用bindService() , 调用后，系统将调用server的onBind()方法，这个方法将返回一个IBinder，这个
IBinder正是反给client，client使用此IBinder来调用server实现的各种服务接口，client要取得这个IBinder，需要实现一个接口
ServiceConnection 作为bindService的参数，此ServiceConnection中的方法onServiceConnected将被系统回调(在onBind执行完后)，而
onBind返回的IBinder正是作为参数传给onServiceConnected，这样client就可以在onServiceConnected里面获得该IBinder；
</p>
</div>
</div>
</div>
<div id="outline-container-orge7259b9" class="outline-3">
<h3 id="orge7259b9"><span class="section-number-3">3.4</span> broadcast</h3>
<div class="outline-text-3" id="text-3-4">
<p>
广播机制可以事务处理异步化，可以将事务的处理放在别的地方，然后在另一个地方
发送一个Intent，系统会根据此Intent来找到相应的广播处理方法来处理，步骤如下。 
</p>
<ul class="org-ul">
<li><p>
设定IntentFilter，可以在manifest文件中设置，也可以在源码中动态设置，实例
如下; 
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">IntentFilter</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">makeIntentFilter</span>() {
    <span style="color: #ffb6c1; font-size: 105%;">final</span> <span style="color: #ffff00; font-size: 105%;">IntentFilter</span> <span style="color: #ffd700;">intentFilter</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">IntentFilter</span>();
    intentFilter.addAction(ACTION_GATT_CONNECTED);
    intentFilter.addAction(ACTION_GATT_DISCONNECTED);
    intentFilter.addAction(ACTION_GATT_SERVICES_DISCOVERED);
    intentFilter.addAction(ACTION_DATA_AVAILABLE);
    <span style="color: #ffb6c1; font-size: 105%;">return</span> intentFilter;
}
</pre>
</div></li>
<li><p>
设置广播事务处理，实例如下;
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffb6c1; font-size: 105%;">final</span> <span style="color: #ffff00; font-size: 105%;">BroadcastReceiver</span> <span style="color: #ffd700;">mReceiver</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">BroadcastReceiver</span>() {
    <span style="color: #7fffd4;">@Override</span>
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> onReceive(<span style="color: #ffff00; font-size: 105%;">Context</span> <span style="color: #ffd700;">context</span>, <span style="color: #ffff00; font-size: 105%;">Intent</span> <span style="color: #ffd700;">intent</span>) {
    <span style="color: #ffb6c1; font-size: 105%;">final</span> <span style="color: #ffff00; font-size: 105%;">String</span> <span style="color: #ffd700;">action</span> = intent.getAction();
    <span style="color: #ffb6c1; font-size: 105%;">if</span> (ACTION_GATT_CONNECTED.equals(action)) {
        <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">...</span>
    } <span style="color: #ffb6c1; font-size: 105%;">else</span> <span style="color: #ffb6c1; font-size: 105%;">if</span> (ACTION_GATT_DISCONNECTED.equals(action)) {
        <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">...</span>
    } <span style="color: #ffb6c1; font-size: 105%;">else</span> <span style="color: #ffb6c1; font-size: 105%;">if</span> (ACTION_GATT_SERVICES_DISCOVERED.equals(action)) {
        <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">...</span>
    } <span style="color: #ffb6c1; font-size: 105%;">else</span> <span style="color: #ffb6c1; font-size: 105%;">if</span> (ACTION_DATA_AVAILABLE.equals(action)) {
        <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">...</span>
    }
    }
};
</pre>
</div></li>
<li><p>
注册，将action和事务处理相结合，实例如下;
</p>
<div class="org-src-container">
<pre class="src src-java">registerReceiver(<span style="color: #ffff00; font-size: 105%;">mReceiver</span>, <span style="color: #ffff00; font-size: 105%;">makeIntentFilter</span>());
</pre>
</div></li>
<li><p>
产生事件源，在别的地方发送消息，实例如下;
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">broadcastUpdate</span>(<span style="color: #ffb6c1; font-size: 105%;">final</span> <span style="color: #ffff00; font-size: 105%;">String</span> <span style="color: #ffd700;">action</span>) {
    <span style="color: #ffb6c1; font-size: 105%;">final</span> <span style="color: #ffff00; font-size: 105%;">Intent</span> <span style="color: #ffd700;">intent</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">Intent</span>(action);
    sendBroadcast(intent);
}
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org346bdc0" class="outline-3">
<h3 id="org346bdc0"><span class="section-number-3">3.5</span> 消息机制</h3>
<div class="outline-text-3" id="text-3-5">
<p>
Android应用程序是通过消息来驱动的，系统为每一个应用程序维护一个消息队例，应
用程序的主线程不断地从这个消息队例中获取消息(Looper)，然后对这些消息进行处
理(Handler)，这样就实现了通过消息来驱动应用程序的执行. 
</p>
<ul class="org-ul">
<li>Message：消息，其中包含了消息ID，消息处理对象以及处理的数据等，由
MessageQueue统一列队，终由Handler处理。</li>
<li>Handler：处理者，负责Message的发送及处理。使用Handler时，需要实现
handleMessage(Message msg)方法来对特定的Message进行处理，例如更新UI等。</li>
<li>MessageQueue：消息队列，用来存放Handler发送过来的消息，并按照FIFO规则执行。
当然，存放Message并非实际意义的保存，而是将Message以链表的方式串联起来的，
等待Looper的抽取。</li>
<li>Looper：消息泵，不断地从MessageQueue中抽取Message执行。因此，一个
MessageQueue需要一个Looper。</li>
<li>Thread：线程，负责调度整个消息循环，即消息循环的执行场所。</li>
</ul>
</div>
<div id="outline-container-org0b38aa1" class="outline-4">
<h4 id="org0b38aa1"><span class="section-number-4">3.5.1</span> Handler</h4>
<div class="outline-text-4" id="text-3-5-1">
<p>
功能主要是跟UI线程交互用，主要有：
</p>
<ol class="org-ol">
<li>用handler发送一个message，然后在handler的线程中来接收、处理该消息，以避免直接在UI主线程中处理事务导致影响UI主线程的其
他处理工作 ；</li>
<li>你可以将handler对象传给其他进程，以便在其他进程中通过handler给你发送事件；</li>
<li>通过handler的延时发送message，可以延时处理一些事务的处理；</li>
<li><p>
线程处理功能：可以使用Handler的post方法，将要处理的事务放在一个thread里面，然后将该线程post到Handler的线程队列中(其实
这个线程和activity主线程是同一个线程，只是运行了线程的run方法)，则该事务将会在thread里面执行，如果使用
postDelayed(thread, time)方法，还能设置一个延时time后执行该事务，类似于timer功能；
实例如下所示。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20351;&#29992;handler&#26102;&#39318;&#20808;&#35201;&#21019;&#24314;&#19968;&#20010;handler</span>
<span style="color: #ffff00; font-size: 105%;">Handler</span> <span style="color: #ffd700;">handler</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">Handler</span>();
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#35201;&#29992;handler&#26469;&#22788;&#29702;&#22810;&#32447;&#31243;&#21487;&#20197;&#20351;&#29992;runnable&#25509;&#21475;&#65292;&#36825;&#37324;&#20808;&#23450;&#20041;&#35813;&#25509;&#21475;</span>
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#32447;&#31243;&#20013;&#36816;&#34892;&#35813;&#25509;&#21475;&#30340;run&#20989;&#25968;</span>
<span style="color: #ffff00; font-size: 105%;">Runnable</span> <span style="color: #ffd700;">update_thread</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">Runnable</span>(){
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> run(){
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#32447;&#31243;&#27599;&#27425;&#25191;&#34892;&#26102;&#36755;&#20986;"UpdateThread..."&#25991;&#23383;,&#19988;&#33258;&#21160;&#25442;&#34892;</span>
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">textview&#30340;append&#21151;&#33021;&#21644;Qt&#20013;&#30340;append&#31867;&#20284;&#65292;&#19981;&#20250;&#35206;&#30422;&#21069;&#38754;</span>
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#30340;&#20869;&#23481;&#65292;&#21482;&#26159;Qt&#20013;&#30340;append&#40664;&#35748;&#26159;&#33258;&#21160;&#25442;&#34892;&#27169;&#24335;</span>
    text_view.append(<span style="color: #ffa07a;">"\nUpdateThread..."</span>);
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#24310;&#26102;1s&#21518;&#21448;&#23558;&#32447;&#31243;&#21152;&#20837;&#21040;&#32447;&#31243;&#38431;&#21015;&#20013;</span>
    handler.postDelayed(update_thread, 1000);
    }
};
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#23558;&#32447;&#31243;&#25509;&#21475;&#31435;&#21051;&#36865;&#21040;&#32447;&#31243;&#38431;&#21015;&#20013;</span>
handler.post(update_thread);
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#23558;&#25509;&#21475;&#20174;&#32447;&#31243;&#38431;&#21015;&#20013;&#31227;&#38500;</span>
handler.removeCallbacks(update_thread);
</pre>
</div></li>
<li><p>
异步消息处理功能：同样也是使用上面线程处理功能，将某个线程thread，post到handler的线程队列中，线程队列中处理事务，并可
以使用handler的sendMessage()，方法向handler中发送message，然后在handler中可以使用handleMessage来处理这个消息；实例如下：
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21019;&#24314;&#19968;&#20010;handler&#65292;&#20869;&#37096;&#23436;&#25104;&#22788;&#29702;&#28040;&#24687;&#26041;&#27861;</span>
<span style="color: #ffff00; font-size: 105%;">Handler</span> <span style="color: #ffd700;">update_progress_bar</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">Handler</span>(){
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> handleMessage(<span style="color: #ffff00; font-size: 105%;">Message</span> <span style="color: #ffd700;">msg</span>) {
    <span style="color: #ffb6c1; font-size: 105%;">super</span>.handleMessage(msg);
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#26174;&#31034;&#36827;&#24230;&#26465;</span>
    progress_bar.setProgress(msg.arg1);
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#37325;&#26032;&#25226;&#36827;&#31243;&#21152;&#20837;&#21040;&#36827;&#31243;&#38431;&#21015;&#20013;</span>
    update_progress_bar.post(update_thread);
    }
};
update_progress_bar.post(update_thread);<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">post&#32447;&#31243;</span>
<span style="color: #ffff00; font-size: 105%;">Runnable</span> <span style="color: #ffd700;">update_thread</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">Runnable</span>() {
    <span style="color: #ffff00; font-size: 105%;">int</span> i = 0;
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">run</span>() {
    i += 10;
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#39318;&#20808;&#33719;&#24471;&#19968;&#20010;&#28040;&#24687;&#32467;&#26500;</span>
    <span style="color: #ffff00; font-size: 105%;">Message</span> <span style="color: #ffd700;">msg</span> = update_progress_bar.obtainMessage();
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#32473;&#28040;&#24687;&#32467;&#26500;&#30340;arg1&#21442;&#25968;&#36171;&#20540;</span>
    msg.arg1 = i;
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#24310;&#26102;1s</span>
    Thread.sleep(1000);
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#25226;&#28040;&#24687;&#21457;&#36865;&#21040;&#28040;&#24687;&#38431;&#21015;&#20013;</span>
    update_progress_bar.sendMessage(msg);
    <span style="color: #ffb6c1; font-size: 105%;">if</span>(i == 100)
        update_progress_bar.removeCallbacks(update_thread);<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#31227;&#38500;</span>
    }
};
</pre>
</div></li>
</ol>
</div>
</div>

<div id="outline-container-orgc5c2ebd" class="outline-4">
<h4 id="orgc5c2ebd"><span class="section-number-4">3.5.2</span> Looper</h4>
</div>

<div id="outline-container-org6bb1c54" class="outline-4">
<h4 id="org6bb1c54"><span class="section-number-4">3.5.3</span> Message</h4>
</div>
<div id="outline-container-org6da8b8a" class="outline-4">
<h4 id="org6da8b8a"><span class="section-number-4">3.5.4</span> SharedPreferences</h4>
<div class="outline-text-4" id="text-3-5-4">
<p>
很多软件会有配置文件，里面存放这程序运行当中的各个属性值，由于其配置信息并不多，如果采用数据库来存放并不划算，因为数据库
连接跟操作等耗时大大影响了程序的效率，因此我们使用键值这种一一对应的关系来存放这些配置信息。SharedPreferences正是Android
中用于实现这中存储方式的技术。  
SharedPreferences的使用非常简单，能够轻松的存放数据和读取数据。SharedPreferences只能保存简单类型的数据，例如，String、
int等。一般会将复杂类型的数据转换成Base64编码，然后将转换后的数据以字符串的形式保存在 XML文件中，再用SharedPreferences保
存。使用SharedPreferences保存key-value对的步骤如下。
</p>
<ol class="org-ol">
<li>使用Activity类的getSharedPreferences方法获得SharedPreferences对象，其中存储key-value的文件的名称由
getSharedPreferences方法的第一个参数指定。</li>
<li>使用SharedPreferences接口的edit获得SharedPreferences.Editor对象。</li>
<li>通过SharedPreferences.Editor接口的putXxx方法保存key-value对。其中Xxx表示不同的数据类型。例如：字符串类型的value需要用
putString方法。</li>
<li>通过SharedPreferences.Editor接口的commit方法保存key-value对。commit方法相当于数据库事务中的提交（commit）操作。</li>
</ol>
<p>
具体代码的书写流程为。
</p>
<ul class="org-ul">
<li>存放数据信息
<ol class="org-ol">
<li>打开Preferences，名称为setting，如果存在则打开它，否则创建新的Preferences SharedPreferences settings =
getSharedPreferences(“setting”, 0);</li>
<li>让setting处于编辑状态SharedPreferences.Editor editor = settings.edit();</li>
<li>存放数据editor.putString(“name”,”ATAAW”);editor.putString(“URL”,”ATAAW.COM”);</li>
<li>完成提交editor.commit();</li>
</ol></li>
<li>读取数据信息
<ol class="org-ol">
<li>获取Preferences: SharedPreferences settings = getSharedPreferences(“setting”, 0);</li>
<li>取出数据String name = settings.getString(“name”,”默认值”);
String url = setting.getString(“URL”,”default”);</li>
</ol></li>
</ul>
<p>
其中创建的Preferences文件存放位置可以在Eclipse中查看：DDMS-&gt;File Explorer /&lt;package name&gt;/shared<sub>prefs</sub>/setting.xml 
</p>
</div>
</div>
</div>
<div id="outline-container-org27df74c" class="outline-3">
<h3 id="org27df74c"><span class="section-number-3">3.6</span> 通知栏操作</h3>
<div class="outline-text-3" id="text-3-6">
<p>
在Android系统中，发一个状态栏通知还是很方便的。首先，发送一个状态栏通知必须
用到两个类：NotificationManager、Notification。 
</p>
<ul class="org-ul">
<li><p>
NotificationManager ：  是状态栏通知的管理类，负责发通知、清楚通知等。
NotificationManager是一个系统Service，必须通过getSystemService()来获取。 
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">NotificationManager</span> <span style="color: #ffd700;">nm</span> = (<span style="color: #ffff00; font-size: 105%;">NotificationManager</span>) getSystemService(NOTIFICATION_SERVICE);
</pre>
</div></li>
<li><p>
Notification：是具体的状态栏通知对象，可以设置icon、文字、提示声音、振动
等等参数。下面是设置一个通知需要的基本参数. 
</p>
<ol class="org-ol">
<li>An icon  (通知的图标);</li>
<li>A title and expanded message  (通知的标题和内容);</li>
<li>A PendingIntent   (点击通知执行页面跳转);</li>
</ol>
<p>
可选的设置.
</p>
<ol class="org-ol">
<li>A ticker-text message (状态栏顶部提示消息);</li>
<li>An alert sound    (提示音)</li>
<li>A vibrate setting  (振动)</li>
<li>A flashing LED setting  (灯光)</li>
</ol></li>
</ul>
<p>
使用步骤
</p>
<ol class="org-ol">
<li>创建Notification：通过NotificationManager的notify(int, Notification)方法
来启动Notification。第一个参数唯一的标识该Notification，第二个参数就是
Notification对象。</li>
<li>更新Notification：调用Notification的setLatestEventInfo方法来更新内容，然
后调用NotificationManager的notify()方法即可。</li>
<li>删除Notification：通过NotificationManager的cancel(int)方法，来清除某个通
知。其中参数就是Notification的唯一标识ID。当然也可以通过  cancelAll() 来
清除状态栏所有的通知。</li>
<li>Notification设置(振动、铃声等)；</li>
</ol>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#26032;&#24314;&#29366;&#24577;&#26639;&#36890;&#30693;</span>
baseNF = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">Notification</span>();

<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#35774;&#32622;&#36890;&#30693;&#22312;&#29366;&#24577;&#26639;&#26174;&#31034;&#30340;&#22270;&#26631;</span>
baseNF.icon = R.drawable.icon;

<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#36890;&#30693;&#26102;&#22312;&#29366;&#24577;&#26639;&#26174;&#31034;&#30340;&#20869;&#23481;</span>
baseNF.tickerText = <span style="color: #ffa07a;">"You clicked BaseNF!"</span>;

<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#36890;&#30693;&#30340;&#40664;&#35748;&#21442;&#25968; DEFAULT_SOUND, DEFAULT_VIBRATE, DEFAULT_LIGHTS. </span>
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#22914;&#26524;&#35201;&#20840;&#37096;&#37319;&#29992;&#40664;&#35748;&#20540;, &#29992; DEFAULT_ALL.</span>
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#27492;&#22788;&#37319;&#29992;&#40664;&#35748;&#22768;&#38899;</span>
baseNF.defaults = <span style="color: #7fffd4;">Notification</span>.DEFAULT_SOUND;

<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#31532;&#20108;&#20010;&#21442;&#25968; &#65306;&#19979;&#25289;&#29366;&#24577;&#26639;&#26102;&#26174;&#31034;&#30340;&#28040;&#24687;&#26631;&#39064; expanded message title</span>
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#31532;&#19977;&#20010;&#21442;&#25968;&#65306;&#19979;&#25289;&#29366;&#24577;&#26639;&#26102;&#26174;&#31034;&#30340;&#28040;&#24687;&#20869;&#23481; expanded message text</span>
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#31532;&#22235;&#20010;&#21442;&#25968;&#65306;&#28857;&#20987;&#35813;&#36890;&#30693;&#26102;&#25191;&#34892;&#39029;&#38754;&#36339;&#36716;</span>
baseNF.setLatestEventInfo(Lesson_10.<span style="color: #ffb6c1; font-size: 105%;">this</span>, <span style="color: #ffa07a;">"Title01"</span>, <span style="color: #ffa07a;">"Content01"</span>, pd);

<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21457;&#20986;&#29366;&#24577;&#26639;&#36890;&#30693;</span>
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">The first parameter is the unique ID for the Notification </span>
<span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">and the second is the Notification object.</span>
nm.notify(Notification_ID_BASE, baseNF);
</pre>
</div>
</div>
</div>
<div id="outline-container-org9cefc89" class="outline-3">
<h3 id="org9cefc89"><span class="section-number-3">3.7</span> 程序首选项</h3>
<div class="outline-text-3" id="text-3-7">
<p>
一般程序可以通过“设置”也就是首选项做一些更个性化的设置。打开我们的系统设
置中，会看到整个页面被分为几组：无线网络、设备、个人、账户和系统。这个分组
（或者叫分类）就是PreferenceCategory。Wifi右边有开关，这一项就是
CheckBoxPreference；其他还有ListPreference和EditTextPreference。每一次设置，
都会被Preference存下来，这就是setting的数据持久化。我们可以通过
SharedPreference对象获得这个程序的全体设置，Preference的对象获得其中某个设
置。Preference Activity框架由4个部分组成。 
</p>
<ul class="org-ul">
<li>PreferenceScreen: 是个xml文件，定义了在Preference Screen中显示的层次结构。
它指定了要显示的文本及控件、值等；</li>
<li>PreferenceActivity和PreferenceFragment：首先要说的是，PreferenceActivity
从API level1中就加入了，那么后续自Android3.0后有了Fragment的概念，同时也
带来了PreferenceFragment，他们都用于包含PreferenceScreen，在Android3.0前，
PreferenceActivity直接包含PreferenceScreen，之后，PreferenceScreen包含在
PreferenceFragment中，而PreferenceFragment又包含到PreferenceActivity；</li>
<li>PreferenceHeader：是一个xml文件，3.0后随Fragment引入，用于显示
PreferenceFragment的层次结构。</li>
<li>SharedPreference监听程序：也就是接口onSharedPreferenceChangeListener，用
于监听界面上的设置变化，这个接口用于监听SharePreference，即只要有设置项改
变，这个就会被触发回调，区别于OnPreferenceChangeListener是用于监听某项的
改变，而OnPreferenceClickListener是监听某项的点击 ；</li>
</ul>
</div>
</div>
<div id="outline-container-org6db5aed" class="outline-3">
<h3 id="org6db5aed"><span class="section-number-3">3.8</span> menu</h3>
<div class="outline-text-3" id="text-3-8">
<p>
menu标签中item标签的主要属性见表\ref{tbl-menu-bar}
</p>
<table id="org5266b66" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> android menu bar xml属性说明</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">属性名</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">android:orderInCategory</td>
<td class="org-left">指每个item优先级，值越大越低，地方不够就会放到overflow中。</td>
</tr>

<tr>
<td class="org-left">android:title</td>
<td class="org-left">item的标题。</td>
</tr>

<tr>
<td class="org-left">android:icon</td>
<td class="org-left">item显示的图标。</td>
</tr>

<tr>
<td class="org-left">app:showAsAction</td>
<td class="org-left">item显示的方式。</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="outline-container-orgcff3553" class="outline-3">
<h3 id="orgcff3553"><span class="section-number-3">3.9</span> gps</h3>
<div class="outline-text-3" id="text-3-9">
</div>
<div id="outline-container-org627a37d" class="outline-4">
<h4 id="org627a37d"><span class="section-number-4">3.9.1</span> 组件</h4>
<div class="outline-text-4" id="text-3-9-1">
<ul class="org-ul">
<li>LocationManagerService：简称LMS，统一管理android平台中能够提供位置服务的
相关模块；</li>
<li>LocationManager：简称LM，为需要使用位置服务的应用程序服务，LMS和LM通过
binder进行交互；</li>
<li>LocationProvider：简称LP，表示android平台中能够提供位置服务的相关模块的统
称，在所有位置提供者中，android framework实现了其中的PassiveProvider和
GpsLocationProvider，这两个LP由LMS创建并允许在系统进程中；</li>
<li>LocationProviderInterface：LP必须实现这个接口，这些接口对应的对象实例由
LMS来创建和管理；</li>
<li>NetworkLocationProvider：由网络提供的位置服务，android原生代码中不提供相
关功能，一般第三方厂商会提供；</li>
<li>GMS：GoogleMobileService，由Google提供的NetworkLocationProvider，国内的一
般由百度提供；</li>
<li>ILocationProviderProxy：由于一些LP是由第三方提供，他们运行在应用程序所在
的进程中，所以系统定了这个接口使LMS管理这些由应用程序提供的位置服务；</li>
<li>LocationProviderBase：第三方提供LP，必须实现这个抽象类；</li>
<li>FusedLocationProvider：它自身不提供位置信息，而是综合GpsLP和NetworkLP的位
置信息，然后向使用者提供最符合使用者需求的数据，平衡电量和数据精度要求；</li>
<li>GeocodeProxy：由于需要将位置信息和地址相互转换，而有些位置信息由第三方提
供，所以LMS利用这个和第三方应用中实现GeocodeProxy的对象进行交互。</li>
</ul>
</div>
</div>
<div id="outline-container-org3b85e85" class="outline-4">
<h4 id="org3b85e85"><span class="section-number-4">3.9.2</span> 操作</h4>
<div class="outline-text-4" id="text-3-9-2">
<ol class="org-ol">
<li>先创建一个LocationManager对象，用于和LMS交互；</li>
<li>然后调用LocationManager的requestLocationUpdates以设置一个回调接口对象
LocationListener，同时指出要使用哪个LP，或指定定位精度，由系统决定选择LP；</li>
<li>当LP更新相关信息后，LocationListener对应的函数将被调用，应用程序可以在这
些回调函数中做相应处理；</li>
<li>如果应用程序需要在位置和地址信息做转换，则使用Geocoder类提供的函数；</li>
</ol>
</div>
<div id="outline-container-org0e25d4d" class="outline-5">
<h5 id="org0e25d4d"><span class="section-number-5">3.9.2.1</span> LocationManager</h5>
<div class="outline-text-5" id="text-3-9-2-1">
<p>
LocationMangager，位置管理器。要想操作定位相关设备，必须先定义个
LocationManager。我们可以通过如下代码创建LocationManger对象。 
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">LocationManger</span> <span style="color: #ffd700;">locationManager</span>=(<span style="color: #ffff00; font-size: 105%;">LocationManager</span>)<span style="color: #ffb6c1; font-size: 105%;">this</span>.getSystemService(<span style="color: #7fffd4;">Context</span>.LOCATION_SERVICE); 
</pre>
</div>
</div>
</div>
<div id="outline-container-orga5ab2e0" class="outline-5">
<h5 id="orga5ab2e0"><span class="section-number-5">3.9.2.2</span> LocationListener</h5>
<div class="outline-text-5" id="text-3-9-2-2">
<p>
LocationListener，位置监听，监听位置变化，监听设备开关与状态。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffff00; font-size: 105%;">LocationListener</span> <span style="color: #ffd700;">locationListener</span>=<span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">LocationListener</span>() {
    <span style="color: #ffa07a;">/**</span>
<span style="color: #ffa07a;">     * &#20301;&#32622;&#20449;&#24687;&#21464;&#21270;&#26102;&#35302;&#21457;</span>
<span style="color: #ffa07a;">     */</span>
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> onLocationChanged(<span style="color: #ffff00; font-size: 105%;">Location</span> <span style="color: #ffd700;">location</span>) {
        updateView(location);
        Log.i(TAG, <span style="color: #ffa07a;">"&#26102;&#38388;&#65306;"</span>+location.getTime()); 
        Log.i(TAG, <span style="color: #ffa07a;">"&#32463;&#24230;&#65306;"</span>+location.getLongitude()); 
        Log.i(TAG, <span style="color: #ffa07a;">"&#32428;&#24230;&#65306;"</span>+location.getLatitude()); 
        Log.i(TAG, <span style="color: #ffa07a;">"&#28023;&#25300;&#65306;"</span>+location.getAltitude()); 
    }

    <span style="color: #ffa07a;">/**</span>
<span style="color: #ffa07a;">     * GPS&#29366;&#24577;&#21464;&#21270;&#26102;&#35302;&#21457;</span>
<span style="color: #ffa07a;">     */</span>
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">onStatusChanged</span>(<span style="color: #ffff00; font-size: 105%;">String</span> <span style="color: #ffd700;">provider</span>, <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">status</span>, <span style="color: #ffff00; font-size: 105%;">Bundle</span> <span style="color: #ffd700;">extras</span>) {
        <span style="color: #ffb6c1; font-size: 105%;">switch</span> (status) {
        <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">GPS&#29366;&#24577;&#20026;&#21487;&#35265;&#26102;</span>
        <span style="color: #ffb6c1; font-size: 105%;">case</span> <span style="color: #7fffd4;">LocationProvider</span>.AVAILABLE:
        Log.i(TAG, <span style="color: #ffa07a;">"&#24403;&#21069;GPS&#29366;&#24577;&#20026;&#21487;&#35265;&#29366;&#24577;"</span>);
        <span style="color: #ffb6c1; font-size: 105%;">break</span>;
        <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">GPS&#29366;&#24577;&#20026;&#26381;&#21153;&#21306;&#22806;&#26102;</span>
        <span style="color: #ffb6c1; font-size: 105%;">case</span> <span style="color: #7fffd4;">LocationProvider</span>.OUT_OF_SERVICE:
        Log.i(TAG, <span style="color: #ffa07a;">"&#24403;&#21069;GPS&#29366;&#24577;&#20026;&#26381;&#21153;&#21306;&#22806;&#29366;&#24577;"</span>);
        <span style="color: #ffb6c1; font-size: 105%;">break</span>;
        <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">GPS&#29366;&#24577;&#20026;&#26242;&#20572;&#26381;&#21153;&#26102;</span>
        <span style="color: #ffb6c1; font-size: 105%;">case</span> <span style="color: #7fffd4;">LocationProvider</span>.TEMPORARILY_UNAVAILABLE:
        Log.i(TAG, <span style="color: #ffa07a;">"&#24403;&#21069;GPS&#29366;&#24577;&#20026;&#26242;&#20572;&#26381;&#21153;&#29366;&#24577;"</span>);
        <span style="color: #ffb6c1; font-size: 105%;">break</span>;
        }
    }
    <span style="color: #ffa07a;">/**</span>
<span style="color: #ffa07a;">     * GPS&#24320;&#21551;&#26102;&#35302;&#21457;</span>
<span style="color: #ffa07a;">     */</span>
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">onProviderEnabled</span>(<span style="color: #ffff00; font-size: 105%;">String</span> <span style="color: #ffd700;">provider</span>) {
        <span style="color: #ffff00; font-size: 105%;">Location</span> <span style="color: #ffd700;">location</span>=lm.getLastKnownLocation(provider);
        updateView(location);
    }
    <span style="color: #ffa07a;">/**</span>
<span style="color: #ffa07a;">     * GPS&#31105;&#29992;&#26102;&#35302;&#21457;</span>
<span style="color: #ffa07a;">     */</span>
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">onProviderDisabled</span>(<span style="color: #ffff00; font-size: 105%;">String</span> <span style="color: #ffd700;">provider</span>) {
        updateView(<span style="color: #7fffd4;">null</span>);
    }
    };
</pre>
</div>
</div>
</div>
<div id="outline-container-orgccbf7e0" class="outline-5">
<h5 id="orgccbf7e0"><span class="section-number-5">3.9.2.3</span> Location</h5>
<div class="outline-text-5" id="text-3-9-2-3">
<p>
Location，位置信息，通过Location可以获取时间、经纬度、海拔等位置信息。上面
采用locationListener里面的onLocationChanged()来获取location，下面讲述如何主
动获取location。 
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">Location</span> <span style="color: #ffd700;">location</span>=locationManager.getLastKnownLocation(<span style="color: #7fffd4;">LocationManager</span>.GPS_PROVIDER);
system.out.println(<span style="color: #ffa07a;">"&#26102;&#38388;&#65306;"</span>+location.getTime());
system.out.println(<span style="color: #ffa07a;">"&#32463;&#24230;&#65306;"</span>+location.getLongitude());  
</pre>
</div>
</div>
</div>
<div id="outline-container-org8c646f1" class="outline-5">
<h5 id="org8c646f1"><span class="section-number-5">3.9.2.4</span> GpsStatus.Listener</h5>
<div class="outline-text-5" id="text-3-9-2-4">
<p>
GpsStatus.Listener，GPS状态监听，包括GPS启动、停止、第一次定位、卫星变化等
事件。  
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#29366;&#24577;&#30417;&#21548;</span>
    <span style="color: #7fffd4;">GpsStatus</span>.<span style="color: #ffff00; font-size: 105%;">Listener</span> <span style="color: #ffd700;">listener</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #7fffd4;">GpsStatus</span>.<span style="color: #ffff00; font-size: 105%;">Listener</span>() {
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> onGpsStatusChanged(<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">event</span>) {
        <span style="color: #ffb6c1; font-size: 105%;">switch</span> (event) {
        <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#31532;&#19968;&#27425;&#23450;&#20301;</span>
        <span style="color: #ffb6c1; font-size: 105%;">case</span> <span style="color: #7fffd4;">GpsStatus</span>.GPS_EVENT_FIRST_FIX:
        Log.i(TAG, <span style="color: #ffa07a;">"&#31532;&#19968;&#27425;&#23450;&#20301;"</span>);
        <span style="color: #ffb6c1; font-size: 105%;">break</span>;
        <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21355;&#26143;&#29366;&#24577;&#25913;&#21464;</span>
        <span style="color: #ffb6c1; font-size: 105%;">case</span> <span style="color: #7fffd4;">GpsStatus</span>.GPS_EVENT_SATELLITE_STATUS:
        Log.i(TAG, <span style="color: #ffa07a;">"&#21355;&#26143;&#29366;&#24577;&#25913;&#21464;"</span>);
        <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#33719;&#21462;&#24403;&#21069;&#29366;&#24577;</span>
        <span style="color: #ffff00; font-size: 105%;">GpsStatus</span> <span style="color: #ffd700;">gpsStatus</span>=lm.getGpsStatus(<span style="color: #7fffd4;">null</span>);
        <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#33719;&#21462;&#21355;&#26143;&#39063;&#25968;&#30340;&#40664;&#35748;&#26368;&#22823;&#20540;</span>
        <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">maxSatellites</span> = gpsStatus.getMaxSatellites();
        <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21019;&#24314;&#19968;&#20010;&#36845;&#20195;&#22120;&#20445;&#23384;&#25152;&#26377;&#21355;&#26143; </span>
        <span style="color: #ffff00; font-size: 105%;">Iterator</span>&lt;<span style="color: #ffff00; font-size: 105%;">GpsSatellite</span>&gt; <span style="color: #ffd700;">iters</span> = gpsStatus.getSatellites().iterator();
        <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">count</span> = 0;     
        <span style="color: #ffb6c1; font-size: 105%;">while</span> (iters.hasNext() &amp;&amp; count &lt;= maxSatellites) {     
            <span style="color: #ffff00; font-size: 105%;">GpsSatellite</span> <span style="color: #ffd700;">s</span> = iters.next();     
            count++;     
        }   
        System.out.println(<span style="color: #ffa07a;">"&#25628;&#32034;&#21040;&#65306;"</span>+count+<span style="color: #ffa07a;">"&#39063;&#21355;&#26143;"</span>);
        <span style="color: #ffb6c1; font-size: 105%;">break</span>;
        <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#23450;&#20301;&#21551;&#21160;</span>
        <span style="color: #ffb6c1; font-size: 105%;">case</span> <span style="color: #7fffd4;">GpsStatus</span>.GPS_EVENT_STARTED:
        Log.i(TAG, <span style="color: #ffa07a;">"&#23450;&#20301;&#21551;&#21160;"</span>);
        <span style="color: #ffb6c1; font-size: 105%;">break</span>;
        <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#23450;&#20301;&#32467;&#26463;</span>
        <span style="color: #ffb6c1; font-size: 105%;">case</span> <span style="color: #7fffd4;">GpsStatus</span>.GPS_EVENT_STOPPED:
        Log.i(TAG, <span style="color: #ffa07a;">"&#23450;&#20301;&#32467;&#26463;"</span>);
        <span style="color: #ffb6c1; font-size: 105%;">break</span>;
        }
    };
    };
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#32465;&#23450;&#30417;&#21548;&#29366;&#24577;</span>
lm.addGpsStatusListener(listener);
</pre>
</div>
</div>
</div>
<div id="outline-container-org7e8b97a" class="outline-5">
<h5 id="org7e8b97a"><span class="section-number-5">3.9.2.5</span> GpsStatus</h5>
<div class="outline-text-5" id="text-3-9-2-5">
<p>
GpsStatus，GPS状态信息，上面在卫星状态变化时，我们就用到了GpsStatus。 
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#23454;&#20363;&#21270;    </span>
<span style="color: #ffff00; font-size: 105%;">GpsStatus</span> <span style="color: #ffd700;">gpsStatus</span> = locationManager.getGpsStatus(<span style="color: #7fffd4;">null</span>); <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">&#33719;&#21462;&#24403;&#21069;&#29366;&#24577;    </span>
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#33719;&#21462;&#40664;&#35748;&#26368;&#22823;&#21355;&#26143;&#25968;    </span>
<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">maxSatellites</span> = gpsStatus.getMaxSatellites();     
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#33719;&#21462;&#31532;&#19968;&#27425;&#23450;&#20301;&#26102;&#38388;&#65288;&#21551;&#21160;&#21040;&#31532;&#19968;&#27425;&#23450;&#20301;&#65289;    </span>
<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">costTime</span>=gpsStatus.getTimeToFirstFix();   
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#33719;&#21462;&#21355;&#26143;    </span>
<span style="color: #ffff00; font-size: 105%;">Iterable</span>&lt;<span style="color: #ffff00; font-size: 105%;">GpsSatellite</span>&gt; <span style="color: #ffd700;">iterable</span>=gpsStatus.getSatellites();   
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#19968;&#33324;&#20877;&#27425;&#36716;&#25442;&#25104;Iterator    </span>
<span style="color: #ffff00; font-size: 105%;">Iterator</span>&lt;<span style="color: #ffff00; font-size: 105%;">GpsSatellite</span>&gt; <span style="color: #ffd700;">itrator</span>=iterable.iterator();
</pre>
</div>
</div>
</div>
<div id="outline-container-org28741c7" class="outline-5">
<h5 id="org28741c7"><span class="section-number-5">3.9.2.6</span> GpsSatellite</h5>
<div class="outline-text-5" id="text-3-9-2-6">
<p>
GpsSatellite，定位卫星，包含卫星的方位、高度、伪随机噪声码、信噪比等信息 
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#33719;&#21462;&#21355;&#26143;    </span>
<span style="color: #ffff00; font-size: 105%;">Iterable</span>&lt;<span style="color: #ffff00; font-size: 105%;">GpsSatellite</span>&gt; <span style="color: #ffd700;">iterable</span>=gpsStatus.getSatellites();   
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20877;&#27425;&#36716;&#25442;&#25104;Iterator    </span>
<span style="color: #ffff00; font-size: 105%;">Iterator</span>&lt;<span style="color: #ffff00; font-size: 105%;">GpsSatellite</span>&gt; <span style="color: #ffd700;">itrator</span>=iterable.iterator();   
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#36890;&#36807;&#36941;&#21382;&#37325;&#26032;&#25972;&#29702;&#20026;ArrayList    </span>
<span style="color: #ffff00; font-size: 105%;">ArrayList</span>&lt;<span style="color: #ffff00; font-size: 105%;">GpsSatellite</span>&gt; <span style="color: #ffd700;">satelliteList</span>=<span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">ArrayList</span>&lt;<span style="color: #ffff00; font-size: 105%;">GpsSatellite</span>&gt;();    
<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">count</span>=0;   
<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">maxSatellites</span>=gpsStatus.getMaxSatellites();   
<span style="color: #ffb6c1; font-size: 105%;">while</span> (itrator.hasNext() &amp;&amp; count &lt;= maxSatellites) {     
    <span style="color: #ffff00; font-size: 105%;">GpsSatellite</span> <span style="color: #ffd700;">satellite</span> = itrator.next();     
    satelliteList.add(satellite);     
    count++;   
}    
System.out.println(<span style="color: #ffa07a;">"&#24635;&#20849;&#25628;&#32034;&#21040;"</span>+count+<span style="color: #ffa07a;">"&#39063;&#21355;&#26143;"</span>);   
<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#36755;&#20986;&#21355;&#26143;&#20449;&#24687;    </span>
<span style="color: #ffb6c1; font-size: 105%;">for</span>(<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">i</span>=0;i&lt;satelliteList.<span style="color: #ffff00; font-size: 105%;">size</span>();i++){   
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21355;&#26143;&#30340;&#26041;&#20301;&#35282;&#65292;&#28014;&#28857;&#22411;&#25968;&#25454;    </span>
    System.out.println(satelliteList.get(i).getAzimuth());   
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21355;&#26143;&#30340;&#39640;&#24230;&#65292;&#28014;&#28857;&#22411;&#25968;&#25454;    </span>
    System.out.println(satelliteList.get(i).getElevation());   
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21355;&#26143;&#30340;&#20266;&#38543;&#26426;&#22122;&#22768;&#30721;&#65292;&#25972;&#24418;&#25968;&#25454;    </span>
    System.out.println(satelliteList.get(i).getPrn());   
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21355;&#26143;&#30340;&#20449;&#22122;&#27604;&#65292;&#28014;&#28857;&#22411;&#25968;&#25454;    </span>
    System.out.println(satelliteList.get(i).getSnr());   
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21355;&#26143;&#26159;&#21542;&#26377;&#24180;&#21382;&#34920;&#65292;&#24067;&#23572;&#22411;&#25968;&#25454;    </span>
    System.out.println(satelliteList.get(i).hasAlmanac());   
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21355;&#26143;&#26159;&#21542;&#26377;&#26143;&#21382;&#34920;&#65292;&#24067;&#23572;&#22411;&#25968;&#25454;    </span>
    System.out.println(satelliteList.get(i).hasEphemeris());   
    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21355;&#26143;&#26159;&#21542;&#34987;&#29992;&#20110;&#36817;&#26399;&#30340;GPS&#20462;&#27491;&#35745;&#31639;    </span>
    System.out.println(satelliteList.get(i).hasAlmanac());   
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org3d49d8d" class="outline-4">
<h4 id="org3d49d8d"><span class="section-number-4">3.9.3</span> 位置模拟</h4>
<div class="outline-text-4" id="text-3-9-3">
<p>
大体思路如下。
</p>
<ol class="org-ol">
<li>获取待模拟的位置；</li>
<li><p>
将位置信息植入需要的Provider里面, 下面示例代码以模拟位置植入GPS<sub>PROVIDER</sub>
中为例； 
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">xml&#26435;&#38480; </span>
&lt;uses-permission android:name=<span style="color: #ffa07a;">"android.permission.ACCESS_MOCK_LOCATION"</span>&gt;
<span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">void</span> setLocation(<span style="color: #ffff00; font-size: 105%;">Context</span> <span style="color: #ffd700;">context</span>, <span style="color: #ffff00; font-size: 105%;">LatLonBean</span> <span style="color: #ffd700;">bean</span>) {  
     LocationManager locmanag = (<span style="color: #ffff00; font-size: 105%;">LocationManager</span>) context  
         .getSystemService(<span style="color: #7fffd4;">Context</span>.LOCATION_SERVICE);  
     <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20851;&#38190;&#20195;&#30721;</span>
     <span style="color: #ffff00; font-size: 105%;">String</span> <span style="color: #ffd700;">mock</span> = <span style="color: #7fffd4;">LocationManager</span>.GPS_PROVIDER;  
     locmanag.addTestProvider(mock, <span style="color: #7fffd4;">false</span>, <span style="color: #7fffd4;">true</span>, <span style="color: #7fffd4;">false</span>, <span style="color: #7fffd4;">false</span>, <span style="color: #7fffd4;">false</span>, <span style="color: #7fffd4;">false</span>,  
         <span style="color: #7fffd4;">false</span>, 0, 5);  
     locmanag.setTestProviderEnabled(mock, <span style="color: #7fffd4;">true</span>);  
     <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#26500;&#36896;&#20301;&#32622;&#20449;&#24687;</span>
     <span style="color: #ffff00; font-size: 105%;">Location</span> <span style="color: #ffd700;">loc</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">Location</span>(mock);  
     loc.setTime(System.currentTimeMillis());  
     loc.setLatitude(Double.parseDouble(bean.getLat()));  
     loc.setLongitude(Double.parseDouble(bean.getLon()));  
     loc.setAccuracy(<span style="color: #7fffd4;">Criteria</span>.ACCURACY_FINE);<span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">&#31934;&#30830;&#24230;  </span>
     loc.setElapsedRealtimeNanos(SystemClock.elapsedRealtimeNanos());<span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">&#23454;&#26102;&#36816;&#34892;&#26102;&#38388;  </span>
     locmanag.setTestProviderStatus(mock, <span style="color: #7fffd4;">LocationProvider</span>.AVAILABLE, <span style="color: #7fffd4;">null</span>,  
         System.currentTimeMillis());  
     <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20301;&#32622;&#20449;&#24687;&#26893;&#20837;</span>
     locmanag.setTestProviderLocation(mock, loc);  
 }  
</pre>
</div></li>
<li>在android手机设置请确保您已在“允许模拟位置”复选框打勾 ；</li>
<li>像普通使用gps定位一样的使用onLocationChanged()会被系统回调。</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-org45443d0" class="outline-3">
<h3 id="org45443d0"><span class="section-number-3">3.10</span> bt</h3>
<div class="outline-text-3" id="text-3-10">
</div>
<div id="outline-container-org6c5c1ef" class="outline-4">
<h4 id="org6c5c1ef"><span class="section-number-4">3.10.1</span> 概念</h4>
<div class="outline-text-4" id="text-3-10-1">
<ul class="org-ul">
<li>BluetoothAdapter：代表手机本地的蓝牙模块，BluetoothAdapter是所有蓝牙互操
作的入口。使用它，你可以discover其他的蓝牙设备，轮询已经bonded(paired)的
设备列表，使用MAC地址实例化一个远端Bluetoothdevice，生成一个
BluetoothServerSocket来监听其他设备。</li>
<li>BluetoothDevice：代表一个远端的蓝牙设备，本地蓝牙模块使用BluetoothDevice
通过一个BluetoothSocket来请求一个远端设备连接或者请求远端设备的设备名，地
址，绑定状态等；</li>
<li>BluetoothSocket：代表一个接口，通过这个接口应用程序可以利用InputStream和
OutputStream来和其他蓝牙设备交换数据；</li>
<li>BluetoothServerSocket：代表一个server socket，它用于监听收到的请求。为了
连接两个android设备，某个设备必须开启一个server socket，当一个远端蓝牙设
备发起一个连接请求到这个设备时，这个设备如果接受这个请求，它的
BluetoothServerSocket会返回一个BluetoothSocket给它；</li>
<li>BluetoothClass：用于描述蓝牙设备的一般属性和能力。它是只读的属性集，定义
了设备的主次设备类和它的服务，然而这个BluetoothClass并不是这个蓝牙设备支
持的所有蓝牙profile和services的描述；</li>
<li>BluetoothProfile：是一个蓝牙profile的接口；</li>
<li>BluetoothHeadset：提供对手机上蓝牙耳机的支持，它包含蓝牙耳机和免提的
profile；</li>
<li>BluetoothA2dp：定义了通过蓝牙连接的设备间传输音频流的质量，A2DP表示
Advanced Audio Distribution Profile；</li>
<li>BluetoothHealth：代表了Health Device Profile；</li>
<li>BluetoothHealthCallback：它是一个BluetoothHealth回调的抽象类。这个回调处
理接收到的应用程序注册状态以及蓝牙通道状态的更新；</li>
<li>BluetoothHealthAppConfiguration：代表应用程序关于BluetoothHealth的配置；</li>
<li>BluetoothProfile.ServiceListener：它是一个通知BluetoothProfile IPC客户端
的接口，通知对service连接的状态；</li>
</ul>
</div>
</div>
<div id="outline-container-org90e9629" class="outline-4">
<h4 id="org90e9629"><span class="section-number-4">3.10.2</span> 蓝牙权限</h4>
<div class="outline-text-4" id="text-3-10-2">
<p>
应用程序要用蓝牙功能，必须要声明蓝牙权限“BLUETOOTH”。代码如下
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">manifest</span> ... &gt;
  &lt;<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">uses-permission</span> <span style="color: #87cefa; text-decoration: underline;">android</span>:<span style="color: #ffd700;">name</span>=<span style="color: #ffa07a;">"android.permission.BLUETOOTH"</span> /&gt;
  ...
&lt;/<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">manifest</span>&gt;
</pre>
</div>
<p>
如果应用程序还需要“初始化设备发现”，操作“蓝牙设置”，那还需要声明
“BLUETOOTH\<sub>ADMIN</sub>”的权限，另外这个权限可以赋予一些功能，比如发现本地蓝牙
设备，修改蓝牙设置；如有要使用“BLUETOOTH\<sub>ADMIN</sub>”的声明，还必须要有上面的
“BLUETOOTH”权限。 
</p>
</div>
</div>
<div id="outline-container-orga256f2e" class="outline-4">
<h4 id="orga256f2e"><span class="section-number-4">3.10.3</span> 设置蓝牙</h4>
<div class="outline-text-4" id="text-3-10-3">
<p>
如果要使用蓝牙，需检查手机是否支持蓝牙，并且要保证已经使能。这需要两步操作。 
</p>
<ol class="org-ol">
<li><p>
获取BluetoothAdapter:BluetoothAdapter是所有蓝牙活动所必须要求的。要获得
BluetoothAdapter可以调用getDefaultAdapter()方法，它将返回一个
BluetoothAdapter，如果返回null，代表设备不支持蓝牙，代码如下。 
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">BluetoothAdapter</span> <span style="color: #ffd700;">mBluetoothAdapter</span> = BluetoothAdapter.getDefaultAdapter();
<span style="color: #ffb6c1; font-size: 105%;">if</span> (mBluetoothAdapter == <span style="color: #7fffd4;">null</span>) {
     <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Device does not support Bluetooth</span>
}
</pre>
</div></li>
<li><p>
使能蓝牙:使用蓝牙前要确定蓝牙是否已经使能，使用isEnable()方法，如果返回
false，表示蓝牙是禁能的。要请求蓝牙开启，可以使用
startActivityForResult()带上ACTION\<sub>REQUEST</sub>\<sub>ENABLE的intent</sub>，这样将会触
发一个系统设置的请求来使能蓝牙，代码如下, 将会出现一个对话框请求用户使能
蓝牙，用户可以允许也可以不允许，ACTION\<sub>REQUEST</sub>\<sub>ENABLE是一个本地定义的</sub>
整数(大于0)，并且会在onActivityResult()回调方法中返回作为requestCode参数，
如果使能蓝牙成功，Activity会在onActivityResult()收到RESULT\<sub>OK结果码</sub>，否
则结果码是RESULT\<sub>CANCEL</sub> 
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">if</span> (!mBluetoothAdapter.isEnabled()) {
 <span style="color: #ffff00; font-size: 105%;">Intent</span> <span style="color: #ffd700;">enableBtIntent</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">Intent</span>(<span style="color: #7fffd4;">BluetoothAdapter</span>.ACTION_REQUEST_ENABLE);
 startActivityForResult(enableBtIntent, REQUEST_ENABLE_BT);
}
</pre>
</div>
<p>
同样，应用程序还可以监听ACTION\<sub>STATE</sub>\<sub>CHANGED广播intent</sub>，这个intent会在
蓝牙状态变化时被系统广播出来， 这个广播包含指示蓝牙新旧状态的额外域：
EXTRA\<sub>STATE和EXTRA</sub>\<sub>PREVIOUS</sub>\<sub>STATE</sub>。这2个域的值可能取
STATE\<sub>TURNING</sub>\<sub>ON</sub>, STATE\<sub>ON,STATE</sub>\<sub>OFF</sub>，STATE\<sub>TURNING</sub>\<sub>OFF</sub>。   
</p></li>
</ol>
</div>
</div>
<div id="outline-container-org264904f" class="outline-4">
<h4 id="org264904f"><span class="section-number-4">3.10.4</span> 寻找设备</h4>
<div class="outline-text-4" id="text-3-10-4">
<p>
可以使用BluetoothAdapter搜索远端设备，要么通过“搜索设备”，要么通过轮询配
对绑定列表里面的设备。搜索设备通过一个扫描过程搜索周边的蓝牙设备并向他们请
求一些信息(这个过程大概有“discovering”，“inquiring”，“scanning”)。然
而这个被搜索到的设备只有在使能了可发现属性后，才会回应这些请求，回应信息大
概有设备名，类别，唯一的MAC地址。有了这些后，搜索设备的发起方就可以选择一个
设备初始化一个链接操作。一旦和远端设备进行链接，并且是首次链接，一个配对请
求就会自动的呈现给用户。当配对过程完成后，远端设备的基本信息(比如设备名，类
别，MAC)就会被保存下来并能够通过蓝牙API读取，使用一个已知的MAC地址可以在任
何时候发起连接操作而不需要再进行搜索过程。要记住的是已配对和已连接有所不同，
配对意味着两个设备知道互相的存在，拥有一个用于认证的共享的链接密钥
(link-key)，能够建立一个加密的链路。连接意味着设备间当前共享一个RFCOMM通道，
可以互相进行数据传输。当前的android蓝牙API要求设备在建立RFCOMM通道前做配对
操作。(配对是在使用蓝牙API初始化一个加密连接时自动进行)下面的章节描述的是已
经配对设备如何进行寻找设备，或者使用设备搜索过程来搜索设备。 
</p>
</div>
</div>
<div id="outline-container-orgcb937c9" class="outline-4">
<h4 id="orgcb937c9"><span class="section-number-4">3.10.5</span> 轮询已配对的设备</h4>
<div class="outline-text-4" id="text-3-10-5">
<p>
在进行搜索设备前，先轮询已配对设备的集合看看是否有我们需要的设备，调用
BluetoothAdapter的getBondedDevices()即可。它将返回一个已配对设备的集合。比
如，可以轮询所有的设备并使用ArrayAdapter将设备名展示给用户。 
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">Set</span>&lt;<span style="color: #ffff00; font-size: 105%;">BluetoothDevice</span>&gt; <span style="color: #ffd700;">pairedDevices</span> = mBluetoothAdapter.getBondedDevices();
<span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">If there are paired devices</span>
<span style="color: #ffb6c1; font-size: 105%;">if</span> (pairedDevices.size() &gt; 0) {
    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Loop through paired devices</span>
    <span style="color: #ffb6c1; font-size: 105%;">for</span> (<span style="color: #ffff00; font-size: 105%;">BluetoothDevice</span> <span style="color: #ffd700;">device</span> : pairedDevices) {
    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Add the name and address to an array adapter to show in a ListView</span>
    mArrayAdapter.add(device.getName() + <span style="color: #ffa07a;">"\n"</span> + device.getAddress());
    }
}
</pre>
</div>
<p>
为了初始化一个连接，仅需要从BluetoothDevice对象中获得MAC地址。
</p>
</div>
</div>
<div id="outline-container-orgecc16dd" class="outline-4">
<h4 id="orgecc16dd"><span class="section-number-4">3.10.6</span> 搜索设备</h4>
<div class="outline-text-4" id="text-3-10-6">
<p>
要发起搜索设备，只需要简单的调用startDiscovery().这个过程是异步的，调用这个
方法会立刻返回一个布尔值指示搜索是否成功启动。搜索过程常常先inquiry scan大
约12秒，再使用page scan去获取每个设备的蓝牙设备名。应用程序注册一个
BroadcastReceiver来接收“ACTION\<sub>FOUND</sub>”的intent，对于每个搜索到的设备，系
统将会广播这个intent，这个intent会包含额外域EXTRA\<sub>DEVICE和EXTRA</sub>\<sub>CLASS</sub>，对
应着“BluetoothDevice”和“BluetoothClass”。代码如下 
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Create a BroadcastReceiver for ACTION_FOUND</span>
<span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffb6c1; font-size: 105%;">final</span> <span style="color: #ffff00; font-size: 105%;">BroadcastReceiver</span> <span style="color: #ffd700;">mReceiver</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">BroadcastReceiver</span>() {
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> onReceive(<span style="color: #ffff00; font-size: 105%;">Context</span> <span style="color: #ffd700;">context</span>, <span style="color: #ffff00; font-size: 105%;">Intent</span> <span style="color: #ffd700;">intent</span>) {
    <span style="color: #ffff00; font-size: 105%;">String</span> <span style="color: #ffd700;">action</span> = intent.getAction();
    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">When discovery finds a device</span>
    <span style="color: #ffb6c1; font-size: 105%;">if</span> (<span style="color: #7fffd4;">BluetoothDevice</span>.ACTION_FOUND.equals(action)) {
        <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Get the BluetoothDevice object from the Intent</span>
        <span style="color: #ffff00; font-size: 105%;">BluetoothDevice</span> <span style="color: #ffd700;">device</span> = intent.getParcelableExtra(<span style="color: #7fffd4;">BluetoothDevice</span>.EXTRA_DEVICE);
        <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Add the name and address to an array adapter to show in a ListView</span>
        mArrayAdapter.add(device.getName() + <span style="color: #ffa07a;">"\n"</span> + device.getAddress());
    }
    }
};
<span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Register the BroadcastReceiver</span>
<span style="color: #ffff00; font-size: 105%;">IntentFilter</span> <span style="color: #ffd700;">filter</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">IntentFilter</span>(<span style="color: #7fffd4;">BluetoothDevice</span>.ACTION_FOUND);
registerReceiver(mReceiver, filter); <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Don't forget to unregister during onDestroy</span>
</pre>
</div>
<p>
警告：做设备搜索是个非常耗费系统资源的操作，一旦发现了目标设备，确保在连接
前使用cancelDiscovery()停止掉搜索过程，并且如果已经保持了一个连接，再搜索操
作势必会减少连接的可用带宽，所以当连接设备时最好不要做搜索操作。 
</p>
</div>
</div>
<div id="outline-container-org4979c71" class="outline-4">
<h4 id="org4979c71"><span class="section-number-4">3.10.7</span> 使能可发现性</h4>
<div class="outline-text-4" id="text-3-10-7">
<p>
如果愿意本地设备被其他设备搜索到，可使用ACTION\<sub>REQUEST</sub>\<sub>DISCOVERABLE的</sub>
intent调用startActivityForResult(Intent，int)，它将向系统发起一个请求进行可
发现性设置。默认将保持120秒时间，也可以通过给intent增加
EXTRA\<sub>DISCOVERABLE</sub>\<sub>DURATION的额外域值来改变这个持续时间</sub>。这个域值最大可设
3600秒，0代表始终可发现。设置为其他值将自动设成120秒，下面代码设置持续时间
为300秒。 
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">Intent</span> <span style="color: #ffd700;">discoverableIntent</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span>
<span style="color: #ffff00; font-size: 105%;">Intent</span>(<span style="color: #7fffd4;">BluetoothAdapter</span>.ACTION_REQUEST_DISCOVERABLE);
discoverableIntent.putExtra(<span style="color: #7fffd4;">BluetoothAdapter</span>.EXTRA_DISCOVERABLE_DURATION, 300);
startActivity(discoverableIntent);
</pre>
</div>
<p>
系统将显示一个对话框来请求设备可发现性的用户权限。如果用户选择YES，设备将保
持这个时间的可发现性，activity也将收到一个回调onActivityResult(), 里面会附
带一个等于持续时间的result code。如果选择了NO，或者发送错误，这个result
code将是RESULT\<sub>CANCEL</sub>。<br />
注意：如果设备没有开启蓝牙，而使能了蓝牙可发现性，将会自动的开启蓝牙。<br />
如果希望在系统的可发现性改变时被通知，可以注册一个BroadcastReceiver来监听
ACTION\<sub>SCAN</sub>\<sub>MODE</sub>\<sub>CHANGED的intent</sub>。这个intent将包含两个额外域，
EXTRA\<sub>SCAN</sub>\<sub>MODE和EXTRA</sub>\<sub>PREVIOUS</sub>\<sub>SCAN</sub>\<sub>MODE</sub>，对应着新旧扫描模式。其可能
值有SCAN\<sub>MODE</sub>\<sub>CONNECTABLE</sub>\<sub>DISCOVERABLE</sub>, SCAN\<sub>MODE</sub>\<sub>CONNECTABLE</sub>, 或
SCAN\<sub>MODE</sub>\<sub>NONE</sub>，指示了设备要么处于可发现模式，不处于可发现模式但是可以接
收连接请求，既不处于可发现模式也不能接收连接请求。如果只是想初始化一个到远
端设备的链接，可以不用开启可发现模式。使能可发现模式仅仅只是在应用程序需要
主导一个可以接收连接的server socket，因为远端设备在初始化一个连接前必须能够
发现这个设备。 
</p>
</div>
</div>
<div id="outline-container-org9579bd0" class="outline-4">
<h4 id="org9579bd0"><span class="section-number-4">3.10.8</span> 连接设备</h4>
<div class="outline-text-4" id="text-3-10-8">
<p>
为了应用程序在设备间建立连接，必须实现服务端和客户端机制，因为一个设备必须
开启server socket，另一个设备必须初始化这个连接(使用设备的MAC地址)。当服务
端和客户端在共同的RFCOMM通道都有了已连接的BluetoothSocket则可认为两者已连接。
从此后，每个设备获得输入输出流和数据传输就可开始，这部分要点在后面介绍。<br />
服务端设备和客户端设备获得BluetoothSocket的方式不同。服务端当有一个连接进入
被接受时就获得了，而客户端当开启一个RFCOMM通道给服务端时就获得了。 <br />
注意：如果两个设备之前没有配对过，android framework将会自动显示一个配对请求
通知或者对话框给用户(就是那个带密码的对话框)。这样当尝试连接设备是，应用程
序不需要关注设备是否配对过。RFCOMM连接尝试将会被阻塞直到用户成功配对，或者
用户拒绝配对，或者配对失败而超时。 
</p>
</div>
</div>
<div id="outline-container-org873d6fe" class="outline-4">
<h4 id="org873d6fe"><span class="section-number-4">3.10.9</span> 服务端的连接</h4>
<div class="outline-text-4" id="text-3-10-9">
<p>
当要连接两个设备时，其中一个必须作为一个服务端保存一个打开的
BluetoothServerSocket。它的目的是监听进来的链接请求，并且当接受时，提供一个
可连接的BluetoothSocket。当BluetoothSocket已经从BluetoothServerSocket获得后，
BluetoothServerSocket就可以丢弃了，除非还想介入其他连接。 
</p>
<ol class="org-ol">
<li>通过调用listenUsingRfcommWithServiceRecord(String, UUID)来获得
BluetoothServerSocket。这个String是服务的标示名，系统会自动将它写入
SDP(service discovery protocol)的数据库入口(标示名可以随意编写，并且可以
直接采用应用程序的名字)。UUID也同样被包含在数据库入口并且是同客户端的连
接协议的基础。当客户端试图连接这个设备，他会携带一个UUID，唯一代表了它想
连接的服务 。</li>
<li>开始调用accept()来监听连接请求。这是一个阻塞调用。他会立刻返回不管连接是
否被接受。只有当远端设备使用了能够匹配这个注册的在监听的服务端Socket的
UUID来发出连接请求，连接才回被接受。当连接成功后，accept()会返回一个已连
接的BluetoothSocket。</li>
<li>除非想继续接收连接请求，否则调用close().这会释放服务端Socket和它的资源，
但是不会关闭被accept()返回的BluetoothSocket。与TCP/IP不同的是，RFCOMM在
同一时刻每个通道只允许一个连接的客户端，所以在大多数情况在接受了连接请求
后立刻调用BluetoothServiceSocket的close()。</li>
</ol>
<p>
accept()调用不应该在主Activity的UI线程上执行，因为它是阻塞调用会阻止程序的
交互操作。常常使用一个新的线程来做所有的BluetoothServerSocket和
BluetoothSocket的工作。要退出accept()这样的阻塞调用，可以从其他的线程调用
BluetoothServerSocket(或BluetoothSocket)的close()，阻塞调用会立刻返回。注意
BluetoothServerSocket和BluetoothSocket所有的方法都是线程安全的。 <br />
代码实例：这里有一个简单线程调用，用于服务模块接收进来的连接。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffb6c1; font-size: 105%;">class</span> <span style="color: #ffff00; font-size: 105%;">AcceptThread</span> <span style="color: #ffb6c1; font-size: 105%;">extends</span> <span style="color: #ffff00; font-size: 105%;">Thread</span> {
    <span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffb6c1; font-size: 105%;">final</span> <span style="color: #ffff00; font-size: 105%;">BluetoothServerSocket</span> <span style="color: #ffd700;">mmServerSocket</span>;

    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">AcceptThread</span>() {
    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Use a temporary object that is later assigned to mmServerSocket,</span>
    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">because mmServerSocket is final</span>
    <span style="color: #ffff00; font-size: 105%;">BluetoothServerSocket</span> <span style="color: #ffd700;">tmp</span> = <span style="color: #7fffd4;">null</span>;
    <span style="color: #ffb6c1; font-size: 105%;">try</span> {
        <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">MY_UUID is the app's UUID string, also used by the client code</span>
        tmp = mBluetoothAdapter.listenUsingRfcommWithServiceRecord(NAME, MY_UUID);
    } <span style="color: #ffb6c1; font-size: 105%;">catch</span> (<span style="color: #ffff00; font-size: 105%;">IOException</span> <span style="color: #ffd700;">e</span>) { }
    mmServerSocket = tmp;
    }

    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">run</span>() {
    <span style="color: #ffff00; font-size: 105%;">BluetoothSocket</span> <span style="color: #ffd700;">socket</span> = <span style="color: #7fffd4;">null</span>;
    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Keep listening until exception occurs or a socket is returned</span>
    <span style="color: #ffb6c1; font-size: 105%;">while</span> (<span style="color: #7fffd4;">true</span>) {
        <span style="color: #ffb6c1; font-size: 105%;">try</span> {
        socket = mmServerSocket.accept();
        } <span style="color: #ffb6c1; font-size: 105%;">catch</span> (<span style="color: #ffff00; font-size: 105%;">IOException</span> <span style="color: #ffd700;">e</span>) {
        <span style="color: #ffb6c1; font-size: 105%;">break</span>;
        }
        <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">If a connection was accepted</span>
        <span style="color: #ffb6c1; font-size: 105%;">if</span> (socket != <span style="color: #7fffd4;">null</span>) {
        <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Do work to manage the connection (in a separate thread)</span>
        manageConnectedSocket(socket);
        mmServerSocket.close();
        <span style="color: #ffb6c1; font-size: 105%;">break</span>;
        }
    }
    }

    <span style="color: #ffa07a;">/** Will cancel the listening socket, and cause the thread to finish */</span>
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">cancel</span>() {
    <span style="color: #ffb6c1; font-size: 105%;">try</span> {
        mmServerSocket.close();
    } <span style="color: #ffb6c1; font-size: 105%;">catch</span> (<span style="color: #ffff00; font-size: 105%;">IOException</span> <span style="color: #ffd700;">e</span>) { }
    }
}
</pre>
</div>
<p>
在这个例子中，只打算接收一个连接请求，所以一旦连接被接受并且BluetoothSocket被接受，应用程序发送一个已接受的
BluetoothSocket给一个单独的线程，然后关闭BluetoothServerSocket并且跳出循环。
注意当accept()返回BluetoothSocket后，socket就已经连接，所以不应该再调用connect()(像在客户端侧做的那样)。
manageConnectedSocket()在应用中是个虚方法，他会初始化线程来传输数据，如前面介绍说的。
最好一旦监听完连接请求后，就关闭BluetoothServerSocket。在这个例子中，一旦BluetoothSocket()被接受，close()就被调用。当需
要在服务端Socket停止监听时，也可以在线程中提供一个public方法关闭这个private的BluetoothSocket。
</p>
</div>
</div>
<div id="outline-container-org3b45935" class="outline-4">
<h4 id="org3b45935"><span class="section-number-4">3.10.10</span> 客户端的连接</h4>
<div class="outline-text-4" id="text-3-10-10">
<p>
为了初始化一个到远端设备(它保持着一个开放的服务端Socket)的连接，必须首先获
得一个代表远端设备的BluetoothDevice对象(上面有介绍)。然后用这个对象获取一个
BluetoothSocket并初始化连接。基本流程如下。 
</p>
<ol class="org-ol">
<li>调用createRfcommSocketToServiceRecord(UUID)使用BluetoothDevice获取一个
BluetoothSocket。这样会初始化一个BluetoothSocket连接到BluetoothDevice。
这个传入的UUID和服务端设备调用BluetoothServiceSocket的
listenUsingRfcommWithServiceRecord(String, UUID)使用的UUID匹配。在服务端
和客户端应用程序中使用这个相同的UUID是一种硬编码。</li>
<li>调用connect()初始化连接。一旦调用这个方法，系统将会发起一个SDP搜寻远端设
备以匹配这个UUID。如果搜寻成功并且远端设备接受了这个连接，就会在连接期间
共享这个RFCOMM通道，并且connect()返回。这个方法是阻塞调用。不管任何原因，
如果这个连接失败或者connect()调用超时(大概12秒)，那么它会抛出一个异常。
因为connect()是个阻塞调用，连接过程应该总是在一个独立于主Activity线程的
线程中使用。</li>
</ol>
<p>
注意：应该确保当调用connect()时，设备没有进行搜索操作。如果在继续搜索，那么
连接的尝试将会强烈的减慢并失败。代码实例：下面是初始化蓝牙连接的线程实例。 
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffb6c1; font-size: 105%;">class</span> <span style="color: #ffff00; font-size: 105%;">ConnectThread</span> <span style="color: #ffb6c1; font-size: 105%;">extends</span> <span style="color: #ffff00; font-size: 105%;">Thread</span> {
    <span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffb6c1; font-size: 105%;">final</span> <span style="color: #ffff00; font-size: 105%;">BluetoothSocket</span> <span style="color: #ffd700;">mmSocket</span>;
    <span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffb6c1; font-size: 105%;">final</span> <span style="color: #ffff00; font-size: 105%;">BluetoothDevice</span> <span style="color: #ffd700;">mmDevice</span>;

    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">ConnectThread</span>(<span style="color: #ffff00; font-size: 105%;">BluetoothDevice</span> <span style="color: #ffd700;">device</span>) {
    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Use a temporary object that is later assigned to mmSocket,</span>
    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">because mmSocket is final</span>
    <span style="color: #ffff00; font-size: 105%;">BluetoothSocket</span> <span style="color: #ffd700;">tmp</span> = <span style="color: #7fffd4;">null</span>;
    mmDevice = device;

    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Get a BluetoothSocket to connect with the given BluetoothDevice</span>
    <span style="color: #ffb6c1; font-size: 105%;">try</span> {
        <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">MY_UUID is the app's UUID string, also used by the server code</span>
        tmp = device.createRfcommSocketToServiceRecord(MY_UUID);
    } <span style="color: #ffb6c1; font-size: 105%;">catch</span> (<span style="color: #ffff00; font-size: 105%;">IOException</span> <span style="color: #ffd700;">e</span>) { }
    mmSocket = tmp;
    }

    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">run</span>() {
    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Cancel discovery because it will slow down the connection</span>
    mBluetoothAdapter.cancelDiscovery();

    <span style="color: #ffb6c1; font-size: 105%;">try</span> {
        <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Connect the device through the socket. This will block</span>
        <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">until it succeeds or throws an exception</span>
        mmSocket.connect();
    } <span style="color: #ffb6c1; font-size: 105%;">catch</span> (<span style="color: #ffff00; font-size: 105%;">IOException</span> <span style="color: #ffd700;">connectException</span>) {
        <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Unable to connect; close the socket and get out</span>
        <span style="color: #ffb6c1; font-size: 105%;">try</span> {
        mmSocket.close();
        } <span style="color: #ffb6c1; font-size: 105%;">catch</span> (<span style="color: #ffff00; font-size: 105%;">IOException</span> <span style="color: #ffd700;">closeException</span>) { }
        <span style="color: #ffb6c1; font-size: 105%;">return</span>;
    }

    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Do work to manage the connection (in a separate thread)</span>
    manageConnectedSocket(mmSocket);
    }

    <span style="color: #ffa07a;">/** Will cancel an in-progress connection, and close the socket */</span>
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">cancel</span>() {
    <span style="color: #ffb6c1; font-size: 105%;">try</span> {
        mmSocket.close();
    } <span style="color: #ffb6c1; font-size: 105%;">catch</span> (<span style="color: #ffff00; font-size: 105%;">IOException</span> <span style="color: #ffd700;">e</span>) { }
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc6881b2" class="outline-4">
<h4 id="orgc6881b2"><span class="section-number-4">3.10.11</span> 管理连接</h4>
<div class="outline-text-4" id="text-3-10-11">
<p>
当成功的链接两个设备，每个都会拥有一个已连接的BluetoothSocket。从此将会有趣
了因为可以在设备间分享数据。使用BluetoothSocket，这个传输任意数据的过程将会
很简单。 
</p>
<ol class="org-ol">
<li>获取InputStream和OutputStream，他们通过Socket处理传输，对应着使用
getInputStream()和getOutputStream()。</li>
<li>使用read(byte[])和write(byte[])读写数据流。</li>
</ol>
<p>
很简单，当然有一些实现细节需要考虑。首先也是最重要的，需要使用一个专门的线
程来对所有的流进行读写。这个很重要，因为read(byte[])和write(byte[])两个方法
都是阻塞调用。read(byte[])调用时会被阻塞，除非从流中读到了一些数据，
write(byte[])常常不会被阻塞，但是当远端设备没有调用read(byte[])迅速的读走数
据，并且交互buffer已经满了，而进行流控时会被阻塞。所以线程中的主循环应该专
门用于读取InputStream。线程中可以有一个单独的public方法来初始化OutputStream
的写入。代码实例。 
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffb6c1; font-size: 105%;">class</span> <span style="color: #ffff00; font-size: 105%;">ConnectedThread</span> <span style="color: #ffb6c1; font-size: 105%;">extends</span> <span style="color: #ffff00; font-size: 105%;">Thread</span> {
    <span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffb6c1; font-size: 105%;">final</span> <span style="color: #ffff00; font-size: 105%;">BluetoothSocket</span> <span style="color: #ffd700;">mmSocket</span>;
    <span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffb6c1; font-size: 105%;">final</span> <span style="color: #ffff00; font-size: 105%;">InputStream</span> <span style="color: #ffd700;">mmInStream</span>;
    <span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #ffb6c1; font-size: 105%;">final</span> <span style="color: #ffff00; font-size: 105%;">OutputStream</span> <span style="color: #ffd700;">mmOutStream</span>;

    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">ConnectedThread</span>(<span style="color: #ffff00; font-size: 105%;">BluetoothSocket</span> <span style="color: #ffd700;">socket</span>) {
    mmSocket = socket;
    <span style="color: #ffff00; font-size: 105%;">InputStream</span> <span style="color: #ffd700;">tmpIn</span> = <span style="color: #7fffd4;">null</span>;
    <span style="color: #ffff00; font-size: 105%;">OutputStream</span> <span style="color: #ffd700;">tmpOut</span> = <span style="color: #7fffd4;">null</span>;

    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Get the input and output streams, using temp objects because</span>
    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">member streams are final</span>
    <span style="color: #ffb6c1; font-size: 105%;">try</span> {
        tmpIn = socket.getInputStream();
        tmpOut = socket.getOutputStream();
    } <span style="color: #ffb6c1; font-size: 105%;">catch</span> (<span style="color: #ffff00; font-size: 105%;">IOException</span> <span style="color: #ffd700;">e</span>) { }

    mmInStream = tmpIn;
    mmOutStream = tmpOut;
    }

    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">run</span>() {
    <span style="color: #ffff00; font-size: 105%;">byte</span>[] <span style="color: #ffd700;">buffer</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">byte</span>[1024];  <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">buffer store for the stream</span>
    <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">bytes</span>; <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">bytes returned from read()</span>

    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Keep listening to the InputStream until an exception occurs</span>
    <span style="color: #ffb6c1; font-size: 105%;">while</span> (<span style="color: #7fffd4;">true</span>) {
        <span style="color: #ffb6c1; font-size: 105%;">try</span> {
        <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Read from the InputStream</span>
        bytes = mmInStream.read(buffer);
        <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Send the obtained bytes to the UI activity</span>
        mHandler.obtainMessage(MESSAGE_READ, bytes, -1, buffer)
            .sendToTarget();
        } <span style="color: #ffb6c1; font-size: 105%;">catch</span> (<span style="color: #ffff00; font-size: 105%;">IOException</span> <span style="color: #ffd700;">e</span>) {
        <span style="color: #ffb6c1; font-size: 105%;">break</span>;
        }
    }
    }

    <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">Call this from the main activity to send data to the remote device */</span>
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">write</span>(<span style="color: #ffff00; font-size: 105%;">byte</span>[] <span style="color: #ffd700;">bytes</span>) {
    <span style="color: #ffb6c1; font-size: 105%;">try</span> {
        mmOutStream.write(bytes);
    } <span style="color: #ffb6c1; font-size: 105%;">catch</span> (<span style="color: #ffff00; font-size: 105%;">IOException</span> <span style="color: #ffd700;">e</span>) { }
    }

    <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">Call this from the main activity to shutdown the connection */</span>
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">cancel</span>() {
    <span style="color: #ffb6c1; font-size: 105%;">try</span> {
        mmSocket.close();
    } <span style="color: #ffb6c1; font-size: 105%;">catch</span> (<span style="color: #ffff00; font-size: 105%;">IOException</span> <span style="color: #ffd700;">e</span>) { }
    }
}
</pre>
</div>
<p>
构造函数获得一个必要的流，一经执行线程将会等待InputStream接收数据。当read(byte[])从流里返回一些数据时，将会使用父类的一
个成员Handler来将数据发送给主Activity。然后它将返回并且等待更多的数据从流里获得。
对外发送数据就和从主Activity中调用线程的write()方法一样简单，只需要传入需要发送的数据。这个方法会调用write(byte[])来发送
数据给远端设备。
线程的cancel()方法很重要，链接可以在任何时候通过关闭BluetoothSocket来中断。当使用完蓝牙连接时调用它是很有必要的。
</p>
</div>
</div>
<div id="outline-container-org7b60e1c" class="outline-4">
<h4 id="org7b60e1c"><span class="section-number-4">3.10.12</span> 使用Profiles</h4>
<div class="outline-text-4" id="text-3-10-12">
<p>
从android3.0开始，蓝牙API包含了对蓝牙Profile的支持。Bluetooth Profile是个无
线接口，以蓝牙为基础沟通不同的设备。免提Profile就是一例。对于手机连接到无线
耳机，两个设备都必须支持免提Profile。可以实现接口BluetoothProfile写入一个你
自己的类别来支持一个特定的蓝牙Profile。android蓝牙API提供下面蓝牙Profile的
实现。 
</p>
<ol class="org-ol">
<li>Headset：耳机；</li>
<li>A2DP：Advanced Audio Distribution Profile；</li>
<li>Health Device：android4.0以上(API level 14)</li>
</ol>
<p>
下面是使用这些Profile的简单步骤。
</p>
<ol class="org-ol">
<li>获取默认的Adapter(BluetoothAdapter)；</li>
<li>使用getProfileProxy()来和这个Profile相关的代理Profile建立连接。下面的例
子展示代理Profile对象是BluetoothHeadset的一个实例。</li>
<li>设置BluetoothProfile.ServiceListener。这个Listener当连接或者断开连接到服
务端时通知BluetoothProfile进程客户端。</li>
<li>在onServiceConnected()中获得代理Profile对象的句柄。</li>
<li>一旦有代理Profile对象，就可以利用它监视连接状态和做关于Profile的其他操作。</li>
</ol>
<p>
代码实例，下面的代码片段展示了怎样连接到BluetoothHeadset代理对象。
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">BluetoothHeadset</span> <span style="color: #ffd700;">mBluetoothHeadset</span>;

<span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Get the default adapter</span>
<span style="color: #ffff00; font-size: 105%;">BluetoothAdapter</span> <span style="color: #ffd700;">mBluetoothAdapter</span> = BluetoothAdapter.getDefaultAdapter();

<span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Establish connection to the proxy.</span>
mBluetoothAdapter.getProfileProxy(context, mProfileListener, <span style="color: #7fffd4;">BluetoothProfile</span>.HEADSET);

<span style="color: #ffb6c1; font-size: 105%;">private</span> <span style="color: #7fffd4;">BluetoothProfile</span>.<span style="color: #ffff00; font-size: 105%;">ServiceListener</span> <span style="color: #ffd700;">mProfileListener</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #7fffd4;">BluetoothProfile</span>.<span style="color: #ffff00; font-size: 105%;">ServiceListener</span>() {
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> onServiceConnected(<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">profile</span>, <span style="color: #ffff00; font-size: 105%;">BluetoothProfile</span> <span style="color: #ffd700;">proxy</span>) {
    <span style="color: #ffb6c1; font-size: 105%;">if</span> (profile == <span style="color: #7fffd4;">BluetoothProfile</span>.HEADSET) {
        mBluetoothHeadset = (<span style="color: #ffff00; font-size: 105%;">BluetoothHeadset</span>) proxy;
    }
    }
    <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">onServiceDisconnected</span>(<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">profile</span>) {
    <span style="color: #ffb6c1; font-size: 105%;">if</span> (profile == <span style="color: #7fffd4;">BluetoothProfile</span>.HEADSET) {
        mBluetoothHeadset = <span style="color: #7fffd4;">null</span>;
    }
    }
};
<span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">... call functions on mBluetoothHeadset</span>
<span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">Close proxy connection after use.</span>
mBluetoothAdapter.closeProfileProxy(mBluetoothHeadset);
</pre>
</div>
</div>
</div>
<div id="outline-container-orgccbebe1" class="outline-4">
<h4 id="orgccbebe1"><span class="section-number-4">3.10.13</span> 制造商自定义AT指令</h4>
<div class="outline-text-4" id="text-3-10-13">
<p>
从android3.0开始，应用程序就能注册接收预定义的由Headset发出的系统通知。 
</p>
</div>
</div>
<div id="outline-container-orgafba20e" class="outline-4">
<h4 id="orgafba20e"><span class="section-number-4">3.10.14</span> 健康设备Profile</h4>
<div class="outline-text-4" id="text-3-10-14">
<p>
从android4.0开始，引入对健康设备Profile(HDP)的支持。
</p>
</div>
</div>
</div>
<div id="outline-container-org7aaea11" class="outline-3">
<h3 id="org7aaea11"><span class="section-number-3">3.11</span> ble</h3>
</div>
<div id="outline-container-org51b68b1" class="outline-3">
<h3 id="org51b68b1"><span class="section-number-3">3.12</span> sensor</h3>
<div class="outline-text-3" id="text-3-12">
<p>
传感器包括加速度传感器、陀螺仪、气压计等，这些传感器通常用于感知手机当前的
状态。其使用方法都有固定的模式。 
</p>
</div>
<div id="outline-container-org494af0e" class="outline-4">
<h4 id="org494af0e"><span class="section-number-4">3.12.1</span> 传感器类型</h4>
<div class="outline-text-4" id="text-3-12-1">
<p>
传感器类型定义在Sensor.java类中。
</p>
<ol class="org-ol">
<li>加速度传感器：Sensor.TYPE\<sub>ACCELEROMETER</sub>;</li>
<li>磁传感器：Sensor.TYPE\<sub>MAGNETIC</sub><sub>FIELD</sub>;</li>
<li>方向传感器：Sensor.TYPE\<sub>ORIENTATION</sub>;</li>
<li>陀螺仪传感器：Sensor.TYPE\<sub>GYROSCOPE</sub>;</li>
<li>感光传感器：Sensor.TYPE\<sub>LIGHT</sub>;</li>
<li>压力传感器：Sensor.TYPE\<sub>PRESSURE</sub>；</li>
<li>温度传感器：Sensor.TYPE\<sub>TEMPERATURE</sub>；</li>
<li>接近传感器：Sensor.TYPE\<sub>PROXIMITY</sub>；</li>
<li>重力传感器：Sensor.TYPE\<sub>GRAVITY</sub>；</li>
<li>线性加速度传感器：Sensor.TYPE\<sub>LINEAR</sub>\<sub>ACCELERATION</sub>；</li>
<li>旋转传感器：Sensor.TYPE\<sub>ROTATION</sub>\<sub>VECTOR</sub>；</li>
<li>相对湿度传感器：Sensor.TYPE\<sub>RELATIVE</sub>\<sub>HUMIDITY</sub>；</li>
<li>环境温度传感器：Sensor.TYPE\<sub>AMBIENT</sub>\<sub>TEMPERATURE</sub>；</li>
<li>磁场标定传感器：Sensor.TYPE\<sub>MAGNETIC</sub>\<sub>FIELD</sub>\<sub>UNCALIBRATED</sub>；</li>
<li>游戏旋转矢量传感器：Sensor.TYPE\<sub>GAME</sub>\<sub>ROTATION</sub>\<sub>VECTOR</sub>；</li>
<li>陀螺仪标定传感器：Sensor.TYPE\<sub>GYROSCOPE</sub>\<sub>UNCALIBRATED</sub>；</li>
<li>Sensor.TYPE\<sub>SIGNIFICANT</sub>\<sub>MOTION</sub></li>
<li>Sensor.TYPE\<sub>STEP</sub>\<sub>DETECTOR</sub></li>
<li>Sensor.TYPE\<sub>STEP</sub>\<sub>COUNTER</sub></li>
<li>Sensor.TYPE\<sub>GEOMAGNETIC</sub>\<sub>ROTATION</sub>\<sub>VECTOR</sub></li>
<li>Sensor.TYPE\<sub>HEART</sub>\<sub>RATE</sub>\<sub>MONITOR</sub></li>
<li>Sensor.TYPE\<sub>WAKE</sub>\<sub>UP</sub>\<sub>TILT</sub>\<sub>DETECTOR</sub></li>
<li>Sensor.TYPE\<sub>WAKE</sub>\<sub>GESTURE</sub></li>
<li>Sensor.TYPE\<sub>GLANCE</sub>\<sub>GESTURE</sub></li>
<li>Sensor.TYPE\<sub>PICK</sub>\<sub>UP</sub>\<sub>GESTURE</sub></li>
</ol>
</div>
</div>
<div id="outline-container-org2595b58" class="outline-4">
<h4 id="org2595b58"><span class="section-number-4">3.12.2</span> 使用方法</h4>
<div class="outline-text-4" id="text-3-12-2">
<ol class="org-ol">
<li><p>
向系统申请传感器服务：
</p>
<div class="org-src-container">
<pre class="src src-java">sm = (<span style="color: #ffff00; font-size: 105%;">SensorManager</span>) getSystemService(SENSOR_SERVICE);
</pre>
</div></li>
<li><p>
利用该服务获取传感器适配器：
</p>
<div class="org-src-container">
<pre class="src src-java">accSensor = sm.getDefaultSensor(<span style="color: #7fffd4;">Sensor</span>.TYPE_ACCELEROMETER);
<span style="color: #ffb6c1; font-size: 105%;">if</span>(presSensor == <span style="color: #7fffd4;">null</span>){
   Log.i(TAG, <span style="color: #ffa07a;">"no accelerometer"</span>);
   <span style="color: #ffb6c1; font-size: 105%;">return</span>;
}
</pre>
</div></li>
<li><p>
实例化传感器数据监听器接口：
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffff00; font-size: 105%;">SensorEventListener</span> <span style="color: #ffd700;">sensorEventListener</span> = <span style="color: #ffb6c1; font-size: 105%;">new</span> <span style="color: #ffff00; font-size: 105%;">SensorEventListener</span>() {
     <span style="color: #7fffd4;">@Override</span>
     <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> onSensorChanged(<span style="color: #ffff00; font-size: 105%;">SensorEvent</span> <span style="color: #ffd700;">event</span>) {
      <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">todo</span>
     }
     <span style="color: #7fffd4;">@Override</span>
     <span style="color: #ffb6c1; font-size: 105%;">public</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">onAccuracyChanged</span>(<span style="color: #ffff00; font-size: 105%;">Sensor</span> <span style="color: #ffd700;">sensor</span>, <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">accuracy</span>) {
     <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">todo</span>
     }
}
</pre>
</div></li>
<li><p>
向传感器服务注册监听器：其中最后一个参数代表多长时间采集一次传感器数据
(单位us)，系统集成了3个时间
</p>
<ul class="org-ul">
<li>SensorManager.SENSOR\<sub>DELAY</sub>\<sub>FASTEST</sub>：尽可能快的获取传感器数据；</li>
<li>SensorManager.SENSOR\<sub>DELAY</sub>\<sub>NORMAL</sub>：一般速度；</li>
<li>SensorManager.SENSOR\<sub>DELAY</sub>\<sub>GAME</sub>：适配游戏；</li>
<li>SensorManager.SENSOR\<sub>DELAY</sub>\<sub>UI</sub>：适配UI；</li>
</ul>
<div class="org-src-container">
<pre class="src src-java">sm.registerListener(<span style="color: #ffff00; font-size: 105%;">sensorEventListener</span>, <span style="color: #ffff00; font-size: 105%;">accSensor</span>, <span style="color: #7fffd4;">SensorManager</span>.<span style="color: #ffff00; font-size: 105%;">SENSOR_DELAY_FASTEST</span>);
</pre>
</div></li>
<li><p>
用完后卸载监听器：
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ffb6c1; font-size: 105%;">if</span>(presSensor != <span style="color: #7fffd4;">null</span>){
     sm.unregisterListener(sensorEventListener);
}
</pre>
</div></li>
</ol>
</div>
</div>
</div>
<div id="outline-container-orgce9db85" class="outline-3">
<h3 id="orgce9db85"><span class="section-number-3">3.13</span> hal</h3>
<div class="outline-text-3" id="text-3-13">
<p>
本小结主要参考<a href="https://blog.csdn.net/luoshengyang/article/details/6567257">CSDN</a>博客。
android hal的介绍从android的整体架构开始，从kernel driver开始到最终的
app调用硬件模块。
</p>
</div>
<div id="outline-container-org2d55d64" class="outline-4">
<h4 id="org2d55d64"><span class="section-number-4">3.13.1</span> 架构</h4>
<div class="outline-text-4" id="text-3-13-1">
<p>
Android的hal，简单来说，就是对Linux内核驱动程序的封装，向上提供接口，
屏蔽低层的实现细节。也就是说，把对硬件的支持分成了两层.
</p>
<ul class="org-ul">
<li>用户空间:User Space, hal运行在用户空间;</li>
<li>内核空间:Kernel Space, Linux内核驱动程序运行在内核空间;</li>
</ul>

<p>
把hal和内核驱动整合在一起放在内核空间不可行吗？从技术实现的角度来看，
是可以的，然而从商业的角度来看，把对硬件的支持逻辑都放在内核空间，可
能会损害厂家的利益。一般划分.
</p>
<ul class="org-ul">
<li>Linux内核代码:版权遵循GNU License, 在发布产品时，必须公布源代码;</li>
<li>Android源代码:版权遵循Apache License, 在发布产品时，无须发布源代码;</li>
</ul>

<p>
如果把对硬件支持的所有代码都放在Linux驱动层，那就意味着发布时要公开驱
动程序的源代码，而公开源代码就意味着把硬件的相关参数和实现都公开了,损
害很大。因此，Android才会想到把对硬件的支持分成hal和内核驱动层，内核
驱动层只提供简单的访问硬件逻辑，例如读写硬件寄存器的通道，至于从硬件
中读写到了什么值，都放在hal中去了，这样就可以把商业秘密隐藏起来了。
</p>

<p>
也正是由于这个分层的原因，Android被踢出了Linux内核主线代码树中。
Android放在内核空间的驱动程序对硬件的支持是不完整的，把Linux内核移植
到别的机器上去时，由于缺乏hal的支持，硬件就完全不能用了，这也是为什么
说Android是开放系统而不是开源系统的原因。 
</p>

<p>
android从下到上涉及到了android系统多层，如图<a href="#orgb485526">2</a>所示。
</p>

<div id="orgb485526" class="figure">
<p><img src="./img/img-android-frmwk.png" alt="img-android-frmwk.png" />
</p>
<p><span class="figure-number">Figure 2: </span>android框架</p>
</div>

<ul class="org-ul">
<li>硬件驱动层：driver层, 一般实现简单io操作，如iic，uart等;</li>
<li>硬件抽象层：hal层，控制driver层的io做些逻辑操作；</li>
<li>运行时库：jni层，将下层的c域运行时相互转换到高层的java虚拟机域；</li>
<li>应用程序框架层：framework层，利用aidl技术进程通信，从进程角度做划分；</li>
<li>api：对framework层做进一步抽象，提炼api便于app调用硬件功能；</li>
</ul>
</div>
</div>

<div id="outline-container-org84909fe" class="outline-4">
<h4 id="org84909fe"><span class="section-number-4">3.13.2</span> driver</h4>
<div class="outline-text-4" id="text-3-13-2">
<p>
为了方便描述为Android系统编写内核驱动程序的过程，使用一个虚拟的硬件设
备，这个设备只有一个4字节的寄存器，可读可写。把这个虚拟的设备命名为
“hello”，而这个内核驱动程序也命名为hello驱动程序。其实，Android内核
驱动程序和一般Linux内核驱动程序的编写方法是一样的，都是以Linux模块的
形式实现的。  
</p>
</div>

<div id="outline-container-org7d728e5" class="outline-5">
<h5 id="org7d728e5"><span class="section-number-5">3.13.2.1</span> 驱动路径</h5>
<div class="outline-text-5" id="text-3-13-2-1">
<p>
进入到kernel/common/drivers目录，新建hello目录。
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">1: </span>USER-NAME@MACHINE-NAME:~/Android$ cd kernel/common/drivers
<span class="linenr">2: </span>USER-NAME@MACHINE-NAME:~/Android/kernel/common/drivers$ mkdir hello
</pre>
</div>
</div>
</div>

<div id="outline-container-org2752f6a" class="outline-5">
<h5 id="org2752f6a"><span class="section-number-5">3.13.2.2</span> 驱动接口</h5>
<div class="outline-text-5" id="text-3-13-2-2">
<p>
在hello目录中增加hello.h文件。
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="linenr"> 1: </span><span style="color: #87cefa; text-decoration: underline;">#if</span><span style="color: #87cefa; text-decoration: underline;">n</span><span style="color: #87cefa; text-decoration: underline;">def</span> _HELLO_ANDROID_H_
<span class="linenr"> 2: </span><span style="color: #87cefa; text-decoration: underline;">#define</span> <span style="color: #ffd700;">_HELLO_ANDROID_H_</span>
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;linux/cdev.h&gt;</span>
<span class="linenr"> 5: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;linux/semaphore.h&gt;</span>
<span class="linenr"> 6: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21518;&#38754;&#35201;&#29992;&#21040;</span>
<span class="linenr"> 7: </span><span style="color: #87cefa; text-decoration: underline;">#define</span> <span style="color: #ffd700;">HELLO_DEVICE_NODE_NAME</span>  <span style="color: #ffa07a;">"hello"</span>
<span class="linenr"> 8: </span><span style="color: #87cefa; text-decoration: underline;">#define</span> <span style="color: #ffd700;">HELLO_DEVICE_FILE_NAME</span>  <span style="color: #ffa07a;">"hello"</span>
<span class="linenr"> 9: </span><span style="color: #87cefa; text-decoration: underline;">#define</span> <span style="color: #ffd700;">HELLO_DEVICE_PROC_NAME</span>  <span style="color: #ffa07a;">"hello"</span>
<span class="linenr">10: </span><span style="color: #87cefa; text-decoration: underline;">#define</span> <span style="color: #ffd700;">HELLO_DEVICE_CLASS_NAME</span> <span style="color: #ffa07a;">"hello"</span>
<span class="linenr">11: </span><span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">&#34394;&#25311;&#30340;&#30828;&#20214;&#35774;&#22791;</span>
<span class="linenr">12: </span><span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_android_dev</span> 
<span class="linenr">13: </span>{
<span class="linenr">14: </span>    <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">val</span>;<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20195;&#34920;&#35774;&#22791;&#37324;&#38754;&#30340;&#23492;&#23384;&#22120;</span>
<span class="linenr">15: </span>    <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">semaphore</span> <span style="color: #ffd700;">sem</span>;<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20449;&#21495;&#37327;&#65292;&#21516;&#27493;&#23545;val&#30340;&#35775;&#38382;</span>
<span class="linenr">16: </span>    <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">cdev</span> <span style="color: #ffd700;">dev</span>;<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#34920;&#31034;&#35813;&#35774;&#22791;&#26159;&#20869;&#23884;&#30340;&#23383;&#31526;&#35774;&#22791;</span>
<span class="linenr">17: </span>};
<span class="linenr">18: </span><span style="color: #87cefa; text-decoration: underline;">#endif</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgea627ab" class="outline-5">
<h5 id="orgea627ab"><span class="section-number-5">3.13.2.3</span> 驱动实现</h5>
<div class="outline-text-5" id="text-3-13-2-3">
<p>
在hello目录中增加hello.c文件，这是驱动程序的实现部分。驱动程序的功能
主要是向上层提供访问设备的寄存器的值，包括读和写。提供了三种访问设备
寄存器的方法，详细见代码所示 。
</p>
<ul class="org-ul">
<li>通过proc文件系统来访问；</li>
<li>通过传统的设备文件的方法来访问；</li>
<li>通过devfs文件系统来访问；</li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span class="linenr"> 1: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#39318;&#20808;&#26159;&#21253;&#21547;&#24517;&#35201;&#30340;&#22836;&#25991;&#20214;&#21644;&#23450;&#20041;&#19977;&#31181;&#35775;&#38382;&#35774;&#22791;&#30340;&#26041;&#27861;</span>
<span class="linenr"> 2: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;linux/init.h&gt;</span>
<span class="linenr"> 3: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;linux/module.h&gt;</span>
<span class="linenr"> 4: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;linux/types.h&gt;</span>
<span class="linenr"> 5: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;linux/fs.h&gt;</span>
<span class="linenr"> 6: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;linux/proc_fs.h&gt;</span>
<span class="linenr"> 7: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;linux/device.h&gt;</span>
<span class="linenr"> 8: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;asm/uaccess.h&gt;</span>
<span class="linenr"> 9: </span>
<span class="linenr">10: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">"hello.h"</span>
<span class="linenr">11: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20027;&#35774;&#22791;&#21644;&#20174;&#35774;&#22791;&#21495;&#21464;&#37327;</span>
<span class="linenr">12: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">hello_major</span> = 0;
<span class="linenr">13: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">hello_minor</span> = 0;
<span class="linenr">14: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#35774;&#22791;&#31867;&#21035;&#21644;&#35774;&#22791;&#21464;&#37327;</span>
<span class="linenr">15: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">class</span>* <span style="color: #ffd700;">hello_class</span> = <span style="color: #7fffd4;">NULL</span>;
<span class="linenr">16: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_android_dev</span>* <span style="color: #ffd700;">hello_dev</span> = <span style="color: #7fffd4;">NULL</span>;
<span class="linenr">17: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20256;&#32479;&#30340;&#35774;&#22791;&#25991;&#20214;&#25805;&#20316;&#26041;&#27861;</span>
<span class="linenr">18: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_open</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">inode</span>* <span style="color: #ffd700;">inode</span>, <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">file</span>* <span style="color: #ffd700;">filp</span>);
<span class="linenr">19: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_release</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">inode</span>* <span style="color: #ffd700;">inode</span>, <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">file</span>* <span style="color: #ffd700;">filp</span>);
<span class="linenr">20: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">ssize_t</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_read</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">file</span>* <span style="color: #ffd700;">filp</span>,
<span class="linenr">21: </span>              <span style="color: #ffff00; font-size: 105%;">char</span> <span style="color: #ffd700;">__user</span>* buf,
<span class="linenr">22: </span>              <span style="color: #ffff00; font-size: 105%;">size_t</span> <span style="color: #ffd700;">count</span>,
<span class="linenr">23: </span>              <span style="color: #ffff00; font-size: 105%;">loff_t</span>* <span style="color: #ffd700;">f_pos</span>);
<span class="linenr">24: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">ssize_t</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_write</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">file</span>* <span style="color: #ffd700;">filp</span>,
<span class="linenr">25: </span>               <span style="color: #ffb6c1; font-size: 105%;">const</span> <span style="color: #ffff00; font-size: 105%;">char</span> <span style="color: #ffd700;">__user</span>* buf,
<span class="linenr">26: </span>               <span style="color: #ffff00; font-size: 105%;">size_t</span> <span style="color: #ffd700;">count</span>, <span style="color: #ffff00; font-size: 105%;">loff_t</span>* <span style="color: #ffd700;">f_pos</span>);
<span class="linenr">27: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#35774;&#22791;&#25991;&#20214;&#25805;&#20316;&#26041;&#27861;&#34920;</span>
<span class="linenr">28: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">file_operations</span> <span style="color: #ffd700;">hello_fops</span> =
<span class="linenr">29: </span>{
<span class="linenr">30: </span>    .owner = THIS_MODULE,
<span class="linenr">31: </span>    .open = hello_open,
<span class="linenr">32: </span>    .release = hello_release,
<span class="linenr">33: </span>    .read = hello_read,
<span class="linenr">34: </span>    .write = hello_write, 
<span class="linenr">35: </span>};
<span class="linenr">36: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#35775;&#38382;&#35774;&#32622;&#23646;&#24615;&#26041;&#27861;</span>
<span class="linenr">37: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">ssize_t</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_val_show</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">device</span>* <span style="color: #ffd700;">dev</span>,
<span class="linenr">38: </span>                  <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">device_attribute</span>* <span style="color: #ffd700;">attr</span>,
<span class="linenr">39: </span>                  <span style="color: #ffff00; font-size: 105%;">char</span>* <span style="color: #ffd700;">buf</span>);
<span class="linenr">40: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">ssize_t</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_val_store</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">device</span>* <span style="color: #ffd700;">dev</span>,
<span class="linenr">41: </span>                   <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">device_attribute</span>* <span style="color: #ffd700;">attr</span>,
<span class="linenr">42: </span>                   <span style="color: #ffb6c1; font-size: 105%;">const</span> <span style="color: #ffff00; font-size: 105%;">char</span>* <span style="color: #ffd700;">buf</span>, <span style="color: #ffff00; font-size: 105%;">size_t</span> <span style="color: #ffd700;">count</span>);
<span class="linenr">43: </span>
<span class="linenr">44: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#23450;&#20041;&#35774;&#22791;&#23646;&#24615;</span>
<span class="linenr">45: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">DEVICE_ATTR</span>(val, S_IRUGO | S_IWUSR, hello_val_show, hello_val_store);
</pre>
</div>
<ul class="org-ul">
<li><p>
传统方式
定义传统的设备文件访问方法，主要是定义
</p>
<ul class="org-ul">
<li>hello<sub>open</sub>：打开;</li>
<li>hello<sub>release</sub>：释放;</li>
<li>hello<sub>read</sub>：读；</li>
<li>hello<sub>write</sub>：写；</li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span class="linenr"> 46: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#25171;&#24320;&#35774;&#22791;&#26041;&#27861;</span>
<span class="linenr"> 47: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_open</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">inode</span>* <span style="color: #ffd700;">inode</span>, <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">file</span>* <span style="color: #ffd700;">filp</span>)
<span class="linenr"> 48: </span>{
<span class="linenr"> 49: </span>    <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_android_dev</span>* <span style="color: #ffd700;">dev</span>;        
<span class="linenr"> 50: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#23558;&#33258;&#23450;&#20041;&#35774;&#22791;&#32467;&#26500;&#20307;&#20445;&#23384;&#22312;&#25991;&#20214;&#25351;&#38024;&#30340;&#31169;&#26377;&#25968;&#25454;&#22495;&#20013;&#65292;&#20197;&#20415;&#35775;&#38382;&#35774;&#22791;&#26102;&#25343;&#26469;&#29992;</span>
<span class="linenr"> 51: </span>    dev = container_of(inode-&gt;i_cdev, <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_android_dev</span>, dev);
<span class="linenr"> 52: </span>    filp-&gt;private_data = dev;
<span class="linenr"> 53: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> 0;
<span class="linenr"> 54: </span>}
<span class="linenr"> 55: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#35774;&#22791;&#25991;&#20214;&#37322;&#25918;&#26102;&#35843;&#29992;&#65292;&#31354;&#23454;&#29616;</span>
<span class="linenr"> 56: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_release</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">inode</span>* <span style="color: #ffd700;">inode</span>, <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">file</span>* <span style="color: #ffd700;">filp</span>)
<span class="linenr"> 57: </span>{
<span class="linenr"> 58: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> 0;
<span class="linenr"> 59: </span>}
<span class="linenr"> 60: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#35835;&#21462;&#35774;&#22791;&#30340;&#23492;&#23384;&#22120;val&#30340;&#20540;</span>
<span class="linenr"> 61: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">ssize_t</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_read</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">file</span>* <span style="color: #ffd700;">filp</span>,
<span class="linenr"> 62: </span>              <span style="color: #ffff00; font-size: 105%;">char</span> <span style="color: #ffd700;">__user</span>* buf,
<span class="linenr"> 63: </span>              <span style="color: #ffff00; font-size: 105%;">size_t</span> <span style="color: #ffd700;">count</span>,
<span class="linenr"> 64: </span>              <span style="color: #ffff00; font-size: 105%;">loff_t</span>* <span style="color: #ffd700;">f_pos</span>)
<span class="linenr"> 65: </span>{
<span class="linenr"> 66: </span>    <span style="color: #ffff00; font-size: 105%;">ssize_t</span> <span style="color: #ffd700;">err</span> = 0;
<span class="linenr"> 67: </span>    <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_android_dev</span>* <span style="color: #ffd700;">dev</span> = filp-&gt;private_data;        
<span class="linenr"> 68: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21516;&#27493;&#35775;&#38382;</span>
<span class="linenr"> 69: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(down_interruptible(&amp;(dev-&gt;sem)))
<span class="linenr"> 70: </span>    {
<span class="linenr"> 71: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> -ERESTARTSYS;
<span class="linenr"> 72: </span>    }
<span class="linenr"> 73: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(count &lt; <span style="color: #ffb6c1; font-size: 105%;">sizeof</span>(dev-&gt;val))
<span class="linenr"> 74: </span>    {
<span class="linenr"> 75: </span>    <span style="color: #ffb6c1; font-size: 105%;">goto</span> <span style="color: #7fffd4;">out</span>;
<span class="linenr"> 76: </span>    }        
<span class="linenr"> 77: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#23558;&#23492;&#23384;&#22120;val&#30340;&#20540;&#25335;&#36125;&#21040;&#29992;&#25143;&#25552;&#20379;&#30340;&#32531;&#20914;&#21306;</span>
<span class="linenr"> 78: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(copy_to_user(buf, &amp;(dev-&gt;val), <span style="color: #ffb6c1; font-size: 105%;">sizeof</span>(dev-&gt;val)))
<span class="linenr"> 79: </span>    {
<span class="linenr"> 80: </span>    err = -EFAULT;
<span class="linenr"> 81: </span>    <span style="color: #ffb6c1; font-size: 105%;">goto</span> <span style="color: #7fffd4;">out</span>;
<span class="linenr"> 82: </span>    }
<span class="linenr"> 83: </span>    err = <span style="color: #ffb6c1; font-size: 105%;">sizeof</span>(dev-&gt;val);
<span class="linenr"> 84: </span>  <span style="color: #7fffd4;">out</span>:
<span class="linenr"> 85: </span>    up(&amp;(dev-&gt;sem));
<span class="linenr"> 86: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> err;
<span class="linenr"> 87: </span>}
<span class="linenr"> 88: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20889;&#35774;&#22791;&#30340;&#23492;&#23384;&#22120;&#20540;val</span>
<span class="linenr"> 89: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">ssize_t</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_write</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">file</span>* <span style="color: #ffd700;">filp</span>,
<span class="linenr"> 90: </span>               <span style="color: #ffb6c1; font-size: 105%;">const</span> <span style="color: #ffff00; font-size: 105%;">char</span> <span style="color: #ffd700;">__user</span>* buf,
<span class="linenr"> 91: </span>               <span style="color: #ffff00; font-size: 105%;">size_t</span> <span style="color: #ffd700;">count</span>,
<span class="linenr"> 92: </span>               <span style="color: #ffff00; font-size: 105%;">loff_t</span>* <span style="color: #ffd700;">f_pos</span>)
<span class="linenr"> 93: </span>{
<span class="linenr"> 94: </span>    <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_android_dev</span>* <span style="color: #ffd700;">dev</span> = filp-&gt;private_data;
<span class="linenr"> 95: </span>    <span style="color: #ffff00; font-size: 105%;">ssize_t</span> <span style="color: #ffd700;">err</span> = 0;        
<span class="linenr"> 96: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21516;&#27493;&#35775;&#38382;</span>
<span class="linenr"> 97: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(down_interruptible(&amp;(dev-&gt;sem)))
<span class="linenr"> 98: </span>    {
<span class="linenr"> 99: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> -ERESTARTSYS;        
<span class="linenr">100: </span>    }        
<span class="linenr">101: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(count != <span style="color: #ffb6c1; font-size: 105%;">sizeof</span>(dev-&gt;val))
<span class="linenr">102: </span>    {
<span class="linenr">103: </span>    <span style="color: #ffb6c1; font-size: 105%;">goto</span> <span style="color: #7fffd4;">out</span>;        
<span class="linenr">104: </span>    }        
<span class="linenr">105: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#23558;&#29992;&#25143;&#25552;&#20379;&#30340;&#32531;&#20914;&#21306;&#30340;&#20540;&#20889;&#21040;&#35774;&#22791;&#23492;&#23384;&#22120;&#21435;</span>
<span class="linenr">106: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(copy_from_user(&amp;(dev-&gt;val), buf, count))
<span class="linenr">107: </span>    {
<span class="linenr">108: </span>    err = -EFAULT;
<span class="linenr">109: </span>    <span style="color: #ffb6c1; font-size: 105%;">goto</span> <span style="color: #7fffd4;">out</span>;
<span class="linenr">110: </span>    }
<span class="linenr">111: </span>    err = <span style="color: #ffb6c1; font-size: 105%;">sizeof</span>(dev-&gt;val);
<span class="linenr">112: </span>  <span style="color: #7fffd4;">out</span>:
<span class="linenr">113: </span>    up(&amp;(dev-&gt;sem));
<span class="linenr">114: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> err;
<span class="linenr">115: </span>}
</pre>
</div></li>

<li><p>
devfs方式
定义通过devfs文件系统访问方法，这里把设备的寄存器val看成是设备的一
个属性，通过读写这个属性来对设备进行访问，主要是实现两个方法。
</p>
<ul class="org-ul">
<li>hello<sub>val</sub><sub>show</sub>；</li>
<li>hello<sub>val</sub><sub>store</sub>；</li>
</ul>

<p>
同时定义了两个内部使用的访问val值的方法
</p>
<ul class="org-ul">
<li>_<sub>hello</sub><sub>get</sub><sub>val</sub>；</li>
<li>_<sub>hello</sub><sub>set</sub><sub>val</sub>；</li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span class="linenr">116: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#35835;&#21462;&#23492;&#23384;&#22120;val&#30340;&#20540;&#21040;&#32531;&#20914;&#21306;buf&#20013;&#65292;&#20869;&#37096;&#20351;&#29992;</span>
<span class="linenr">117: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">ssize_t</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">__hello_get_val</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_android_dev</span>* <span style="color: #ffd700;">dev</span>, <span style="color: #ffff00; font-size: 105%;">char</span>* <span style="color: #ffd700;">buf</span>) 
<span class="linenr">118: </span>{
<span class="linenr">119: </span>    <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">val</span> = 0;        
<span class="linenr">120: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21516;&#27493;&#35775;&#38382;</span>
<span class="linenr">121: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(down_interruptible(&amp;(dev-&gt;sem)))
<span class="linenr">122: </span>    {                
<span class="linenr">123: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> -ERESTARTSYS;        
<span class="linenr">124: </span>    }        
<span class="linenr">125: </span>    val = dev-&gt;val;        
<span class="linenr">126: </span>    up(&amp;(dev-&gt;sem));        
<span class="linenr">127: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> snprintf(buf, PAGE_SIZE, <span style="color: #ffa07a;">"%d\n"</span>, val);
<span class="linenr">128: </span>}
<span class="linenr">129: </span>
<span class="linenr">130: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#25226;&#32531;&#20914;&#21306;buf&#30340;&#20540;&#20889;&#21040;&#35774;&#22791;&#23492;&#23384;&#22120;val&#20013;&#21435;&#65292;&#20869;&#37096;&#20351;&#29992;</span>
<span class="linenr">131: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">ssize_t</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">__hello_set_val</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_android_dev</span>* <span style="color: #ffd700;">dev</span>,
<span class="linenr">132: </span>                   <span style="color: #ffb6c1; font-size: 105%;">const</span> <span style="color: #ffff00; font-size: 105%;">char</span>* <span style="color: #ffd700;">buf</span>, <span style="color: #ffff00; font-size: 105%;">size_t</span> <span style="color: #ffd700;">count</span>)
<span class="linenr">133: </span>{
<span class="linenr">134: </span>    <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">val</span> = 0;        
<span class="linenr">135: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#23558;&#23383;&#31526;&#20018;&#36716;&#25442;&#25104;&#25968;&#23383;        </span>
<span class="linenr">136: </span>    val = simple_strtol(buf, <span style="color: #7fffd4;">NULL</span>, 10);        
<span class="linenr">137: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21516;&#27493;&#35775;&#38382;        </span>
<span class="linenr">138: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(down_interruptible(&amp;(dev-&gt;sem)))
<span class="linenr">139: </span>    {                
<span class="linenr">140: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> -ERESTARTSYS;        
<span class="linenr">141: </span>    }        
<span class="linenr">142: </span>    dev-&gt;val = val;        
<span class="linenr">143: </span>    up(&amp;(dev-&gt;sem));
<span class="linenr">144: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> count;
<span class="linenr">145: </span>}
<span class="linenr">146: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#35835;&#21462;&#35774;&#22791;&#23646;&#24615;val</span>
<span class="linenr">147: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">ssize_t</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_val_show</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">device</span>* <span style="color: #ffd700;">dev</span>,
<span class="linenr">148: </span>                  <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">device_attribute</span>* <span style="color: #ffd700;">attr</span>,
<span class="linenr">149: </span>                  <span style="color: #ffff00; font-size: 105%;">char</span>* <span style="color: #ffd700;">buf</span>)
<span class="linenr">150: </span>{
<span class="linenr">151: </span>    <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_android_dev</span>* <span style="color: #ffd700;">hdev</span> =
<span class="linenr">152: </span>    (<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_android_dev</span>*)<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">dev_get_drvdata</span>(dev);        
<span class="linenr">153: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> __hello_get_val(hdev, buf);
<span class="linenr">154: </span>}
<span class="linenr">155: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20889;&#35774;&#22791;&#23646;&#24615;val</span>
<span class="linenr">156: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">ssize_t</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_val_store</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">device</span>* <span style="color: #ffd700;">dev</span>,
<span class="linenr">157: </span>                   <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">device_attribute</span>* <span style="color: #ffd700;">attr</span>,
<span class="linenr">158: </span>                   <span style="color: #ffb6c1; font-size: 105%;">const</span> <span style="color: #ffff00; font-size: 105%;">char</span>* <span style="color: #ffd700;">buf</span>, <span style="color: #ffff00; font-size: 105%;">size_t</span> <span style="color: #ffd700;">count</span>)
<span class="linenr">159: </span>{ 
<span class="linenr">160: </span>    <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_android_dev</span>* <span style="color: #ffd700;">hdev</span> =
<span class="linenr">161: </span>    (<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_android_dev</span>*)<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">dev_get_drvdata</span>(dev);  
<span class="linenr">162: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> __hello_set_val(hdev, buf, count);
<span class="linenr">163: </span>}
</pre>
</div></li>

<li><p>
proc方式
定义通过proc文件系统访问方法，主要实现了两个方法
</p>
<ul class="org-ul">
<li>hello<sub>proc</sub><sub>read</sub>；</li>
<li>hello<sub>proc</sub><sub>write</sub>；</li>
</ul>

<p>
同时定义了在proc文件系统创建和删除文件的方法
</p>
<ul class="org-ul">
<li>hello<sub>create</sub><sub>proc</sub>；</li>
<li>hello<sub>remove</sub><sub>proc</sub>；</li>
</ul>

<div class="org-src-container">
<pre class="src src-c"><span class="linenr">164: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#35835;&#21462;&#35774;&#22791;&#23492;&#23384;&#22120;val&#30340;&#20540;&#65292;&#20445;&#23384;&#22312;page&#32531;&#20914;&#21306;&#20013;</span>
<span class="linenr">165: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">ssize_t</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_proc_read</span>(<span style="color: #ffff00; font-size: 105%;">char</span>* <span style="color: #ffd700;">page</span>,
<span class="linenr">166: </span>                   <span style="color: #ffff00; font-size: 105%;">char</span>* * <span style="color: #ffd700;">start</span>,
<span class="linenr">167: </span>                   <span style="color: #ffff00; font-size: 105%;">off_t</span> <span style="color: #ffd700;">off</span>,
<span class="linenr">168: </span>                   <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">count</span>,
<span class="linenr">169: </span>                   <span style="color: #ffff00; font-size: 105%;">int</span>* <span style="color: #ffd700;">eof</span>,
<span class="linenr">170: </span>                   <span style="color: #ffff00; font-size: 105%;">void</span>* <span style="color: #ffd700;">data</span>)
<span class="linenr">171: </span>{
<span class="linenr">172: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(off &gt; 0)
<span class="linenr">173: </span>    {
<span class="linenr">174: </span>    *eof = 1;
<span class="linenr">175: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> 0;
<span class="linenr">176: </span>    }
<span class="linenr">177: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> __hello_get_val(hello_dev, page);
<span class="linenr">178: </span>}
<span class="linenr">179: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#25226;&#32531;&#20914;&#21306;&#30340;&#20540;buff&#20445;&#23384;&#21040;&#35774;&#22791;&#23492;&#23384;&#22120;val&#20013;&#21435;</span>
<span class="linenr">180: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">ssize_t</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_proc_write</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">file</span>* <span style="color: #ffd700;">filp</span>,
<span class="linenr">181: </span>                <span style="color: #ffb6c1; font-size: 105%;">const</span> <span style="color: #ffff00; font-size: 105%;">char</span> <span style="color: #ffd700;">__user</span> *buff,
<span class="linenr">182: </span>                <span style="color: #ffff00; font-size: 105%;">unsigned</span> <span style="color: #ffff00; font-size: 105%;">long</span> <span style="color: #ffd700;">len</span>,
<span class="linenr">183: </span>                <span style="color: #ffff00; font-size: 105%;">void</span>* <span style="color: #ffd700;">data</span>)
<span class="linenr">184: </span>{
<span class="linenr">185: </span>    <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">err</span> = 0;
<span class="linenr">186: </span>    <span style="color: #ffff00; font-size: 105%;">char</span>* <span style="color: #ffd700;">page</span> = <span style="color: #7fffd4;">NULL</span>;
<span class="linenr">187: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(len &gt; PAGE_SIZE)
<span class="linenr">188: </span>    {
<span class="linenr">189: </span>    printk(KERN_ALERT<span style="color: #ffa07a;">"The buff is too large: %lu.\n"</span>, len);
<span class="linenr">190: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> -EFAULT;
<span class="linenr">191: </span>    }
<span class="linenr">192: </span>    page = (<span style="color: #ffff00; font-size: 105%;">char</span>*)__get_free_page(GFP_KERNEL);
<span class="linenr">193: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(!page)
<span class="linenr">194: </span>    {                
<span class="linenr">195: </span>    printk(KERN_ALERT<span style="color: #ffa07a;">"Failed to alloc page.\n"</span>);
<span class="linenr">196: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> -ENOMEM;
<span class="linenr">197: </span>    }        
<span class="linenr">198: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20808;&#25226;&#29992;&#25143;&#25552;&#20379;&#30340;&#32531;&#20914;&#21306;&#20540;&#25335;&#36125;&#21040;&#20869;&#26680;&#32531;&#20914;&#21306;&#20013;&#21435;</span>
<span class="linenr">199: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(copy_from_user(page, buff, len))
<span class="linenr">200: </span>    {
<span class="linenr">201: </span>    printk(KERN_ALERT<span style="color: #ffa07a;">"Failed to copy buff from user.\n"</span>);                
<span class="linenr">202: </span>    err = -EFAULT;
<span class="linenr">203: </span>    <span style="color: #ffb6c1; font-size: 105%;">goto</span> <span style="color: #7fffd4;">out</span>;
<span class="linenr">204: </span>    }
<span class="linenr">205: </span>    err = __hello_set_val(hello_dev, page, len);
<span class="linenr">206: </span>  <span style="color: #7fffd4;">out</span>:
<span class="linenr">207: </span>    free_page((<span style="color: #ffff00; font-size: 105%;">unsigned</span> <span style="color: #ffff00; font-size: 105%;">long</span>)page);
<span class="linenr">208: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> err;
<span class="linenr">209: </span>}
<span class="linenr">210: </span>
<span class="linenr">211: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21019;&#24314;/proc/hello&#25991;&#20214;</span>
<span class="linenr">212: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_create_proc</span>(<span style="color: #ffff00; font-size: 105%;">void</span>)
<span class="linenr">213: </span>{
<span class="linenr">214: </span>    <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">proc_dir_entry</span>* <span style="color: #ffd700;">entry</span>;
<span class="linenr">215: </span>    entry = create_proc_entry(HELLO_DEVICE_PROC_NAME, 0, <span style="color: #7fffd4;">NULL</span>);
<span class="linenr">216: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(entry)
<span class="linenr">217: </span>    {
<span class="linenr">218: </span>    entry-&gt;owner = THIS_MODULE;
<span class="linenr">219: </span>    entry-&gt;read_proc = hello_proc_read;
<span class="linenr">220: </span>    entry-&gt;write_proc = hello_proc_write;
<span class="linenr">221: </span>    }
<span class="linenr">222: </span>}
<span class="linenr">223: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21024;&#38500;/proc/hello&#25991;&#20214;</span>
<span class="linenr">224: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_remove_proc</span>(<span style="color: #ffff00; font-size: 105%;">void</span>)
<span class="linenr">225: </span>{
<span class="linenr">226: </span>    remove_proc_entry(HELLO_DEVICE_PROC_NAME, <span style="color: #7fffd4;">NULL</span>);
<span class="linenr">227: </span>}
<span class="linenr">228: </span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org21329f1" class="outline-5">
<h5 id="org21329f1"><span class="section-number-5">3.13.2.4</span> 驱动注册</h5>
<div class="outline-text-5" id="text-3-13-2-4">
<p>
最后，定义模块加载和卸载方法，这里只要是执行设备注册和初始化操作。
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="linenr">229: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21021;&#22987;&#21270;&#35774;&#22791;</span>
<span class="linenr">230: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span>  <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">__hello_setup_dev</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_android_dev</span>* <span style="color: #ffd700;">dev</span>)
<span class="linenr">231: </span>{
<span class="linenr">232: </span>    <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">err</span>;
<span class="linenr">233: </span>    <span style="color: #ffff00; font-size: 105%;">dev_t</span> <span style="color: #ffd700;">devno</span> = MKDEV(hello_major, hello_minor);
<span class="linenr">234: </span>    memset(dev, 0, <span style="color: #ffb6c1; font-size: 105%;">sizeof</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_android_dev</span>));
<span class="linenr">235: </span>    cdev_init(&amp;(dev-&gt;dev), &amp;hello_fops);
<span class="linenr">236: </span>    dev-&gt;dev.owner = THIS_MODULE;
<span class="linenr">237: </span>    dev-&gt;dev.ops = &amp;hello_fops;        
<span class="linenr">238: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#27880;&#20876;&#23383;&#31526;&#35774;&#22791;</span>
<span class="linenr">239: </span>    err = cdev_add(&amp;(dev-&gt;dev),devno, 1);
<span class="linenr">240: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(err)
<span class="linenr">241: </span>    {
<span class="linenr">242: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> err;
<span class="linenr">243: </span>    }        
<span class="linenr">244: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21021;&#22987;&#21270;&#20449;&#21495;&#37327;&#21644;&#23492;&#23384;&#22120;val&#30340;&#20540;</span>
<span class="linenr">245: </span>    init_MUTEX(&amp;(dev-&gt;sem));
<span class="linenr">246: </span>    dev-&gt;val = 0;
<span class="linenr">247: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> 0;
<span class="linenr">248: </span>}
<span class="linenr">249: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#27169;&#22359;&#21152;&#36733;&#26041;&#27861;</span>
<span class="linenr">250: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">__init</span> hello_init(<span style="color: #ffff00; font-size: 105%;">void</span>)
<span class="linenr">251: </span>{ 
<span class="linenr">252: </span>    <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">err</span> = -1;
<span class="linenr">253: </span>    <span style="color: #ffff00; font-size: 105%;">dev_t</span> <span style="color: #ffd700;">dev</span> = 0;
<span class="linenr">254: </span>    <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">device</span>* <span style="color: #ffd700;">temp</span> = <span style="color: #7fffd4;">NULL</span>;
<span class="linenr">255: </span>    printk(KERN_ALERT<span style="color: #ffa07a;">"Initializing hello device.\n"</span>);        
<span class="linenr">256: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21160;&#24577;&#20998;&#37197;&#20027;&#35774;&#22791;&#21644;&#20174;&#35774;&#22791;&#21495;</span>
<span class="linenr">257: </span>    err = alloc_chrdev_region(&amp;dev, 0, 1, HELLO_DEVICE_NODE_NAME);
<span class="linenr">258: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(err &lt; 0)
<span class="linenr">259: </span>    {
<span class="linenr">260: </span>    printk(KERN_ALERT<span style="color: #ffa07a;">"Failed to alloc char dev region.\n"</span>);
<span class="linenr">261: </span>    <span style="color: #ffb6c1; font-size: 105%;">goto</span> <span style="color: #7fffd4;">fail</span>;
<span class="linenr">262: </span>    }
<span class="linenr">263: </span>    hello_major = MAJOR(dev);
<span class="linenr">264: </span>    hello_minor = MINOR(dev);        
<span class="linenr">265: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20998;&#37197;helo&#35774;&#22791;&#32467;&#26500;&#20307;&#21464;&#37327;</span>
<span class="linenr">266: </span>    hello_dev = kmalloc(<span style="color: #ffb6c1; font-size: 105%;">sizeof</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_android_dev</span>), GFP_KERNEL);
<span class="linenr">267: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(!hello_dev)
<span class="linenr">268: </span>    {
<span class="linenr">269: </span>    err = -ENOMEM;
<span class="linenr">270: </span>    printk(KERN_ALERT<span style="color: #ffa07a;">"Failed to alloc hello_dev.\n"</span>);
<span class="linenr">271: </span>    <span style="color: #ffb6c1; font-size: 105%;">goto</span> <span style="color: #7fffd4;">unregister</span>;
<span class="linenr">272: </span>    }        
<span class="linenr">273: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21021;&#22987;&#21270;&#35774;&#22791;</span>
<span class="linenr">274: </span>    err = __hello_setup_dev(hello_dev);
<span class="linenr">275: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(err)
<span class="linenr">276: </span>    {
<span class="linenr">277: </span>    printk(KERN_ALERT<span style="color: #ffa07a;">"Failed to setup dev: %d.\n"</span>, err);
<span class="linenr">278: </span>    <span style="color: #ffb6c1; font-size: 105%;">goto</span> <span style="color: #7fffd4;">cleanup</span>;
<span class="linenr">279: </span>    }        
<span class="linenr">280: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#22312;/sys/class/&#30446;&#24405;&#19979;&#21019;&#24314;&#35774;&#22791;&#31867;&#21035;&#30446;&#24405;hello</span>
<span class="linenr">281: </span>    hello_class = class_create(THIS_MODULE, HELLO_DEVICE_CLASS_NAME);
<span class="linenr">282: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(IS_ERR(hello_class))
<span class="linenr">283: </span>    {
<span class="linenr">284: </span>    err = PTR_ERR(hello_class);
<span class="linenr">285: </span>    printk(KERN_ALERT<span style="color: #ffa07a;">"Failed to create hello class.\n"</span>);
<span class="linenr">286: </span>    <span style="color: #ffb6c1; font-size: 105%;">goto</span> <span style="color: #7fffd4;">destroy_cdev</span>;
<span class="linenr">287: </span>    }        
<span class="linenr">288: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#22312;/dev/&#30446;&#24405;&#21644;/sys/class/hello&#30446;&#24405;&#19979;&#20998;&#21035;&#21019;&#24314;&#35774;&#22791;&#25991;&#20214;hello</span>
<span class="linenr">289: </span>    temp = device_create(hello_class, <span style="color: #7fffd4;">NULL</span>, dev, <span style="color: #ffa07a;">"%s"</span>, HELLO_DEVICE_FILE_NAME);
<span class="linenr">290: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(IS_ERR(temp))
<span class="linenr">291: </span>    {
<span class="linenr">292: </span>    err = PTR_ERR(temp);
<span class="linenr">293: </span>    printk(KERN_ALERT<span style="color: #ffa07a;">"Failed to create hello device."</span>);
<span class="linenr">294: </span>    <span style="color: #ffb6c1; font-size: 105%;">goto</span> <span style="color: #7fffd4;">destroy_class</span>;
<span class="linenr">295: </span>    }        
<span class="linenr">296: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#22312;/sys/class/hello/hello&#30446;&#24405;&#19979;&#21019;&#24314;&#23646;&#24615;&#25991;&#20214;val</span>
<span class="linenr">297: </span>    err = device_create_file(temp, &amp;dev_attr_val);
<span class="linenr">298: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(err &lt; 0)
<span class="linenr">299: </span>    {
<span class="linenr">300: </span>    printk(KERN_ALERT<span style="color: #ffa07a;">"Failed to create attribute val."</span>);                
<span class="linenr">301: </span>    <span style="color: #ffb6c1; font-size: 105%;">goto</span> <span style="color: #7fffd4;">destroy_device</span>;
<span class="linenr">302: </span>    }
<span class="linenr">303: </span>    dev_set_drvdata(temp, hello_dev);        
<span class="linenr">304: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21019;&#24314;/proc/hello&#25991;&#20214;</span>
<span class="linenr">305: </span>    hello_create_proc();
<span class="linenr">306: </span>    printk(KERN_ALERT<span style="color: #ffa07a;">"Succedded to initialize hello device.\n"</span>);
<span class="linenr">307: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> 0;
<span class="linenr">308: </span>  <span style="color: #7fffd4;">destroy_device</span>:
<span class="linenr">309: </span>    device_destroy(hello_class, dev);
<span class="linenr">310: </span>  <span style="color: #7fffd4;">destroy_class</span>:
<span class="linenr">311: </span>    class_destroy(hello_class);
<span class="linenr">312: </span>  <span style="color: #7fffd4;">destroy_cdev</span>:
<span class="linenr">313: </span>    cdev_del(&amp;(hello_dev-&gt;dev));
<span class="linenr">314: </span>  <span style="color: #7fffd4;">cleanup</span>:
<span class="linenr">315: </span>    kfree(hello_dev);
<span class="linenr">316: </span>  <span style="color: #7fffd4;">unregister</span>:
<span class="linenr">317: </span>    unregister_chrdev_region(MKDEV(hello_major, hello_minor), 1);
<span class="linenr">318: </span>  <span style="color: #7fffd4;">fail</span>:
<span class="linenr">319: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> err;
<span class="linenr">320: </span>}
<span class="linenr">321: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#27169;&#22359;&#21368;&#36733;&#26041;&#27861;</span>
<span class="linenr">322: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">__exit</span> hello_exit(<span style="color: #ffff00; font-size: 105%;">void</span>)
<span class="linenr">323: </span>{
<span class="linenr">324: </span>    <span style="color: #ffff00; font-size: 105%;">dev_t</span> <span style="color: #ffd700;">devno</span> = MKDEV(hello_major, hello_minor);
<span class="linenr">325: </span>    printk(KERN_ALERT<span style="color: #ffa07a;">"Destroy hello device.\n"</span>);        
<span class="linenr">326: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21024;&#38500;/proc/hello&#25991;&#20214;</span>
<span class="linenr">327: </span>    hello_remove_proc();        
<span class="linenr">328: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#38144;&#27585;&#35774;&#22791;&#31867;&#21035;&#21644;&#35774;&#22791;</span>
<span class="linenr">329: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(hello_class)
<span class="linenr">330: </span>    {
<span class="linenr">331: </span>    device_destroy(hello_class, MKDEV(hello_major, hello_minor));
<span class="linenr">332: </span>    class_destroy(hello_class);
<span class="linenr">333: </span>    }        
<span class="linenr">334: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#21024;&#38500;&#23383;&#31526;&#35774;&#22791;&#21644;&#37322;&#25918;&#35774;&#22791;&#20869;&#23384;</span>
<span class="linenr">335: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(hello_dev)
<span class="linenr">336: </span>    {
<span class="linenr">337: </span>    cdev_del(&amp;(hello_dev-&gt;dev));
<span class="linenr">338: </span>    kfree(hello_dev);
<span class="linenr">339: </span>    }        
<span class="linenr">340: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#37322;&#25918;&#35774;&#22791;&#21495;</span>
<span class="linenr">341: </span>    unregister_chrdev_region(devno, 1);
<span class="linenr">342: </span>}
<span class="linenr">343: </span>MODULE_LICENSE(<span style="color: #ffa07a;">"GPL"</span>);
<span class="linenr">344: </span>MODULE_DESCRIPTION(<span style="color: #ffa07a;">"First Android Driver"</span>);
<span class="linenr">345: </span><span style="color: #1e90ff; font-size: 105%; font-weight: bold;">module_init</span>(hello_init);
<span class="linenr">346: </span><span style="color: #1e90ff; font-size: 105%; font-weight: bold;">module_exit</span>(hello_exit);
</pre>
</div>
</div>
</div>

<div id="outline-container-org9aa346c" class="outline-5">
<h5 id="org9aa346c"><span class="section-number-5">3.13.2.5</span> 驱动构建</h5>
<div class="outline-text-5" id="text-3-13-2-5">
<p>
在hello目录中新增两个文件
</p>
<ul class="org-ul">
<li><p>
Kconfig：在编译前执行配置命令make menuconfig时用到的；
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">1: </span>config HELLO
<span class="linenr">2: </span>tristate <span style="color: #ffa07a;">"First Android Driver"</span>
<span class="linenr">3: </span>default n
<span class="linenr">4: </span>help
<span class="linenr">5: </span>This is the first android driver.
</pre>
</div></li>
<li><p>
Makefile：执行编译命令make是用到的；
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">1: </span>obj-$(CONFIG_HELLO) += hello.o
</pre>
</div></li>
</ul>

<p>
在Kconfig文件中，tristate表示编译选项HELLO支持在编译内核时，hello模块
支持以模块、内建和不编译三种编译方法，默认是不编译，因此，在编译内核
前，我们还需要执行make menuconfig命令来配置编译选项，使得hello可以以
模块或者内建的方法进行编译.
</p>

<p>
在Makefile文件中，根据选项HELLO的值，执行不同的编译方法。
</p>
</div>
</div>

<div id="outline-container-org1b6e662" class="outline-5">
<h5 id="org1b6e662"><span class="section-number-5">3.13.2.6</span> 驱动测试</h5>
<div class="outline-text-5" id="text-3-13-2-6">
<p>
在这个名为hello的Linux内核驱动程序中，创建三个不同的文件节点来供用户
空间访问。
</p>
<ul class="org-ul">
<li>传统的设备文件：/dev/hello；</li>
<li>proc系统文件：/proc/hello；</li>
<li>devfs系统属性文件：/sys/class/hello/hello/val。</li>
</ul>

<p>
进一步，还通过cat命令来直接访问/proc/hello和
/sys/class/hello/hello/val文件来，以验证驱动程序的正确性。 
</p>
<ul class="org-ul">
<li><p>
测试目录
进入到Android源代码工程的external目录，创建hello目录。
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">1: </span>USER-NAME@MACHINE-NAME:~/Android$ cd external
<span class="linenr">2: </span>USER-NAME@MACHINE-NAME:~/Android/external$ mkdir hello
</pre>
</div></li>

<li><p>
测试文件
在hello目录中新建hello.c文件,从/dev/hello文件读写的值实际上就是我们
虚拟的硬件的寄存器val的值。 
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="linenr"> 1: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;stdio.h&gt;</span>
<span class="linenr"> 2: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;stdlib.h&gt;</span>
<span class="linenr"> 3: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;fcntl.h&gt;</span>
<span class="linenr"> 4: </span><span style="color: #87cefa; text-decoration: underline;">#define</span> <span style="color: #ffd700;">DEVICE_NAME</span> <span style="color: #ffa07a;">"/dev/hello"</span>
<span class="linenr"> 5: </span><span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">main</span>(<span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">argc</span>, <span style="color: #ffff00; font-size: 105%;">char</span>** <span style="color: #ffd700;">argv</span>)
<span class="linenr"> 6: </span>{
<span class="linenr"> 7: </span>    <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">fd</span> = -1;
<span class="linenr"> 8: </span>    <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">val</span> = 0;
<span class="linenr"> 9: </span>    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">&#25171;&#24320;/dev/hello&#25991;&#20214;</span>
<span class="linenr">10: </span>    fd = open(DEVICE_NAME, O_RDWR); <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#31995;&#32479;&#35843;&#29992;</span>
<span class="linenr">11: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(fd == -1)
<span class="linenr">12: </span>    {
<span class="linenr">13: </span>    printf(<span style="color: #ffa07a;">"Failed to open device %s.\n"</span>, DEVICE_NAME);
<span class="linenr">14: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> -1;
<span class="linenr">15: </span>    }
<span class="linenr">16: </span>    printf(<span style="color: #ffa07a;">"Read original value:\n"</span>);
<span class="linenr">17: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20808;&#35835;&#20986;/dev/hello&#25991;&#20214;&#20013;&#30340;&#20540;</span>
<span class="linenr">18: </span>    read(fd, &amp;val, <span style="color: #ffb6c1; font-size: 105%;">sizeof</span>(val)); <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#31995;&#32479;&#35843;&#29992;</span>
<span class="linenr">19: </span>    printf(<span style="color: #ffa07a;">"%d.\n\n"</span>, val);
<span class="linenr">20: </span>    val = 5;
<span class="linenr">21: </span>    printf(<span style="color: #ffa07a;">"Write value %d to %s.\n\n"</span>, val, DEVICE_NAME);
<span class="linenr">22: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20889;&#20837;&#20540;5&#21040;/dev/hello&#20013;&#21435;</span>
<span class="linenr">23: </span>    write(fd, &amp;val, <span style="color: #ffb6c1; font-size: 105%;">sizeof</span>(val)); <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#31995;&#32479;&#35843;&#29992;</span>
<span class="linenr">24: </span>    printf(<span style="color: #ffa07a;">"Read the value again:\n"</span>);
<span class="linenr">25: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20877;&#27425;&#35835;&#20986;/dev/hello&#25991;&#20214;&#20013;&#30340;&#20540;</span>
<span class="linenr">26: </span>    read(fd, &amp;val, <span style="color: #ffb6c1; font-size: 105%;">sizeof</span>(val)); <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#31995;&#32479;&#35843;&#29992;</span>
<span class="linenr">27: </span>    printf(<span style="color: #ffa07a;">"%d.\n\n"</span>, val);
<span class="linenr">28: </span>    close(fd);    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#31995;&#32479;&#35843;&#29992;</span>
<span class="linenr">29: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> 0;
<span class="linenr">30: </span>}
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org8d265d4" class="outline-4">
<h4 id="org8d265d4"><span class="section-number-4">3.13.3</span> hal</h4>
<div class="outline-text-4" id="text-3-13-3">
<p>
这里介绍Android系统如何在hal中增加硬件模块来和内核驱动程序交互。完成
内核驱动程序后，可以在Android系统中得到三个文件，这里通过设备文件
/dev/hello来连接硬件抽象层模块和Linux内核驱动程序模块 。 
</p>
<ul class="org-ul">
<li>/dev/hello；</li>
<li>/sys/class/hello/hello/val；</li>
<li>/proc/hello。</li>
</ul>
</div>

<div id="outline-container-orge96b7c6" class="outline-5">
<h5 id="orge96b7c6"><span class="section-number-5">3.13.3.1</span> hal路径</h5>
<div class="outline-text-5" id="text-3-13-3-1">
<p>
进入到在hardware/libhardware/include/hardware目录，新建hello.h文件
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">1: </span>USER-NAME@MACHINE-NAME:~/Android$ cd hardware/libhardware/include/hardware
<span class="linenr">2: </span>USER-NAME@MACHINE-NAME:~/Android/hardware/libhardware/include/hardware$ vi hello.h
</pre>
</div>
</div>
</div>

<div id="outline-container-orgedd7cc8" class="outline-5">
<h5 id="orgedd7cc8"><span class="section-number-5">3.13.3.2</span> hal接口</h5>
<div class="outline-text-5" id="text-3-13-3-2">
<p>
hello.h文件的内容如下
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="linenr"> 1: </span><span style="color: #87cefa; text-decoration: underline;">#if</span><span style="color: #87cefa; text-decoration: underline;">n</span><span style="color: #87cefa; text-decoration: underline;">def</span> ANDROID_HELLO_INTERFACE_H
<span class="linenr"> 2: </span><span style="color: #87cefa; text-decoration: underline;">#define</span> <span style="color: #ffd700;">ANDROID_HELLO_INTERFACE_H</span>
<span class="linenr"> 3: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;hardware/hardware.h&gt;</span>
<span class="linenr"> 4: </span>__BEGIN_DECLS
<span class="linenr"> 5: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#23450;&#20041;&#27169;&#22359;ID</span>
<span class="linenr"> 6: </span><span style="color: #87cefa; text-decoration: underline;">#define</span> <span style="color: #ffd700;">HELLO_HARDWARE_MODULE_ID</span> <span style="color: #ffa07a;">"hello"</span>
<span class="linenr"> 7: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#30828;&#20214;&#27169;&#22359;&#32467;&#26500;&#20307;</span>
<span class="linenr"> 8: </span><span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_module_t</span>
<span class="linenr"> 9: </span>{
<span class="linenr">10: </span>    <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hw_module_t</span> <span style="color: #ffd700;">common</span>;
<span class="linenr">11: </span>};
<span class="linenr">12: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#30828;&#20214;&#25509;&#21475;&#32467;&#26500;&#20307;</span>
<span class="linenr">13: </span><span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_device_t</span>
<span class="linenr">14: </span>{
<span class="linenr">15: </span>    <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hw_device_t</span> <span style="color: #ffd700;">common</span>;
<span class="linenr">16: </span>    <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">fd</span>;<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#35774;&#22791;&#25991;&#20214;&#25551;&#36848;&#31526;&#65292;&#23545;&#24212;/dev/hello</span>
<span class="linenr">17: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#35813;hal&#23545;&#19978;&#25552;&#20379;&#30340;&#20989;&#25968;&#25509;&#21475;</span>
<span class="linenr">18: </span>    <span style="color: #ffff00; font-size: 105%;">int</span> (*set_val)(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_device_t</span>* <span style="color: #ffd700;">dev</span>, <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">val</span>);
<span class="linenr">19: </span>    <span style="color: #ffff00; font-size: 105%;">int</span> (*get_val)(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_device_t</span>* <span style="color: #ffd700;">dev</span>, <span style="color: #ffff00; font-size: 105%;">int</span>* <span style="color: #ffd700;">val</span>);
<span class="linenr">20: </span>};
<span class="linenr">21: </span>__END_DECLS
<span class="linenr">22: </span><span style="color: #87cefa; text-decoration: underline;">#endif</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga5c3e95" class="outline-5">
<h5 id="orga5c3e95"><span class="section-number-5">3.13.3.3</span> hal实现</h5>
<div class="outline-text-5" id="text-3-13-3-3">
<p>
进入hardware/libhardware/modules目录，新建hello目录，添加hello.c文件。  
</p>
<ul class="org-ul">
<li><p>
首先是包含相关头文件和定义相关结构
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="linenr"> 1: </span><span style="color: #87cefa; text-decoration: underline;">#define</span> <span style="color: #ffd700;">LOG_TAG</span> <span style="color: #ffa07a;">"HelloStub"</span>
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;hardware/hardware.h&gt;</span>
<span class="linenr"> 4: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;hardware/hello.h&gt;</span>
<span class="linenr"> 5: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;fcntl.h&gt;</span>
<span class="linenr"> 6: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;errno.h&gt;</span>
<span class="linenr"> 7: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;cutils/log.h&gt;</span>
<span class="linenr"> 8: </span><span style="color: #87cefa; text-decoration: underline;">#include</span> <span style="color: #ffa07a;">&lt;cutils/atomic.h&gt;</span>
<span class="linenr"> 9: </span>
<span class="linenr">10: </span><span style="color: #87cefa; text-decoration: underline;">#define</span> <span style="color: #ffd700;">DEVICE_NAME</span> <span style="color: #ffa07a;">"/dev/hello"</span>
<span class="linenr">11: </span><span style="color: #87cefa; text-decoration: underline;">#define</span> <span style="color: #ffd700;">MODULE_NAME</span> <span style="color: #ffa07a;">"Hello"</span>
<span class="linenr">12: </span><span style="color: #87cefa; text-decoration: underline;">#define</span> <span style="color: #ffd700;">MODULE_AUTHOR</span> <span style="color: #ffa07a;">"shyluo@gmail.com"</span>
<span class="linenr">13: </span>
<span class="linenr">14: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#35774;&#22791;&#25171;&#24320;&#21644;&#20851;&#38381;&#25509;&#21475;</span>
<span class="linenr">15: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_device_open</span>(<span style="color: #ffb6c1; font-size: 105%;">const</span> <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hw_module_t</span>* <span style="color: #ffd700;">module</span>, 
<span class="linenr">16: </span>                 <span style="color: #ffb6c1; font-size: 105%;">const</span> <span style="color: #ffff00; font-size: 105%;">char</span>* <span style="color: #ffd700;">name</span>,
<span class="linenr">17: </span>                 <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hw_device_t</span> * * <span style="color: #ffd700;">device</span>);
<span class="linenr">18: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_device_close</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hw_device_t</span>* <span style="color: #ffd700;">device</span>);
<span class="linenr">19: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#35774;&#22791;&#35775;&#38382;&#25509;&#21475;</span>
<span class="linenr">20: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_set_val</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_device_t</span>* <span style="color: #ffd700;">dev</span>, <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">val</span>);
<span class="linenr">21: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_get_val</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_device_t</span>* <span style="color: #ffd700;">dev</span>, <span style="color: #ffff00; font-size: 105%;">int</span>* <span style="color: #ffd700;">val</span>);
<span class="linenr">22: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#27169;&#22359;&#26041;&#27861;&#34920;</span>
<span class="linenr">23: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hw_module_methods_t</span> <span style="color: #ffd700;">hello_module_methods</span> =
<span class="linenr">24: </span>{<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#36890;&#36807;&#35813;&#26041;&#27861;&#25171;&#24320;/dev/hello&#35774;&#22791;&#25991;&#20214;&#65292;&#29992;malloc&#20570;&#20869;&#23384;&#26144;&#23556;&#65292;</span>
<span class="linenr">25: </span> <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#23601;&#21487;&#20197;&#35775;&#38382;&#35813;&#39537;&#21160;&#25991;&#20214;&#30340;&#21508;&#31181;&#26041;&#27861;&#21644;&#23646;&#24615;</span>
<span class="linenr">26: </span>  open: hello_device_open
<span class="linenr">27: </span>};
<span class="linenr">28: </span><span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#27169;&#22359;&#23454;&#20363;&#21464;&#37327;&#65292;hal&#35268;&#23450;&#35813;&#21517;&#31216;&#22266;&#23450;</span>
<span class="linenr">29: </span><span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_module_t</span> <span style="color: #ffd700;">HAL_MODULE_INFO_SYM</span> =
<span class="linenr">30: </span>{
<span class="linenr">31: </span>  common: {
<span class="linenr">32: </span>      <span style="color: #7fffd4;">tag</span>: HARDWARE_MODULE_TAG,<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">hal&#35268;&#23450;&#35813;&#21517;&#31216;&#22266;&#23450;</span>
<span class="linenr">33: </span>      version_major: 1,
<span class="linenr">34: </span>      version_minor: 0,
<span class="linenr">35: </span>      id: HELLO_HARDWARE_MODULE_ID,<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">hal&#35268;&#23450;&#35813;&#21517;&#31216;&#22266;&#23450;</span>
<span class="linenr">36: </span>      name: MODULE_NAME,
<span class="linenr">37: </span>      author: MODULE_AUTHOR,
<span class="linenr">38: </span>      methods: &amp;hello_module_methods,<span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#19978;&#38754;&#30340;&#26041;&#27861;&#34920;</span>
<span class="linenr">39: </span>  }
<span class="linenr">40: </span>};
</pre>
</div></li>

<li><p>
定义hello<sub>device</sub><sub>open函数</sub>.
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="linenr">41: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_device_open</span>(<span style="color: #ffb6c1; font-size: 105%;">const</span> <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hw_module_t</span>* <span style="color: #ffd700;">module</span>,
<span class="linenr">42: </span>                 <span style="color: #ffb6c1; font-size: 105%;">const</span> <span style="color: #ffff00; font-size: 105%;">char</span>* <span style="color: #ffd700;">name</span>,
<span class="linenr">43: </span>                 <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hw_device_t</span> * * <span style="color: #ffd700;">device</span>)
<span class="linenr">44: </span>{
<span class="linenr">45: </span>    <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_device_t</span>* <span style="color: #ffd700;">dev</span>;
<span class="linenr">46: </span>    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">/dev/hello&#30340;&#20869;&#23384;&#26144;&#23556;buffer</span>
<span class="linenr">47: </span>    dev = (<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_device_t</span>*)malloc(<span style="color: #ffb6c1; font-size: 105%;">sizeof</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_device_t</span>));
<span class="linenr">48: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(!dev)
<span class="linenr">49: </span>    {
<span class="linenr">50: </span>    LOGE(<span style="color: #ffa07a;">"Hello Stub: failed to alloc space"</span>);
<span class="linenr">51: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> -EFAULT;
<span class="linenr">52: </span>    }
<span class="linenr">53: </span>    memset(dev, 0, <span style="color: #ffb6c1; font-size: 105%;">sizeof</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_device_t</span>));
<span class="linenr">54: </span>    <span style="color: #90ee90; font-style: italic;">// </span><span style="color: #90ee90; font-style: italic;">hal&#35268;&#23450;&#35813;&#21517;&#31216;&#22266;&#23450;</span>
<span class="linenr">55: </span>    dev-&gt;common.tag = HARDWARE_DEVICE_TAG;
<span class="linenr">56: </span>    dev-&gt;common.version = 0;
<span class="linenr">57: </span>    dev-&gt;common.module = (<span style="color: #ffff00; font-size: 105%;">hw_module_t</span>*)module;
<span class="linenr">58: </span>    dev-&gt;common.close = hello_device_close;
<span class="linenr">59: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">hal&#23545;&#19978;&#23618;&#30340;&#26041;&#27861;&#26144;&#23556;</span>
<span class="linenr">60: </span>    dev-&gt;set_val = hello_set_val;
<span class="linenr">61: </span>    dev-&gt;get_val = hello_get_val;
<span class="linenr">62: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>((dev-&gt;fd = open(DEVICE_NAME, O_RDWR)) == -1)
<span class="linenr">63: </span>    {
<span class="linenr">64: </span>    LOGE(<span style="color: #ffa07a;">"Hello Stub: failed to open /dev/hello -- %s."</span>, 
<span class="linenr">65: </span>         strerror(errno));
<span class="linenr">66: </span>    free(dev);
<span class="linenr">67: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> -EFAULT;
<span class="linenr">68: </span>    }
<span class="linenr">69: </span>    *device = &amp;(dev-&gt;common);
<span class="linenr">70: </span>    LOGI(<span style="color: #ffa07a;">"Hello Stub: open /dev/hello successfully."</span>);
<span class="linenr">71: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> 0;
<span class="linenr">72: </span>}
<span class="linenr">73: </span>
</pre>
</div></li>

<li><p>
定义hello<sub>device</sub><sub>close</sub>、hello<sub>set</sub><sub>val和hello</sub><sub>get</sub><sub>val这三个函数</sub>
</p>
<div class="org-src-container">
<pre class="src src-c"><span class="linenr"> 74: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_device_close</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hw_device_t</span>* <span style="color: #ffd700;">device</span>)
<span class="linenr"> 75: </span>{
<span class="linenr"> 76: </span>    <span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_device_t</span>* <span style="color: #ffd700;">hello_device</span> = (<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_device_t</span>*)device;
<span class="linenr"> 77: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(hello_device)
<span class="linenr"> 78: </span>    {
<span class="linenr"> 79: </span>    close(hello_device-&gt;fd);
<span class="linenr"> 80: </span>    free(hello_device);
<span class="linenr"> 81: </span>    }
<span class="linenr"> 82: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> 0;
<span class="linenr"> 83: </span>}
<span class="linenr"> 84: </span>
<span class="linenr"> 85: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_set_val</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_device_t</span>* <span style="color: #ffd700;">dev</span>, <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #ffd700;">val</span>)
<span class="linenr"> 86: </span>{
<span class="linenr"> 87: </span>    LOGI(<span style="color: #ffa07a;">"Hello Stub: set value %d to device."</span>, val);
<span class="linenr"> 88: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#31995;&#32479;&#35843;&#29992;</span>
<span class="linenr"> 89: </span>    write(dev-&gt;fd, &amp;val, <span style="color: #ffb6c1; font-size: 105%;">sizeof</span>(val));
<span class="linenr"> 90: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> 0;
<span class="linenr"> 91: </span>}
<span class="linenr"> 92: </span>
<span class="linenr"> 93: </span><span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">int</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">hello_get_val</span>(<span style="color: #ffb6c1; font-size: 105%;">struct</span> <span style="color: #ffff00; font-size: 105%;">hello_device_t</span>* <span style="color: #ffd700;">dev</span>, <span style="color: #ffff00; font-size: 105%;">int</span>* <span style="color: #ffd700;">val</span>)
<span class="linenr"> 94: </span>{
<span class="linenr"> 95: </span>    <span style="color: #ffb6c1; font-size: 105%;">if</span>(!val)
<span class="linenr"> 96: </span>    {
<span class="linenr"> 97: </span>    LOGE(<span style="color: #ffa07a;">"Hello Stub: error val pointer"</span>);
<span class="linenr"> 98: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> -EFAULT;
<span class="linenr"> 99: </span>    }
<span class="linenr">100: </span>    <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#31995;&#32479;&#35843;&#29992; </span>
<span class="linenr">101: </span>    read(dev-&gt;fd, val, <span style="color: #ffb6c1; font-size: 105%;">sizeof</span>(*val));
<span class="linenr">102: </span>    LOGI(<span style="color: #ffa07a;">"Hello Stub: get value %d from device"</span>, *val);
<span class="linenr">103: </span>    <span style="color: #ffb6c1; font-size: 105%;">return</span> 0;
<span class="linenr">104: </span>}
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgdde0acd" class="outline-5">
<h5 id="orgdde0acd"><span class="section-number-5">3.13.3.4</span> hal构建</h5>
<div class="outline-text-5" id="text-3-13-3-4">
<ul class="org-ul">
<li><p>
mk文件
继续在hello目录下新建Android.mk文件, LOCAL<sub>MODULE的定义规则</sub>，hello
后面跟有default，hello.default能够保证我们的模块总能被hal层加载到。  
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">1: </span>LOCAL_PATH := $(call my-dir)
<span class="linenr">2: </span>        include $(CLEAR_VARS)
<span class="linenr">3: </span>        LOCAL_MODULE_TAGS := optional
<span class="linenr">4: </span>        LOCAL_PRELINK_MODULE := false
<span class="linenr">5: </span>        LOCAL_MODULE_PATH := $(TARGET_OUT_SHARED_LIBRARIES)/hw
<span class="linenr">6: </span>        LOCAL_SHARED_LIBRARIES := liblog
<span class="linenr">7: </span>        LOCAL_SRC_FILES := hello.c
<span class="linenr">8: </span>        LOCAL_MODULE := hello.default
<span class="linenr">9: </span>include $(BUILD_SHARED_LIBRARY)
</pre>
</div></li>

<li><p>
编译
编译成功后，就可以在out/target/product/generic/system/lib/hw目录下
看到hello.default.so文件了。 
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">1: </span>USER-NAME@MACHINE-NAME:~/Android$ mmm hardware/libhardware/modules/hello
</pre>
</div></li>

<li><p>
打包
重新打包Android系统镜像system.img, 就包含我们定义的硬件抽象层模块
hello.default了。 
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="linenr">1: </span>USER-NAME@MACHINE-NAME:~/Android$ make snod
</pre>
</div>

<p>
虽然我们在Android系统为我们自己的硬件增加了一个硬件抽象层模块，但是
现在Java应用程序还不能访问到我们的硬件。我们还必须编写JNI方法和在
Android的Application Frameworks层增加API接口，才能让上层Application
访问我们的硬件。在接下来的文章中，我们还将完成这一系统过程，使得我
们能够在Java应用程序中访问我们自己定制的硬件。 
</p></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgb3917e9" class="outline-4">
<h4 id="orgb3917e9"><span class="section-number-4">3.13.4</span> jni</h4>
</div>
<div id="outline-container-org957db4b" class="outline-4">
<h4 id="org957db4b"><span class="section-number-4">3.13.5</span> framework</h4>
</div>
</div>
</div>
<div id="outline-container-org7d6b302" class="outline-2">
<h2 id="org7d6b302"><span class="section-number-2">4</span> rtos</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgf0807c4" class="outline-3">
<h3 id="orgf0807c4"><span class="section-number-3">4.1</span> FreeRTOS</h3>
<div class="outline-text-3" id="text-4-1">
<p>
FreeRTOS是一个迷你操作系统内核的小型嵌入式系统。作为一个轻量级的操作系统，
功能包括：任务管理、时间管理、信号量、消息队列、内存管理、记录功能等，可基
本满足较小系统的需要。 功能和特点: 
</p>
<ul class="org-ul">
<li>混合配置选项;</li>
<li>提供一个高层次的信任代码的完整性;</li>
<li>目的是小，简单易用;</li>
<li>以开发C，非常便携代码结构;</li>
<li>支持两项任务和共同例程;</li>
<li>强大的执行跟踪功能;</li>
<li>堆栈溢出检测 ;</li>
<li>没有软件任务的限制数量;</li>
<li>没有软件优先事项的限制数量;</li>
<li>没有施加的限制，优先转让，多个任务可以分配相同的优先权;</li>
<li>队列，二进制信号量，计数信号灯和递归通信和同步的任务 ;</li>
<li>Mutexes优先继承权;</li>
<li>免费开发工具;</li>
<li>免费嵌入式软件的源代码;</li>
<li>从一个标准的Windows主机交叉发展;</li>
</ul>
</div>
<div id="outline-container-orga611acd" class="outline-4">
<h4 id="orga611acd"><span class="section-number-4">4.1.1</span> 术语</h4>
<div class="outline-text-4" id="text-4-1-1">
<ul class="org-ul">
<li>PV操作：P源自于荷兰语parsseren，即英语的pass；V源自于荷兰语verhoog，即英
语的increment。P(S)V(S)操作是信号量的两个原子操作，S为信号量semaphore，相
当于一个标志，可以代表一个资源，一个事件等；</li>
<li>变量的非原子操作：更新结构体的多个成员变量，或者是更新的变量其长度超过了
架构体系的自然长度(比如，更新一个16位机上的32位变量)均是非原子操作，如果
这样的操作被中断，将可能导致数据损坏或者丢失；</li>
<li>函数重入：如果一个函数可以安全的被多个任务调用，或在任务与中断中均可调用，
则这个函数是可以重入的；一般每个任务都单独维护自己的栈空间及其自身在内存
寄存器组中的值。如果一个函数除访问自己栈空间上分配的数据或是内核寄存器中
的数据外，会访问其他任何数据，则这个函数是不可重入的。</li>
<li>临界区：当某资源需要被多个任务访问使用时，此资源叫临界区，开始访问此资源，
表示进入临界区；如果要进入临界区，一般安全的做饭是讲所有的中断或者优先级
关闭，防止在访问临界区资源时，被打断，并且访问临界区资源的程序必须要尽快
结束；</li>
<li>二值信号量：用于同步，可以给某资源配置一个二值信号量，当一个任务要访问某
资源时，如果此二值信号量不可用，则该任务不可访问该资源，可以通过在中断中
给予(GIVE)此信号量，则此任务就可以获得(TAKE)该信号量，访问该资源，达到同
步作用，用于同步的信号量，用完后便丢弃，不再归还；</li>
<li>互斥信号量：用于访问一些具有互斥效果的资源，类似二值信号量，当某任务需要
访问某资源时，需要先获得(TAKE)该资源的令牌(信号量)，用完后，再归还(GIVE)
该资源的令牌，一个任务只有获得了该资源的令牌后才能访问该资源，否则不允许
访问进入阻塞状态，用于互斥的信号量必须归还；</li>
<li>优先级翻转：指两个不同优先级的任务在允许时，低优先级的任务获得了某资源的
互斥信号量，并未执行完，此时高优先级的任务也开始运行，并且也要使用该资源，
从而获取该资源的互斥信号量，然后此时低优先级的任务并未释放该互斥信号量，
则高优先级的任务进入阻塞状态，等待低优先级的任务执行完释放信号量，从而产
生了高优先级的任务等待低优先级任务的不合理现象；</li>
<li>死锁：当两个任务都在等待被对方持有的资源时，两个任务都无法继续执行，这种
情况被称为死锁；</li>
<li>守护任务：守护任务提供了一个比较好的方法来实现互斥功能，而不用担心会发生
优先级翻转和死锁，守护任务是对某个资源具有唯一所有权的任务，只有守护任务
才可直接访问其守护的资源，其他任何任务只能间接的通过守护任务提供访问服务；</li>
</ul>
</div>
</div>
<div id="outline-container-orgf783fec" class="outline-4">
<h4 id="orgf783fec"><span class="section-number-4">4.1.2</span> 源码解读</h4>
<div class="outline-text-4" id="text-4-1-2">
</div>
<div id="outline-container-orge62864f" class="outline-5">
<h5 id="orge62864f"><span class="section-number-5">4.1.2.1</span> 文件</h5>
<div class="outline-text-5" id="text-4-1-2-1">
</div>
<ol class="org-ol">
<li><a id="org5d8d3fa"></a>FreeRTOS.h<br />
<div class="outline-text-6" id="text-4-1-2-1-1">
<p>
每一个使用了FreeRTOS的程序都需要包含的一个头文件；
</p>
</div>
</li>
<li><a id="orgaa372d8"></a>projdefs.h<br />
<div class="outline-text-6" id="text-4-1-2-1-2">
<p>
包含了FreeRTOS的一些基本设定，主要定义了如下一些宏定义
</p>
<div class="org-src-container">
<pre class="src src-c">pdTASK_CODE   <span style="color: #90ee90; font-style: italic;">//</span><span style="color: #90ee90; font-style: italic;">&#20219;&#21153;&#20989;&#25968;&#21407;&#22411;&#31867;&#22411;</span>
pdFALSE
pdTRUE
pdPASS
pdFAIL
errQUEUE_EMPTY
errQUEUE_FULL
errCOULD_NOT_ALLOCATE_REQUIRED_MEMORY
errNO_TASK_TO_RUN
<span style="color: #ffff00; font-size: 105%;">errQUEUE_BLOCKED</span>
<span style="color: #ffd700;">errQUEUE_YIELD</span>
</pre>
</div>
</div>
</li>
<li><a id="org2394c2e"></a>FreeRTOSConfig.h<br />
<div class="outline-text-6" id="text-4-1-2-1-3">
<p>
移植的时候要修改的FreeRTOS的全局配置文件; 
</p>
</div>
</li>
<li><a id="orgb587aa3"></a>portable.h<br /></li>
</ol>
</div>
<div id="outline-container-org7a8448c" class="outline-5">
<h5 id="org7a8448c"><span class="section-number-5">4.1.2.2</span> 功能函数</h5>
<div class="outline-text-5" id="text-4-1-2-2">
</div>
<ol class="org-ol">
<li><a id="orga983711"></a>任务生成<br />
<div class="outline-text-6" id="text-4-1-2-2-1">
<p>
任务生成使用xTaskGenericCreate函数，并且被宏包装为xTaskCreate； 
</p>
</div>
</li>
<li><a id="orge627b39"></a>任务删除<br /></li>
<li><a id="org8155f24"></a>堆操作<br />
<div class="outline-text-6" id="text-4-1-2-2-3">
<p>
堆并不神秘，在cortex-m0芯片中，堆和栈其实都是用的ram区，只是认为的堆ram区做
了划分，也就是说，完全可以人为的定义一个大的数组来表示堆空间，然后对数组进
行块分割，并且分配给申请者，管理需要释放的数组元素，就是堆空间的分配和释放
操作，基于此，根据堆操作功能复杂度，细化出了heap\<sub>1.c</sub>、heap\<sub>2.c</sub>、heap\<sub>4.c</sub>、
heap\<sub>5.c的堆操作功能库</sub>，至于heap\<sub>3.c完全是使用标准C库的malloc等函数做的封</sub>
装，因为标准C库的malloc等函数不是线程安全的函数，需要封装为安全的，所谓的封
装为线程安全的，也就是在执行malloc前后关闭打开中断和调度器；另外对申请的堆
空间地址和长度还涉及到对齐等细节功能操作； 
</p>
<ul class="org-ul">
<li><p>
heap\<sub>1.c</sub>: 只有简单的堆空间申请操作，没有释放操作；
</p>
<div class="org-src-container">
<pre class="src src-c">    <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">portBYTE_ALIGNMENT:&#36825;&#20010;&#24120;&#37327;&#25351;&#31034;&#23383;&#33410;&#23545;&#40784;&#25968;&#65292;&#20854;&#40664;&#35748;&#20540;&#20026;8&#65292;&#21363;&#40664;&#35748;&#20197;8&#20010;</span>
<span style="color: #90ee90; font-style: italic;">     * &#23383;&#33410;&#36827;&#34892;&#20869;&#23384;&#23545;&#40784; </span>
<span style="color: #90ee90; font-style: italic;">     </span><span style="color: #90ee90; font-style: italic;">*/</span> 
    <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">portBYTE_ALIGNMENT_MASK:&#36825;&#20010;&#24120;&#37327;&#26159;&#26681;&#25454;portBYTE_ALIGNMENT&#30340;&#20540;&#36827;&#34892;&#23450;&#20041;&#30340; </span><span style="color: #90ee90; font-style: italic;">*/</span>
    <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">FreeRTOS&#23545;&#22534;&#25968;&#32452;&#36827;&#34892;&#22320;&#22336;&#23545;&#40784;&#25805;&#20316;&#65292;&#36825;&#26679;&#30340;&#21518;&#26524;&#23601;&#26159;&#35201;&#26159;&#21407;&#26412;&#22534;&#25968;&#32452;&#39318;&#22320;&#22336;</span>
<span style="color: #90ee90; font-style: italic;">     * &#27809;&#26377;&#23545;&#40784;&#65292;&#21017;&#36827;&#34892;&#23545;&#40784;&#25805;&#20316;&#21518;&#23601;&#20250;&#20351;&#22534;&#22823;&#23567;&#25913;&#21464;&#20102;&#12290;&#22240;&#27492;&#65292;FreeRTOS&#23545;&#22534;&#25968;&#32452;</span>
<span style="color: #90ee90; font-style: italic;">     * &#30340;&#22823;&#23567;&#36827;&#34892;&#37325;&#26032;&#23450;&#20041;&#12290;  </span>
<span style="color: #90ee90; font-style: italic;">     </span><span style="color: #90ee90; font-style: italic;">*/</span>
<span style="color: #87cefa; text-decoration: underline;">#define</span> <span style="color: #ffd700;">configADJUSTED_HEAP_SIZE</span>    ( configTOTAL_HEAP_SIZE - portBYTE_ALIGNMENT )
<span style="color: #ffa07a;">/**</span>
<span style="color: #ffa07a;"> * &#25968;&#32452;&#30340;&#24635;&#22823;&#23567;(&#23383;&#33410;&#20026;&#21333;&#20301;)&#22312;FreeRTOSConfig.h&#20013;&#30001;configTOTAL_HEAP_SIZE&#23450;&#20041;&#12290;</span>
<span style="color: #ffa07a;"> * &#20197;&#36825;&#31181;&#26041;&#24335;&#23450;&#20041;&#19968;&#20010;&#24040;&#22411;&#25968;&#32452;&#20250;&#35753;&#25972;&#20010;&#24212;&#29992;&#31243;&#24207;&#30475;&#36215;&#26469;&#32791;&#36153;&#20102;&#35768;&#22810;&#20869;&#23384;</span>
<span style="color: #ffa07a;"> * ucHeap&#23601;&#26159;FreeRTOS&#21487;&#20197;&#29992;&#30340;&#25972;&#20010;&#22534;&#30340;&#31354;&#38388;&#25968;&#32452;&#65292;&#20854;&#22823;&#23567;&#26159;&#22312;FreeRTOSConfig.h&#20013;</span>
<span style="color: #ffa07a;"> * &#23450;&#20041;&#30340;&#24120;&#37327;configTOTAL_HEAP_SIZE&#65292; </span>
<span style="color: #ffa07a;"> * &#40664;&#35748;&#26159;17*1024&#65292;&#21363;17KB</span>
<span style="color: #ffa07a;"> */</span>
<span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">uint8_t</span> <span style="color: #ffd700;">ucHeap</span>[ configTOTAL_HEAP_SIZE ];
<span style="color: #90ee90; font-style: italic;">///</span><span style="color: #90ee90; font-style: italic;">&#25351;&#21521;&#19979;&#19968;&#20010;&#36824;&#27809;&#34987;&#29992;&#19978;&#30340;&#20869;&#23384;&#22534;&#25152;&#22312;&#30340;&#25968;&#32452;&#19979;&#26631;&#65292;&#30001;&#20110;&#19968;&#24320;&#22987;&#25972;&#20010;&#22534;&#37117;&#27809;&#34987;&#29992;&#19978;&#65292;</span>
<span style="color: #90ee90; font-style: italic;">///</span><span style="color: #90ee90; font-style: italic;">&#25152;&#20197;&#23427;&#30340;&#40664;&#35748;&#20540;&#20026;0 </span>
<span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">size_t</span> <span style="color: #ffd700;">xNextFreeByte</span> = ( <span style="color: #ffff00; font-size: 105%;">size_t</span> ) 0;

<span style="color: #90ee90; font-style: italic;">/*</span><span style="color: #90ee90; font-style: italic;">-----------------------------------------------------------</span><span style="color: #90ee90; font-style: italic;">*/</span>
<span style="color: #90ee90; font-style: italic;">/** </span>
<span style="color: #90ee90; font-style: italic;"> * </span><span style="color: #ffb6c1; font-size: 105%; font-style: italic;">@brief</span><span style="color: #90ee90; font-style: italic;"> &#36825;&#31181;&#20998;&#37197;&#26041;&#26696;&#26159;&#23558; FreeRTOS &#30340;&#20869;&#23384;&#22534;&#31354;&#38388;&#30475;&#20316;&#19968;&#20010;&#31616;&#21333;&#30340;&#25968;&#32452;&#12290;</span>
<span style="color: #90ee90; font-style: italic;"> * &#24403;&#35843;&#29992;pvPortMalloc()&#26102;&#65292;&#21017;&#23558;&#25968;&#32452;&#21448;&#31616;&#21333;&#22320;&#32454;&#20998;&#20026;&#26356;&#23567;&#30340;&#20869;&#23384;&#22359;&#12290;&#20989;&#25968;&#25805;&#20316;&#27969;&#31243;</span>
<span style="color: #90ee90; font-style: italic;"> * &#31532;&#19968;&#27493;&#65306;&#23545;&#40784;&#22788;&#29702;&#65307;&#31532;&#20108;&#27493;&#65306;&#20998;&#37197;&#20869;&#23384;&#65307;&#31532;&#19977;&#27493;&#65306;&#21246;&#23376;&#20989;&#25968;&#35843;&#29992;&#12290;</span>
<span style="color: #90ee90; font-style: italic;"> * </span><span style="color: #ffb6c1; font-size: 105%; font-style: italic;">@param</span><span style="color: #90ee90; font-style: italic;"> </span><span style="color: #ffd700; font-style: italic;">xWantedSize</span><span style="color: #90ee90; font-style: italic;"> &#27442;&#20998;&#37197;&#30340;&#31354;&#38388;&#22823;&#23567;</span>
<span style="color: #90ee90; font-style: italic;"> </span><span style="color: #90ee90; font-style: italic;">*/</span>
<span style="color: #ffff00; font-size: 105%;">void</span> *<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">pvPortMalloc</span>( <span style="color: #ffff00; font-size: 105%;">size_t</span> <span style="color: #ffd700;">xWantedSize</span> )
{
    <span style="color: #ffff00; font-size: 105%;">void</span> *<span style="color: #ffd700;">pvReturn</span> = <span style="color: #7fffd4;">NULL</span>;
    <span style="color: #ffb6c1; font-size: 105%;">static</span> <span style="color: #ffff00; font-size: 105%;">uint8_t</span> *<span style="color: #ffd700;">pucAlignedHeap</span> = <span style="color: #7fffd4;">NULL</span>;
    <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">**************************************&#31532;&#19968;&#27493;********************************* </span><span style="color: #90ee90; font-style: italic;">*/</span>
    <span style="color: #90ee90; font-style: italic;">/** </span><span style="color: #90ee90; font-style: italic;">&#29992;&#26469;&#21028;&#26029;&#29992;&#25143;&#25152;&#38656;&#35201;&#30340;&#20869;&#23384;&#22823;&#23567;&#26159;&#21542;&#24050;&#23545;&#40784;&#65292;&#20363;&#22914;&#65292;&#22312;&#40664;&#35748;&#24773;&#20917;&#19979;&#65288;&#20197;8&#20010;&#23383;&#33410;&#23545;&#40784;&#65289;&#65292;</span>
<span style="color: #90ee90; font-style: italic;">     * &#22914;&#26524;&#29992;&#25143;&#30003;&#35831;&#30340;&#20869;&#23384;&#22823;&#23567;&#20026;13&#20010;&#23383;&#33410;&#65292;&#32463;&#36807;&#21644;&#23383;&#33410;&#23545;&#40784;&#25513;&#30721;&#36827;&#34892;&#19982;&#25805;&#20316;&#21518;&#30340;&#32467;&#26524;&#20026;0x0005&#65292;&#21363;&#27809;&#26377;&#23545;&#40784;&#65307;</span>
<span style="color: #90ee90; font-style: italic;">     * &#22914;&#26524;&#29992;&#25143;&#30003;&#35831;&#30340;&#20869;&#23384;&#22823;&#23567;&#20026;16&#20010;&#23383;&#33410;&#65292;&#32463;&#36807;&#21644;&#23383;&#33410;&#23545;&#40784;&#25513;&#30721;&#36827;&#34892;&#19982;&#25805;&#20316;&#21518;&#30340;&#32467;&#26524;&#20026;0x0000&#65292;&#21363;&#24050;&#32463;&#23545;&#40784;&#12290; </span>
<span style="color: #90ee90; font-style: italic;">     </span><span style="color: #90ee90; font-style: italic;">*/</span>
<span style="color: #87cefa; text-decoration: underline;">    #if</span> portBYTE_ALIGNMENT != 1 
    <span style="color: #ffb6c1; font-size: 105%;">if</span>( xWantedSize &amp; portBYTE_ALIGNMENT_MASK )
    {
    <span style="color: #90ee90; font-style: italic;">/** </span><span style="color: #90ee90; font-style: italic;">&#29992;&#25143;&#30003;&#35831;&#20869;&#23384;&#22823;&#23567;&#21644;&#23383;&#33410;&#23545;&#40784;&#25513;&#30721;&#36827;&#34892;&#19982;&#25805;&#20316;&#21518;&#65292;&#20854;&#32467;&#26524;&#21644;&#38656;&#35201;&#34917;&#40784;&#30340;&#23383;&#33410;&#25968;&#30456;&#21152;&#65292;</span>
<span style="color: #90ee90; font-style: italic;">     * &#21018;&#22909;&#31561;&#20110;&#23383;&#33410;&#23545;&#40784;&#25513;&#30721;&#30340;&#20540;&#65292;&#22240;&#27492;&#21482;&#35201;&#29992;&#25513;&#30721;&#20540;&#20943;&#21435;&#19982;&#25805;&#20316;&#30340;&#32467;&#26524;&#65292;&#23601;&#21487;&#20197;&#24471;&#21040;&#38656;&#35201;&#34917;&#40784;&#30340;&#23383;&#33410;&#25968;&#65292;</span>
<span style="color: #90ee90; font-style: italic;">     * &#36825;&#26679;&#21482;&#35201;&#25226;&#34917;&#40784;&#30340;&#23383;&#33410;&#25968;&#21152;&#21040;&#29992;&#25143;&#30003;&#35831;&#30340;&#20869;&#23384;&#22823;&#23567;&#23601;&#21487;&#20197;&#20351;&#20854;&#23383;&#33410;&#23545;&#40784; </span>
<span style="color: #90ee90; font-style: italic;">     </span><span style="color: #90ee90; font-style: italic;">*/</span>
    xWantedSize += ( portBYTE_ALIGNMENT - ( xWantedSize &amp; portBYTE_ALIGNMENT_MASK ) );
    }
<span style="color: #87cefa; text-decoration: underline;">    #endif</span>

    <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">**************************************&#31532;&#20108;&#27493;********************************* </span><span style="color: #90ee90; font-style: italic;">*/</span>
    vTaskSuspendAll();
    {
    <span style="color: #90ee90; font-style: italic;">/** </span><span style="color: #90ee90; font-style: italic;">&#23545;&#36825;&#20010;&#22534;&#36827;&#34892;&#23545;&#40784;&#24037;&#20316;&#12290;&#36825;&#37324;&#30340;&#23545;&#40784;&#21644;&#19978;&#38754;&#35828;&#30340;&#23545;&#40784;&#19981;&#26159;&#19968;&#22238;&#20107;&#12290;</span>
<span style="color: #90ee90; font-style: italic;">     * &#36825;&#37324;&#35828;&#30340;&#23545;&#40784;&#26159;&#22240;&#20026;FreeRTOS&#31649;&#29702;&#30340;&#22534;&#26159;&#19968;&#20010;&#20840;&#23616;&#25968;&#32452;&#65292;</span>
<span style="color: #90ee90; font-style: italic;">     * &#24182;&#19981;&#33021;&#20445;&#35777;&#25968;&#32452;&#39318;&#22320;&#22336;&#25353;portBYTE_ALIGNMENT&#23545;&#40784;&#12290;</span>
<span style="color: #90ee90; font-style: italic;">     * &#22240;&#27492;FreeRTOS&#23545;&#22534;&#39318;&#22320;&#22336;&#20570;&#20102;&#36825;&#20010;&#23545;&#40784;&#22788;&#29702;&#12290;&#35201;&#30041;&#24847;&#30340;&#26159;&#65292;&#36825;&#20010;&#23545;&#40784;&#22788;&#29702;&#21482;&#20570;&#20102;&#19968;&#27425;&#12290;</span>
<span style="color: #90ee90; font-style: italic;">     * &#21407;&#22240;&#26159;&#23545;&#40784;&#21518;&#30340;&#22534;&#39318;&#22320;&#22336;&#26159;&#19968;&#20010;&#38745;&#24577;&#21464;&#37327;&#65292;&#21021;&#22987;&#20540;&#36171;&#20026;NULL&#12290;</span>
<span style="color: #90ee90; font-style: italic;">     * &#32780;&#24403;&#36825;&#20010;&#21464;&#37327;&#20026;NULL&#26102;&#25165;&#36827;&#34892;&#23545;&#40784;&#22788;&#29702;&#65292;&#23545;&#40784;&#22788;&#29702;&#21518;&#36825;&#20010;&#21464;&#37327;&#23601;&#25351;&#21521;&#22534;&#39318;&#22320;&#22336;&#65292;</span>
<span style="color: #90ee90; font-style: italic;">     * &#36825;&#26679;&#22312;&#19979;&#19968;&#27425;&#35843;&#29992;pvPortMalloc()&#26102;&#23601;&#19981;&#20250;&#20877;&#36827;&#34892;&#23545;&#40784;&#22788;&#29702;&#20102; </span>
<span style="color: #90ee90; font-style: italic;">     </span><span style="color: #90ee90; font-style: italic;">*/</span>
        <span style="color: #ffb6c1; font-size: 105%;">if</span>( pucAlignedHeap == <span style="color: #7fffd4;">NULL</span> ) <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">&#31532;&#19968;&#27425;&#21021;&#22987;&#21270;heap </span><span style="color: #90ee90; font-style: italic;">*/</span>
        {
        <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">ucHeap&#24448;&#21069;&#25386;&#21160;&#19968;&#20010;portBYTE_ALIGNMENT&#38271;&#24230;&#30340;&#22320;&#22336;&#65292;&#20570;&#23545;&#40784;&#21518;&#65292;&#25165;&#33021;&#20445;&#35777;&#23545;&#40784;&#21518;&#30340;&#22320;&#22336;&#36824;&#22312;ucHeap&#25968;&#32452;&#33539;&#22260;&#20869; </span><span style="color: #90ee90; font-style: italic;">*/</span>
            pucAlignedHeap = ( <span style="color: #ffff00; font-size: 105%;">uint8_t</span> * ) ( ( ( portPOINTER_SIZE_TYPE ) &amp;ucHeap[ portBYTE_ALIGNMENT ] ) &amp;
                         ( ~( ( <span style="color: #ffff00; font-size: 105%;">portPOINTER_SIZE_TYPE</span> ) portBYTE_ALIGNMENT_MASK ) ) );
        }

        <span style="color: #ffb6c1; font-size: 105%;">if</span>( ( ( xNextFreeByte + xWantedSize ) &lt; configADJUSTED_HEAP_SIZE ) &amp;&amp;
            ( ( xNextFreeByte + xWantedSize ) &gt; xNextFreeByte ) )<span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">Check for overflow. </span><span style="color: #90ee90; font-style: italic;">*/</span>
        {
        <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">&#35760;&#24405;&#26032;&#20998;&#37197;&#31354;&#38388;&#30340;&#39318;&#22320;&#22336;&#21040;pvReturn </span><span style="color: #90ee90; font-style: italic;">*/</span>
            pvReturn = pucAlignedHeap + xNextFreeByte;
            xNextFreeByte += xWantedSize;
        }
    <span style="color: #90ee90; font-style: italic;">/** </span><span style="color: #90ee90; font-style: italic;">&#29992;&#20110;&#36755;&#20986;&#20869;&#23384;&#20998;&#37197;&#30340;&#35843;&#35797;&#20449;&#24687;&#65292;&#36825;&#20010;&#23439;&#23450;&#20041;&#22312;FreeRTOS.h&#20013;&#65292;&#40664;&#35748;&#20026;&#31354;&#65292;</span>
<span style="color: #90ee90; font-style: italic;">     * &#22914;&#26524;&#38656;&#35201;&#23558;&#36825;&#20123;&#35843;&#35797;&#20449;&#24687;&#36755;&#20986;&#21040;&#20018;&#21475;&#25110;&#20854;&#23427;&#19996;&#35199;&#65292;&#23601;&#21487;&#20197;&#20462;&#25913;&#36825;&#20010;&#23439;&#23558;&#20449;&#24687;&#36755;&#20986;&#21040;&#25152;&#38656;&#35201;&#30340;&#22320;&#26041;&#12290; </span>
<span style="color: #90ee90; font-style: italic;">     </span><span style="color: #90ee90; font-style: italic;">*/</span>
        traceMALLOC( pvReturn, xWantedSize ); 
    }
    ( <span style="color: #ffff00; font-size: 105%;">void</span> ) xTaskResumeAll();

    <span style="color: #90ee90; font-style: italic;">/** </span><span style="color: #90ee90; font-style: italic;">&#24403;&#20869;&#23384;&#20998;&#37197;&#22833;&#36133;&#30340;&#26102;&#20505;&#65292;&#22914;&#26524;&#22312;FreeRTOS.h&#20013;&#26377;&#23450;&#20041;&#23439;configUSE_MALLOC_FAILED_HOOK=1&#65292;</span>
<span style="color: #90ee90; font-style: italic;">     * &#21017;&#20250;&#35843;&#29992;&#19968;&#20010;&#21246;&#23376;&#20989;&#25968;vApplicationMallocFailedHook()&#12290;&#22312;&#36825;&#20010;&#21246;&#23376;&#20989;&#25968;&#20013;&#65292;</span>
<span style="color: #90ee90; font-style: italic;">     * &#29992;&#25143;&#21487;&#20197;&#36827;&#34892;&#20854;&#23427;&#19968;&#20123;&#24517;&#35201;&#30340;&#25805;&#20316; </span>
<span style="color: #90ee90; font-style: italic;">     </span><span style="color: #90ee90; font-style: italic;">*/</span>
<span style="color: #87cefa; text-decoration: underline;">    #if</span>( configUSE_MALLOC_FAILED_HOOK == 1 )
    {
        <span style="color: #ffb6c1; font-size: 105%;">if</span>( pvReturn == <span style="color: #7fffd4;">NULL</span> )
        {
            <span style="color: #ffb6c1; font-size: 105%;">extern</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">vApplicationMallocFailedHook</span>( <span style="color: #ffff00; font-size: 105%;">void</span> );
            vApplicationMallocFailedHook(); 
        }
    }
<span style="color: #87cefa; text-decoration: underline;">    #endif</span>
    <span style="color: #ffb6c1; font-size: 105%;">return</span> pvReturn;
    }
</pre>
</div></li>
<li>heap\<sub>2.c</sub>: 同heap\<sub>1.c差不多</sub>，只是采用一定算法来分配空间，增加了堆释放操作, ；</li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">vPortFree</span>( <span style="color: #ffff00; font-size: 105%;">void</span> *<span style="color: #ffd700;">pv</span> )
{
    <span style="color: #ffff00; font-size: 105%;">uint8_t</span> *<span style="color: #ffd700;">puc</span> = ( <span style="color: #ffff00; font-size: 105%;">uint8_t</span> * ) pv;
    <span style="color: #ffff00; font-size: 105%;">BlockLink_t</span> *<span style="color: #ffd700;">pxLink</span>;
    <span style="color: #ffb6c1; font-size: 105%;">if</span>( pv != <span style="color: #7fffd4;">NULL</span> )
    {
    <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">&#23547;&#25214;&#36825;&#20010;&#20869;&#23384;&#31354;&#38388;&#30340;&#31354;&#38386;&#22359;&#22836; </span><span style="color: #90ee90; font-style: italic;">*/</span>
        <span style="color: #ffff00; font-size: 105%;">before</span> <span style="color: #ffd700;">it</span>. */
        puc -= heapSTRUCT_SIZE;
        byte <span style="color: #ffff00; font-size: 105%;">alignment</span> <span style="color: #ffd700;">warnings</span>. */
        pxLink = ( <span style="color: #ffff00; font-size: 105%;">void</span> * ) puc;

        vTaskSuspendAll();
        {
        <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">&#25554;&#20837;&#31354;&#38386;&#22359;&#38142;&#34920;&#20013; </span><span style="color: #90ee90; font-style: italic;">*/</span>
            prvInsertBlockIntoFreeList( ( ( <span style="color: #ffff00; font-size: 105%;">BlockLink_t</span> * ) pxLink ) );
        <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">&#20462;&#27491;&#21097;&#20313;&#31354;&#38388;&#22823;&#23567; </span><span style="color: #90ee90; font-style: italic;">*/</span>
            xFreeBytesRemaining += pxLink-&gt;xBlockSize;
            traceFREE( pv, pxLink-&gt;xBlockSize );
        }
        ( <span style="color: #ffff00; font-size: 105%;">void</span> ) xTaskResumeAll();
    }
}
</pre>
</div>
<ul class="org-ul">
<li>heap\<sub>3.c</sub>: 对C标准库的堆操作函数做了线程安全的封装;</li>
</ul>
<p>
分配函数：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ffff00; font-size: 105%;">void</span> *<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">pvPortMalloc</span>( <span style="color: #ffff00; font-size: 105%;">size_t</span> <span style="color: #ffd700;">xWantedSize</span> )
{
    <span style="color: #ffff00; font-size: 105%;">void</span> *<span style="color: #ffd700;">pvReturn</span>;
    vTaskSuspendAll();
    {
        pvReturn = malloc( xWantedSize );
        traceMALLOC( pvReturn, xWantedSize );
    }
    ( <span style="color: #ffff00; font-size: 105%;">void</span> ) xTaskResumeAll();

<span style="color: #87cefa; text-decoration: underline;">    #if</span>( configUSE_MALLOC_FAILED_HOOK == 1 )
    {
        <span style="color: #ffb6c1; font-size: 105%;">if</span>( pvReturn == <span style="color: #7fffd4;">NULL</span> )
        {
            <span style="color: #ffb6c1; font-size: 105%;">extern</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">vApplicationMallocFailedHook</span>( <span style="color: #ffff00; font-size: 105%;">void</span> );
            vApplicationMallocFailedHook();
        }
    }
<span style="color: #87cefa; text-decoration: underline;">    #endif</span>
    <span style="color: #ffb6c1; font-size: 105%;">return</span> pvReturn;
}
</pre>
</div>
<p>
释放函数：
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">vPortFree</span>( <span style="color: #ffff00; font-size: 105%;">void</span> *<span style="color: #ffd700;">pv</span> )
{
    <span style="color: #ffb6c1; font-size: 105%;">if</span>( pv )
    {
        vTaskSuspendAll();
        {
            free( pv );
            traceFREE( pv, 0 );
        }
        ( <span style="color: #ffff00; font-size: 105%;">void</span> ) xTaskResumeAll();
    }
}
</pre>
</div>
<ul class="org-ul">
<li>heap\<sub>4.c</sub>: 同heap\<sub>2.c差不多</sub>，只是分配算法做了更优化，并且相邻空闲空间可以合并；</li>
</ul>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #ffff00; font-size: 105%;">void</span> *<span style="color: #1e90ff; font-size: 105%; font-weight: bold;">pvPortMalloc</span>( <span style="color: #ffff00; font-size: 105%;">size_t</span> <span style="color: #ffd700;">xWantedSize</span> )
{
    <span style="color: #ffff00; font-size: 105%;">BlockLink_t</span> *<span style="color: #ffd700;">pxBlock</span>, *<span style="color: #ffd700;">pxPreviousBlock</span>, *<span style="color: #ffd700;">pxNewBlockLink</span>;
    <span style="color: #ffff00; font-size: 105%;">void</span> *<span style="color: #ffd700;">pvReturn</span> = <span style="color: #7fffd4;">NULL</span>;

    vTaskSuspendAll();
    {
        <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">If this is the first call to malloc then the heap will require</span>
<span style="color: #90ee90; font-style: italic;">        initialisation to setup the list of free blocks. </span><span style="color: #90ee90; font-style: italic;">*/</span>
        <span style="color: #ffb6c1; font-size: 105%;">if</span>( pxEnd == <span style="color: #7fffd4;">NULL</span> )
        {
            prvHeapInit();
        }
        <span style="color: #ffb6c1; font-size: 105%;">else</span>
        {
            mtCOVERAGE_TEST_MARKER();
        }

    <span style="color: #ffa07a;">/**</span>
<span style="color: #ffa07a;">     * &#21028;&#26029;&#29992;&#25143;&#30003;&#35831;&#20869;&#23384;&#22823;&#23567;&#30340;&#26368;&#39640;&#20301;&#26159;&#21542;&#20026;0&#65292;&#20026;0&#21363;&#21512;&#27861;</span>
<span style="color: #ffa07a;">     * &#65288;&#20043;&#21069;&#35828;&#36807;&#65292;&#26368;&#39640;&#20301;&#29992;&#26469;&#26631;&#35782;&#31354;&#38386;&#22359;&#30340;&#31354;&#38386;&#29366;&#24577;&#65292;&#22240;&#27492;&#26368;&#39640;&#20301;&#20026;1&#21017;&#35828;&#26126;&#29992;&#25143;&#30003;&#35831;&#30340;&#20869;&#23384;&#22823;&#23567;&#24050;&#36229;&#20986;&#31354;&#38386;&#22359;&#30340;&#26368;&#22823;&#22823;&#23567;&#65289;</span>
<span style="color: #ffa07a;">     */</span>
        <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">Check the requested block size is not so large that the top bit is</span>
<span style="color: #90ee90; font-style: italic;">        set.  The top bit of the block size member of the BlockLink_t structure</span>
<span style="color: #90ee90; font-style: italic;">        is used to determine who owns the block - the application or the</span>
<span style="color: #90ee90; font-style: italic;">        kernel, so it must be free. </span><span style="color: #90ee90; font-style: italic;">*/</span>
        <span style="color: #ffb6c1; font-size: 105%;">if</span>( ( xWantedSize &amp; xBlockAllocatedBit ) == 0 )
        {
            <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">The wanted size is increased so it can contain a BlockLink_t</span>
<span style="color: #90ee90; font-style: italic;">            structure in addition to the requested amount of bytes. </span><span style="color: #90ee90; font-style: italic;">*/</span>
            <span style="color: #ffb6c1; font-size: 105%;">if</span>( xWantedSize &gt; 0 )
            {
                xWantedSize += xHeapStructSize; <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">&#22686;&#21152;block&#22836;&#22823;&#23567; </span><span style="color: #90ee90; font-style: italic;">*/</span>

                <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">Ensure that blocks are always aligned to the required number</span>
<span style="color: #90ee90; font-style: italic;">                of bytes. </span><span style="color: #90ee90; font-style: italic;">*/</span>
                <span style="color: #ffb6c1; font-size: 105%;">if</span>( ( xWantedSize &amp; portBYTE_ALIGNMENT_MASK ) != 0x00 ) <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">&#23545;&#40784;&#25805;&#20316; </span><span style="color: #90ee90; font-style: italic;">*/</span>
                {
                    <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">Byte alignment required. </span><span style="color: #90ee90; font-style: italic;">*/</span>
                    xWantedSize += ( portBYTE_ALIGNMENT - ( xWantedSize &amp; portBYTE_ALIGNMENT_MASK ) );
                    configASSERT( ( xWantedSize &amp; portBYTE_ALIGNMENT_MASK ) == 0 );
                }
                <span style="color: #ffb6c1; font-size: 105%;">else</span>
                {
                    mtCOVERAGE_TEST_MARKER();
                }
            }
            <span style="color: #ffb6c1; font-size: 105%;">else</span>
            {
                mtCOVERAGE_TEST_MARKER();
            }

            <span style="color: #ffb6c1; font-size: 105%;">if</span>( ( xWantedSize &gt; 0 ) &amp;&amp; ( xWantedSize &lt;= xFreeBytesRemaining ) )
            {
        <span style="color: #ffa07a;">/**</span>
<span style="color: #ffa07a;">         * &#39318;&#20808;&#36941;&#21382;&#38142;&#34920;&#65292;&#25214;&#21040;&#31532;1&#22359;&#33021;&#27604;&#30003;&#35831;&#31354;&#38388;&#22823;&#23567;&#22823;&#30340;&#31354;&#38386;&#22359;&#65292;&#20462;&#25913;&#31354;&#38386;&#22359;&#30340;&#20449;&#24687;&#65292;</span>
<span style="color: #ffa07a;">         * &#35760;&#24405;&#29992;&#25143;&#21487;&#29992;&#30340;&#20869;&#23384;&#39318;&#22320;&#22336;&#12290;&#25509;&#19979;&#26469;&#65292;&#22914;&#26524;&#20998;&#37197;&#20986;&#21435;&#30340;&#31354;&#38386;&#22359;&#27604;&#30003;&#35831;&#30340;&#31354;&#38388;&#22823;&#24456;&#22810;&#65292;</span>
<span style="color: #ffa07a;">         * &#21017;&#23558;&#35813;&#31354;&#38386;&#22359;&#36827;&#34892;&#20998;&#21106;&#65292;&#25226;&#21097;&#20313;&#30340;&#37096;&#20998;&#37325;&#26032;&#28155;&#21152;&#21040;&#38142;&#34920;&#20013;&#12290;</span>
<span style="color: #ffa07a;">         */</span>
                <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">Traverse the list from the start (lowest address) block until</span>
<span style="color: #90ee90; font-style: italic;">                one of adequate size is found. </span><span style="color: #90ee90; font-style: italic;">*/</span>
                pxPreviousBlock = &amp;xStart;
                pxBlock = xStart.pxNextFreeBlock;
                <span style="color: #ffb6c1; font-size: 105%;">while</span>( ( pxBlock-&gt;xBlockSize &lt; xWantedSize ) &amp;&amp; ( pxBlock-&gt;pxNextFreeBlock != <span style="color: #7fffd4;">NULL</span> ) )
                {
                    pxPreviousBlock = pxBlock;
                    pxBlock = pxBlock-&gt;pxNextFreeBlock;
                }

                <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">If the end marker was reached then a block of adequate size</span>
<span style="color: #90ee90; font-style: italic;">                was not found. </span><span style="color: #90ee90; font-style: italic;">*/</span>
                <span style="color: #ffb6c1; font-size: 105%;">if</span>( pxBlock != pxEnd )
                {
                    <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">Return the memory space pointed to - jumping over the</span>
<span style="color: #90ee90; font-style: italic;">                    BlockLink_t structure at its start. </span><span style="color: #90ee90; font-style: italic;">*/</span>
                    pvReturn = ( <span style="color: #ffff00; font-size: 105%;">void</span> * ) ( ( ( <span style="color: #ffff00; font-size: 105%;">uint8_t</span> * ) pxPreviousBlock-&gt;pxNextFreeBlock ) + xHeapStructSize ); <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">&#33719;&#24471;&#30495;&#27491;&#30003;&#35831;&#30340;&#31354;&#38388;&#22320;&#22336; </span><span style="color: #90ee90; font-style: italic;">*/</span>

                    <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">This block is being returned for use so must be taken out</span>
<span style="color: #90ee90; font-style: italic;">                    of the list of free blocks. </span><span style="color: #90ee90; font-style: italic;">*/</span>
                    pxPreviousBlock-&gt;pxNextFreeBlock = pxBlock-&gt;pxNextFreeBlock; <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">&#31354;&#38386;block&#38142;&#25509;&#36215;&#26469; </span><span style="color: #90ee90; font-style: italic;">*/</span>

                    <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">If the block is larger than required it can be split into</span>
<span style="color: #90ee90; font-style: italic;">                    two. </span><span style="color: #90ee90; font-style: italic;">*/</span>
                    <span style="color: #ffb6c1; font-size: 105%;">if</span>( ( pxBlock-&gt;xBlockSize - xWantedSize ) &gt; heapMINIMUM_BLOCK_SIZE ) <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">&#35265;heap_2.c </span><span style="color: #90ee90; font-style: italic;">*/</span>
                    {
                        <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">This block is to be split into two.  Create a new</span>
<span style="color: #90ee90; font-style: italic;">                        block following the number of bytes requested. The void</span>
<span style="color: #90ee90; font-style: italic;">                        cast is used to prevent byte alignment warnings from the</span>
<span style="color: #90ee90; font-style: italic;">                        compiler. </span><span style="color: #90ee90; font-style: italic;">*/</span>
                        pxNewBlockLink = ( <span style="color: #ffff00; font-size: 105%;">void</span> * ) ( ( ( <span style="color: #ffff00; font-size: 105%;">uint8_t</span> * ) pxBlock ) + xWantedSize );
                        configASSERT( ( ( ( <span style="color: #ffff00; font-size: 105%;">size_t</span> ) pxNewBlockLink ) &amp; portBYTE_ALIGNMENT_MASK ) == 0 );

                        <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">Calculate the sizes of two blocks split from the</span>
<span style="color: #90ee90; font-style: italic;">                        single block. </span><span style="color: #90ee90; font-style: italic;">*/</span>
                        pxNewBlockLink-&gt;xBlockSize = pxBlock-&gt;xBlockSize - xWantedSize;
                        pxBlock-&gt;xBlockSize = xWantedSize;

                        <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">Insert the new block into the list of free blocks. </span><span style="color: #90ee90; font-style: italic;">*/</span>
                        prvInsertBlockIntoFreeList( pxNewBlockLink );
                    }
                    <span style="color: #ffb6c1; font-size: 105%;">else</span>
                    {
                        mtCOVERAGE_TEST_MARKER();
                    }

                    xFreeBytesRemaining -= pxBlock-&gt;xBlockSize;

                    <span style="color: #ffb6c1; font-size: 105%;">if</span>( xFreeBytesRemaining &lt; xMinimumEverFreeBytesRemaining )
                    {
                        xMinimumEverFreeBytesRemaining = xFreeBytesRemaining;
                    }
                    <span style="color: #ffb6c1; font-size: 105%;">else</span>
                    {
                        mtCOVERAGE_TEST_MARKER();
                    }

                    <span style="color: #90ee90; font-style: italic;">/* </span><span style="color: #90ee90; font-style: italic;">The block is being returned - it is allocated and owned</span>
<span style="color: #90ee90; font-style: italic;">                    by the application and has no "next" block. </span><span style="color: #90ee90; font-style: italic;">*/</span>
                    pxBlock-&gt;xBlockSize |= xBlockAllocatedBit;
                    pxBlock-&gt;pxNextFreeBlock = <span style="color: #7fffd4;">NULL</span>;
                }
                <span style="color: #ffb6c1; font-size: 105%;">else</span>
                {
                    mtCOVERAGE_TEST_MARKER();
                }
            }
            <span style="color: #ffb6c1; font-size: 105%;">else</span>
            {
                mtCOVERAGE_TEST_MARKER();
            }
        }
        <span style="color: #ffb6c1; font-size: 105%;">else</span>
        {
            mtCOVERAGE_TEST_MARKER();
        }

        traceMALLOC( pvReturn, xWantedSize );
    }
    ( <span style="color: #ffff00; font-size: 105%;">void</span> ) xTaskResumeAll();

<span style="color: #87cefa; text-decoration: underline;">    #if</span>( configUSE_MALLOC_FAILED_HOOK == 1 )
    {
        <span style="color: #ffb6c1; font-size: 105%;">if</span>( pvReturn == <span style="color: #7fffd4;">NULL</span> )
        {
            <span style="color: #ffb6c1; font-size: 105%;">extern</span> <span style="color: #ffff00; font-size: 105%;">void</span> <span style="color: #1e90ff; font-size: 105%; font-weight: bold;">vApplicationMallocFailedHook</span>( <span style="color: #ffff00; font-size: 105%;">void</span> );
            vApplicationMallocFailedHook();
        }
        <span style="color: #ffb6c1; font-size: 105%;">else</span>
        {
            mtCOVERAGE_TEST_MARKER();
        }
    }
<span style="color: #87cefa; text-decoration: underline;">    #endif</span>

    configASSERT( ( ( ( <span style="color: #ffff00; font-size: 105%;">uint32_t</span> ) pvReturn ) &amp; portBYTE_ALIGNMENT_MASK ) == 0 );
    <span style="color: #ffb6c1; font-size: 105%;">return</span> pvReturn;
}
</pre>
</div>
</div>
</li>
<li><a id="org563fa69"></a>杂项功能<br />
<div class="outline-text-6" id="text-4-1-2-2-4">
<p>
这些杂项功能大部分都跟平台有关，这里以cortex M系列为例；
</p>
<ul class="org-ul">
<li>参数断言：使用宏configASSERT, 是空的，需要用户自己写</li>
<li>提升优先级：static BaseType\<sub>t</sub> prvRaisePrivilege( void )，通过控制cpu做
svc调用，svc有相应的号；</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: 比克曼</p>
<p class="email">Email: <a href="mailto:bitman@163.com">bitman@163.com</a></p>
<p class="date">Created: 2020-06-05 周五 00:05</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
